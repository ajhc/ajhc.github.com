<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>src/E/Main.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>-- this file contains the main driver for the core-&gt;core optimizations</span>
<a name="line-2"></a>
<a name="line-3"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>E</span><span class='hs-varop'>.</span><span class='hs-conid'>Main</span><span class='hs-layout'>(</span><span class='hs-varid'>processInitialHo</span><span class='hs-layout'>,</span><span class='hs-varid'>processDecls</span><span class='hs-layout'>,</span><span class='hs-varid'>compileWholeProgram</span><span class='hs-layout'>,</span><span class='hs-varid'>dumpRules</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-4"></a>
<a name="line-5"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Exception</span>
<a name="line-6"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span><span class='hs-varop'>.</span><span class='hs-conid'>Identity</span>
<a name="line-7"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span><span class='hs-varop'>.</span><span class='hs-conid'>Reader</span>
<a name="line-8"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span><span class='hs-varop'>.</span><span class='hs-conid'>State</span>
<a name="line-9"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span><span class='hs-varop'>.</span><span class='hs-conid'>Writer</span>
<a name="line-10"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>System</span><span class='hs-varop'>.</span><span class='hs-conid'>Mem</span>
<a name="line-11"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Map</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>Map</span>
<a name="line-12"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Set</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>Set</span>
<a name="line-13"></a>
<a name="line-14"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>List</span>
<a name="line-15"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DataConstructors</span>
<a name="line-16"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Doc</span><span class='hs-varop'>.</span><span class='hs-conid'>PPrint</span>
<a name="line-17"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>E</span><span class='hs-varop'>.</span><span class='hs-conid'>Annotate</span><span class='hs-layout'>(</span><span class='hs-varid'>annotateDs</span><span class='hs-layout'>,</span><span class='hs-varid'>annotateCombs</span><span class='hs-layout'>,</span><span class='hs-varid'>annotateProgram</span><span class='hs-layout'>)</span>
<a name="line-18"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>E</span><span class='hs-varop'>.</span><span class='hs-conid'>E</span>
<a name="line-19"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>E</span><span class='hs-varop'>.</span><span class='hs-conid'>Eta</span>
<a name="line-20"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>E</span><span class='hs-varop'>.</span><span class='hs-conid'>FromHs</span>
<a name="line-21"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>E</span><span class='hs-varop'>.</span><span class='hs-conid'>Inline</span>
<a name="line-22"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>E</span><span class='hs-varop'>.</span><span class='hs-conid'>LambdaLift</span>
<a name="line-23"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>E</span><span class='hs-varop'>.</span><span class='hs-conid'>LetFloat</span>
<a name="line-24"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>E</span><span class='hs-varop'>.</span><span class='hs-conid'>Lint</span>
<a name="line-25"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>E</span><span class='hs-varop'>.</span><span class='hs-conid'>Program</span>
<a name="line-26"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>E</span><span class='hs-varop'>.</span><span class='hs-conid'>Rules</span>
<a name="line-27"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>E</span><span class='hs-varop'>.</span><span class='hs-conid'>Traverse</span>
<a name="line-28"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>E</span><span class='hs-varop'>.</span><span class='hs-conid'>TypeAnalysis</span>
<a name="line-29"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>E</span><span class='hs-varop'>.</span><span class='hs-conid'>TypeCheck</span>
<a name="line-30"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>E</span><span class='hs-varop'>.</span><span class='hs-conid'>Values</span>
<a name="line-31"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>E</span><span class='hs-varop'>.</span><span class='hs-conid'>WorkerWrapper</span>
<a name="line-32"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FrontEnd</span><span class='hs-varop'>.</span><span class='hs-conid'>Class</span><span class='hs-layout'>(</span><span class='hs-varid'>augmentClassHierarchy</span><span class='hs-layout'>)</span>
<a name="line-33"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FrontEnd</span><span class='hs-varop'>.</span><span class='hs-conid'>HsSyn</span>
<a name="line-34"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FrontEnd</span><span class='hs-varop'>.</span><span class='hs-conid'>KindInfer</span>
<a name="line-35"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FrontEnd</span><span class='hs-varop'>.</span><span class='hs-conid'>Tc</span><span class='hs-varop'>.</span><span class='hs-conid'>Module</span>
<a name="line-36"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FrontEnd</span><span class='hs-varop'>.</span><span class='hs-conid'>Warning</span>
<a name="line-37"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Grin</span><span class='hs-varop'>.</span><span class='hs-conid'>Show</span><span class='hs-layout'>(</span><span class='hs-varid'>render</span><span class='hs-layout'>)</span>
<a name="line-38"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Ho</span><span class='hs-varop'>.</span><span class='hs-conid'>Build</span>
<a name="line-39"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Ho</span><span class='hs-varop'>.</span><span class='hs-conid'>Collected</span>
<a name="line-40"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Info</span><span class='hs-varop'>.</span><span class='hs-conid'>Types</span>
<a name="line-41"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Name</span><span class='hs-varop'>.</span><span class='hs-conid'>Id</span>
<a name="line-42"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Name</span><span class='hs-varop'>.</span><span class='hs-conid'>Name</span>
<a name="line-43"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Options</span>
<a name="line-44"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Support</span><span class='hs-varop'>.</span><span class='hs-conid'>CanType</span><span class='hs-layout'>(</span><span class='hs-varid'>getType</span><span class='hs-layout'>)</span>
<a name="line-45"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Support</span><span class='hs-varop'>.</span><span class='hs-conid'>FreeVars</span>
<a name="line-46"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Support</span><span class='hs-varop'>.</span><span class='hs-conid'>TempDir</span>
<a name="line-47"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Support</span><span class='hs-varop'>.</span><span class='hs-conid'>Transform</span>
<a name="line-48"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span><span class='hs-varop'>.</span><span class='hs-conid'>Gen</span>
<a name="line-49"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span><span class='hs-varop'>.</span><span class='hs-conid'>Graph</span>
<a name="line-50"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span><span class='hs-varop'>.</span><span class='hs-conid'>Progress</span>
<a name="line-51"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span><span class='hs-varop'>.</span><span class='hs-conid'>SetLike</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>S</span>
<a name="line-52"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>E</span><span class='hs-varop'>.</span><span class='hs-conid'>CPR</span>
<a name="line-53"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>E</span><span class='hs-varop'>.</span><span class='hs-conid'>Demand</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>Demand</span><span class='hs-layout'>(</span><span class='hs-varid'>analyzeProgram</span><span class='hs-layout'>)</span>
<a name="line-54"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>E</span><span class='hs-varop'>.</span><span class='hs-conid'>SSimplify</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>SS</span>
<a name="line-55"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>FlagDump</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>FD</span>
<a name="line-56"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>FlagOpts</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>FO</span>
<a name="line-57"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Info</span><span class='hs-varop'>.</span><span class='hs-conid'>Info</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>Info</span>
<a name="line-58"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Stats</span>
<a name="line-59"></a>
<a name="line-60"></a><a name="lamann"></a><span class='hs-definition'>lamann</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>nfo</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>nfo</span>
<a name="line-61"></a><a name="letann"></a><span class='hs-definition'>letann</span> <span class='hs-varid'>e</span> <span class='hs-varid'>nfo</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>annotateArity</span> <span class='hs-varid'>e</span> <span class='hs-varid'>nfo</span><span class='hs-layout'>)</span>
<a name="line-62"></a><a name="idann"></a><span class='hs-definition'>idann</span> <span class='hs-varid'>ps</span> <span class='hs-varid'>i</span> <span class='hs-varid'>nfo</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>props</span> <span class='hs-varid'>ps</span> <span class='hs-varid'>i</span> <span class='hs-varid'>nfo</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-63"></a>    <span class='hs-varid'>props</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IdMap</span> <span class='hs-conid'>Properties</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Info</span><span class='hs-varop'>.</span><span class='hs-conid'>Info</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Info</span><span class='hs-varop'>.</span><span class='hs-conid'>Info</span>
<a name="line-64"></a>    <span class='hs-varid'>props</span> <span class='hs-varid'>ps</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mlookup</span> <span class='hs-varid'>i</span> <span class='hs-varid'>ps</span> <span class='hs-keyword'>of</span>
<a name="line-65"></a>        <span class='hs-conid'>Just</span> <span class='hs-varid'>ps</span> <span class='hs-keyglyph'>-&gt;</span>  <span class='hs-varid'>modifyProperties</span> <span class='hs-layout'>(</span><span class='hs-varid'>mappend</span> <span class='hs-varid'>ps</span><span class='hs-layout'>)</span>
<a name="line-66"></a>        <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span>  <span class='hs-varid'>id</span>
<a name="line-67"></a>
<a name="line-68"></a><a name="processInitialHo"></a><span class='hs-definition'>processInitialHo</span> <span class='hs-keyglyph'>::</span>
<a name="line-69"></a>    <span class='hs-conid'>CollectedHo</span>       <span class='hs-comment'>-- ^ current accumulated ho</span>
<a name="line-70"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Ho</span>             <span class='hs-comment'>-- ^ new ho, freshly read from file</span>
<a name="line-71"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>CollectedHo</span> <span class='hs-comment'>-- ^ final combined ho data.</span>
<a name="line-72"></a><span class='hs-definition'>processInitialHo</span> <span class='hs-varid'>accumho</span> <span class='hs-varid'>aho</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withStackStatus</span> <span class='hs-str'>"processInitialHo"</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-73"></a>    <span class='hs-keyword'>let</span> <span class='hs-conid'>Rules</span> <span class='hs-varid'>rm</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hoRules</span> <span class='hs-varop'>$</span> <span class='hs-varid'>hoBuild</span> <span class='hs-varid'>aho</span>
<a name="line-74"></a>        <span class='hs-varid'>newTVrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fsts</span> <span class='hs-varop'>$</span> <span class='hs-varid'>hoEs</span> <span class='hs-layout'>(</span><span class='hs-varid'>hoBuild</span> <span class='hs-varid'>aho</span><span class='hs-layout'>)</span>
<a name="line-75"></a>        <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-varid'>orphans</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>spartition</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span> <span class='hs-layout'>(</span><span class='hs-varid'>k</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>k</span> <span class='hs-varop'>`elem`</span> <span class='hs-varid'>map</span> <span class='hs-varid'>tvrIdent</span> <span class='hs-varid'>newTVrs</span><span class='hs-layout'>)</span> <span class='hs-varid'>rm</span>
<a name="line-76"></a>
<a name="line-77"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>fakeEntry</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyComb</span> <span class='hs-layout'>{</span> <span class='hs-varid'>combRules</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>ruleUpdate</span> <span class='hs-varop'>.</span> <span class='hs-varid'>concat</span> <span class='hs-varop'>$</span> <span class='hs-varid'>values</span> <span class='hs-varid'>orphans</span> <span class='hs-layout'>}</span>
<a name="line-78"></a>        <span class='hs-varid'>combs</span> <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>fakeEntry</span><span class='hs-conop'>:</span><span class='hs-keyglyph'>[</span><span class='hs-varid'>combRules_s</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ruleUpdate</span> <span class='hs-varop'>$</span> <span class='hs-varid'>findWithDefault</span> <span class='hs-conid'>[]</span> <span class='hs-layout'>(</span><span class='hs-varid'>tvrIdent</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span> <span class='hs-varid'>rm</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>bindComb</span> <span class='hs-layout'>(</span><span class='hs-varid'>t</span><span class='hs-layout'>,</span><span class='hs-varid'>e</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>t</span><span class='hs-layout'>,</span><span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>hoEs</span> <span class='hs-layout'>(</span><span class='hs-varid'>hoBuild</span> <span class='hs-varid'>aho</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-79"></a>
<a name="line-80"></a>    <span class='hs-comment'>-- extract new combinators and processed rules</span>
<a name="line-81"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>choCombinators'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fromList</span> <span class='hs-keyglyph'>[</span> <span class='hs-layout'>(</span><span class='hs-varid'>combIdent</span> <span class='hs-varid'>c</span><span class='hs-layout'>,</span><span class='hs-varid'>c</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>c</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>runIdentity</span> <span class='hs-varop'>$</span> <span class='hs-varid'>annotateCombs</span> <span class='hs-layout'>(</span><span class='hs-varid'>choVarMap</span> <span class='hs-varid'>accumho</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span><span class='hs-layout'>)</span> <span class='hs-varid'>letann</span> <span class='hs-varid'>lamann</span> <span class='hs-varid'>combs</span><span class='hs-keyglyph'>]</span>
<a name="line-82"></a>        <span class='hs-varid'>nrules</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>ruleUpdate</span> <span class='hs-varop'>.</span> <span class='hs-varid'>combRules</span> <span class='hs-varop'>$</span> <span class='hs-varid'>findWithDefault</span> <span class='hs-varid'>emptyComb</span> <span class='hs-varid'>emptyId</span> <span class='hs-varid'>choCombinators'</span>
<a name="line-83"></a>        <span class='hs-varid'>reRule</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Comb</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Comb</span>
<a name="line-84"></a>        <span class='hs-varid'>reRule</span> <span class='hs-varid'>comb</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>combRules_u</span> <span class='hs-varid'>f</span> <span class='hs-varid'>comb</span> <span class='hs-keyword'>where</span>
<a name="line-85"></a>            <span class='hs-varid'>f</span> <span class='hs-varid'>rs</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>List</span><span class='hs-varop'>.</span><span class='hs-varid'>union</span>  <span class='hs-varid'>rs</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>nrules</span><span class='hs-layout'>,</span> <span class='hs-varid'>ruleHead</span> <span class='hs-varid'>x</span> <span class='hs-varop'>==</span> <span class='hs-varid'>combHead</span> <span class='hs-varid'>comb</span><span class='hs-keyglyph'>]</span>
<a name="line-86"></a>
<a name="line-87"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>choCombs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sfilter</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-varid'>k</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>k</span> <span class='hs-varop'>/=</span> <span class='hs-varid'>emptyId</span><span class='hs-layout'>)</span> <span class='hs-varid'>choCombinators'</span>
<a name="line-88"></a>    <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>updateChoHo</span> <span class='hs-varid'>mempty</span> <span class='hs-layout'>{</span>
<a name="line-89"></a>        <span class='hs-varid'>choExternalNames</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>choExternalNames</span> <span class='hs-varid'>accumho</span> <span class='hs-varop'>`mappend`</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromList</span> <span class='hs-varop'>.</span> <span class='hs-varid'>map</span> <span class='hs-varid'>tvrIdent</span> <span class='hs-varop'>$</span> <span class='hs-varid'>newTVrs</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-90"></a>        <span class='hs-varid'>choCombinators</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>choCombs</span> <span class='hs-varop'>`mappend`</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>reRule</span> <span class='hs-layout'>(</span><span class='hs-varid'>choCombinators</span> <span class='hs-varid'>accumho</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-91"></a>        <span class='hs-varid'>choHoMap</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>singleton</span> <span class='hs-layout'>(</span><span class='hs-varid'>hoModuleGroup</span> <span class='hs-varid'>aho</span><span class='hs-layout'>)</span> <span class='hs-varid'>aho</span> <span class='hs-varop'>`mappend`</span> <span class='hs-varid'>choHoMap</span> <span class='hs-varid'>accumho</span>
<a name="line-92"></a>        <span class='hs-layout'>}</span>
<a name="line-93"></a>
<a name="line-94"></a><a name="processDecls"></a><span class='hs-definition'>processDecls</span> <span class='hs-keyglyph'>::</span>
<a name="line-95"></a>    <span class='hs-conid'>CollectedHo</span>             <span class='hs-comment'>-- ^ Collected ho</span>
<a name="line-96"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Ho</span>                   <span class='hs-comment'>-- ^ preliminary haskell object  data</span>
<a name="line-97"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TiData</span>               <span class='hs-comment'>-- ^ front end output</span>
<a name="line-98"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>CollectedHo</span><span class='hs-layout'>,</span><span class='hs-conid'>Ho</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- ^ (new accumulated ho, final ho for this modules)</span>
<a name="line-99"></a><span class='hs-definition'>processDecls</span> <span class='hs-varid'>cho</span> <span class='hs-varid'>ho'</span> <span class='hs-varid'>tiData</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withStackStatus</span> <span class='hs-str'>"processDecls"</span> <span class='hs-varop'>$</span>  <span class='hs-keyword'>do</span>
<a name="line-100"></a>    <span class='hs-comment'>-- some useful values</span>
<a name="line-101"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>ho</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>choHo</span> <span class='hs-varid'>cho</span>
<a name="line-102"></a>        <span class='hs-comment'>-- XXX typechecker drops foreign exports!</span>
<a name="line-103"></a>        <span class='hs-varid'>decls</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tiDataDecls</span> <span class='hs-varid'>tiData</span> <span class='hs-varop'>++</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>x</span><span class='hs-keyglyph'>@</span><span class='hs-conid'>HsForeignExport</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>originalDecls</span> <span class='hs-keyglyph'>]</span>
<a name="line-104"></a>        <span class='hs-varid'>originalDecls</span> <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>concat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>hsModuleDecls</span>  <span class='hs-varid'>m</span> <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tiDataModules</span> <span class='hs-varid'>tiData</span> <span class='hs-keyglyph'>]</span>
<a name="line-105"></a>
<a name="line-106"></a>    <span class='hs-comment'>-- build datatables</span>
<a name="line-107"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>derives</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>collectDeriving</span> <span class='hs-varid'>originalDecls</span><span class='hs-layout'>)</span>
<a name="line-108"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>dataTable</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>toDataTable</span> <span class='hs-layout'>(</span><span class='hs-varid'>getConstructorKinds</span> <span class='hs-layout'>(</span><span class='hs-varid'>hoKinds</span> <span class='hs-varop'>$</span> <span class='hs-varid'>hoTcInfo</span> <span class='hs-varid'>ho'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-109"></a>            <span class='hs-layout'>(</span><span class='hs-varid'>tiAllAssumptions</span> <span class='hs-varid'>tiData</span><span class='hs-layout'>)</span> <span class='hs-varid'>originalDecls</span> <span class='hs-layout'>(</span><span class='hs-varid'>hoDataTable</span> <span class='hs-varop'>$</span> <span class='hs-varid'>hoBuild</span> <span class='hs-varid'>ho</span><span class='hs-layout'>)</span>
<a name="line-110"></a>        <span class='hs-varid'>classInstances</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>deriveClasses</span> <span class='hs-layout'>(</span><span class='hs-varid'>choCombinators</span> <span class='hs-varid'>cho</span><span class='hs-layout'>)</span> <span class='hs-varid'>fullDataTable</span> <span class='hs-varid'>derives</span>
<a name="line-111"></a>        <span class='hs-varid'>fullDataTable</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dataTable</span> <span class='hs-varop'>`mappend`</span> <span class='hs-varid'>hoDataTable</span> <span class='hs-layout'>(</span><span class='hs-varid'>hoBuild</span> <span class='hs-varid'>ho</span><span class='hs-layout'>)</span>
<a name="line-112"></a>    <span class='hs-varid'>wdump</span> <span class='hs-conid'>FD</span><span class='hs-varop'>.</span><span class='hs-conid'>Datatable</span> <span class='hs-varop'>$</span> <span class='hs-varid'>putErrLn</span> <span class='hs-layout'>(</span><span class='hs-varid'>render</span> <span class='hs-varop'>$</span> <span class='hs-varid'>showDataTable</span> <span class='hs-varid'>dataTable</span><span class='hs-layout'>)</span>
<a name="line-113"></a>    <span class='hs-varid'>wdump</span> <span class='hs-conid'>FD</span><span class='hs-varop'>.</span><span class='hs-conid'>Derived</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-114"></a>        <span class='hs-varid'>mapM_</span> <span class='hs-varid'>print</span> <span class='hs-varid'>derives</span>
<a name="line-115"></a>        <span class='hs-varid'>mapM_</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span> <span class='hs-layout'>(</span><span class='hs-varid'>v</span><span class='hs-layout'>,</span><span class='hs-varid'>lc</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>printCheckName''</span> <span class='hs-varid'>fullDataTable</span> <span class='hs-varid'>v</span> <span class='hs-varid'>lc</span><span class='hs-layout'>)</span> <span class='hs-varid'>classInstances</span>
<a name="line-116"></a>    <span class='hs-comment'>-- initial program</span>
<a name="line-117"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>prog</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>program</span> <span class='hs-layout'>{</span>
<a name="line-118"></a>            <span class='hs-varid'>progDataTable</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fullDataTable</span><span class='hs-layout'>,</span>
<a name="line-119"></a>            <span class='hs-varid'>progExternalNames</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>choExternalNames</span> <span class='hs-varid'>cho</span><span class='hs-layout'>,</span>
<a name="line-120"></a>            <span class='hs-varid'>progModule</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>head</span> <span class='hs-layout'>(</span><span class='hs-varid'>fsts</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tiDataModules</span> <span class='hs-varid'>tiData</span><span class='hs-layout'>)</span>
<a name="line-121"></a>            <span class='hs-layout'>}</span>
<a name="line-122"></a>    <span class='hs-comment'>-- Convert Haskell decls to E</span>
<a name="line-123"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>allAssumps</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>tiAllAssumptions</span> <span class='hs-varid'>tiData</span> <span class='hs-varop'>`mappend`</span> <span class='hs-varid'>hoAssumps</span> <span class='hs-layout'>(</span><span class='hs-varid'>hoTcInfo</span> <span class='hs-varid'>ho</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-124"></a>        <span class='hs-varid'>theProps</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fromList</span> <span class='hs-keyglyph'>[</span> <span class='hs-layout'>(</span><span class='hs-varid'>toId</span> <span class='hs-varid'>x</span><span class='hs-layout'>,</span><span class='hs-varid'>y</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>x</span><span class='hs-layout'>,</span><span class='hs-varid'>y</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>toList</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tiProps</span> <span class='hs-varid'>tiData</span><span class='hs-keyglyph'>]</span>
<a name="line-125"></a>    <span class='hs-varid'>ds'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>convertDecls</span> <span class='hs-varid'>tiData</span> <span class='hs-varid'>theProps</span>
<a name="line-126"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>hoClassHierarchy</span> <span class='hs-varop'>$</span> <span class='hs-varid'>hoTcInfo</span> <span class='hs-varid'>ho'</span><span class='hs-layout'>)</span> <span class='hs-varid'>allAssumps</span>  <span class='hs-varid'>fullDataTable</span> <span class='hs-varid'>decls</span>
<a name="line-127"></a>    <span class='hs-varid'>processIOErrors</span>
<a name="line-128"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>ds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>classInstances</span> <span class='hs-varop'>++</span> <span class='hs-keyglyph'>[</span> <span class='hs-layout'>(</span><span class='hs-varid'>v</span><span class='hs-layout'>,</span><span class='hs-varid'>lc</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-layout'>,</span><span class='hs-varid'>v</span><span class='hs-layout'>,</span><span class='hs-varid'>lc</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ds'</span><span class='hs-layout'>,</span> <span class='hs-varid'>v</span> <span class='hs-varop'>`notElem`</span> <span class='hs-varid'>fsts</span> <span class='hs-varid'>classInstances</span> <span class='hs-keyglyph'>]</span>
<a name="line-129"></a>    <span class='hs-comment'>-- Build rules from instances, specializations, and user specified rules and catalysts</span>
<a name="line-130"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>augmentedClassHierarchy</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hoClassHierarchy</span> <span class='hs-layout'>(</span><span class='hs-varid'>hoTcInfo</span> <span class='hs-varid'>ho</span><span class='hs-layout'>)</span> <span class='hs-varop'>`augmentClassHierarchy`</span> <span class='hs-varid'>hoClassHierarchy</span> <span class='hs-layout'>(</span><span class='hs-varid'>hoTcInfo</span> <span class='hs-varid'>ho'</span><span class='hs-layout'>)</span>
<a name="line-131"></a>    <span class='hs-varid'>instanceRules</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>createInstanceRules</span> <span class='hs-varid'>fullDataTable</span> <span class='hs-varid'>augmentedClassHierarchy</span> <span class='hs-layout'>(</span><span class='hs-varid'>ds</span> <span class='hs-varop'>`mappend`</span> <span class='hs-varid'>hoEs</span> <span class='hs-layout'>(</span><span class='hs-varid'>hoBuild</span> <span class='hs-varid'>ho</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-132"></a>    <span class='hs-varid'>userRules</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>convertRules</span> <span class='hs-layout'>(</span><span class='hs-varid'>progModule</span> <span class='hs-varid'>prog</span><span class='hs-layout'>)</span> <span class='hs-varid'>tiData</span> <span class='hs-layout'>(</span><span class='hs-varid'>hoClassHierarchy</span>  <span class='hs-varop'>$</span> <span class='hs-varid'>hoTcInfo</span> <span class='hs-varid'>ho'</span><span class='hs-layout'>)</span> <span class='hs-varid'>allAssumps</span> <span class='hs-varid'>fullDataTable</span> <span class='hs-varid'>decls</span>
<a name="line-133"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>nds</span><span class='hs-layout'>,</span><span class='hs-varid'>specializeRules</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>procAllSpecs</span> <span class='hs-varid'>fullDataTable</span> <span class='hs-layout'>(</span><span class='hs-varid'>tiCheckedRules</span> <span class='hs-varid'>tiData</span><span class='hs-layout'>)</span> <span class='hs-varid'>ds</span>
<a name="line-134"></a>
<a name="line-135"></a>    <span class='hs-varid'>ds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ds</span> <span class='hs-varop'>++</span> <span class='hs-varid'>nds</span>
<a name="line-136"></a>    <span class='hs-varid'>wdump</span> <span class='hs-conid'>FD</span><span class='hs-varop'>.</span><span class='hs-conid'>CoreInitial</span> <span class='hs-varop'>$</span>
<a name="line-137"></a>        <span class='hs-varid'>mapM_</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-varid'>v</span><span class='hs-layout'>,</span><span class='hs-varid'>lc</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>printCheckName''</span> <span class='hs-varid'>fullDataTable</span> <span class='hs-varid'>v</span> <span class='hs-varid'>lc</span><span class='hs-layout'>)</span> <span class='hs-varid'>ds</span>
<a name="line-138"></a>    <span class='hs-varid'>ds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>annotateDs</span> <span class='hs-varid'>mempty</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-varid'>nfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>nfo</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-varid'>nfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>nfo</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-varid'>nfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>nfo</span><span class='hs-layout'>)</span> <span class='hs-varid'>ds</span>
<a name="line-139"></a>    <span class='hs-varid'>wdump</span> <span class='hs-conid'>FD</span><span class='hs-varop'>.</span><span class='hs-conid'>CoreInitial</span> <span class='hs-varop'>$</span>
<a name="line-140"></a>        <span class='hs-varid'>mapM_</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-varid'>v</span><span class='hs-layout'>,</span><span class='hs-varid'>lc</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>printCheckName''</span> <span class='hs-varid'>fullDataTable</span> <span class='hs-varid'>v</span> <span class='hs-varid'>lc</span><span class='hs-layout'>)</span> <span class='hs-varid'>ds</span>
<a name="line-141"></a>
<a name="line-142"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>rules</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Rules</span> <span class='hs-varid'>rules'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>instanceRules</span> <span class='hs-varop'>`mappend`</span> <span class='hs-varid'>userRules</span> <span class='hs-varop'>`mappend`</span> <span class='hs-varid'>specializeRules</span>
<a name="line-143"></a>
<a name="line-144"></a>    <span class='hs-varid'>dumpRules</span> <span class='hs-varid'>rules</span>
<a name="line-145"></a>
<a name="line-146"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>seasoning</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>freeVars</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>rs</span> <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>k</span><span class='hs-layout'>,</span><span class='hs-varid'>rs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>toList</span> <span class='hs-varid'>rules'</span><span class='hs-layout'>,</span> <span class='hs-varid'>k</span> <span class='hs-varop'>`notMember`</span> <span class='hs-varid'>defined</span> <span class='hs-keyglyph'>]</span> <span class='hs-varop'>`intersection`</span> <span class='hs-varid'>defined</span>
<a name="line-147"></a>        <span class='hs-varid'>defined</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fromList</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>tvrIdent</span> <span class='hs-varop'>.</span> <span class='hs-varid'>fst</span><span class='hs-layout'>)</span> <span class='hs-varid'>ds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IdSet</span>
<a name="line-148"></a>
<a name="line-149"></a>    <span class='hs-comment'>-- our initial program</span>
<a name="line-150"></a>    <span class='hs-varid'>prog</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>return</span> <span class='hs-varid'>prog</span> <span class='hs-layout'>{</span> <span class='hs-varid'>progSeasoning</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>seasoning</span> <span class='hs-layout'>}</span>
<a name="line-151"></a>    <span class='hs-conid'>Identity</span> <span class='hs-varid'>prog</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>programMapDs</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span> <span class='hs-layout'>(</span><span class='hs-varid'>t</span><span class='hs-layout'>,</span><span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>shouldBeExported</span> <span class='hs-layout'>(</span><span class='hs-varid'>getExports</span> <span class='hs-varop'>$</span> <span class='hs-varid'>hoTcInfo</span> <span class='hs-varid'>ho'</span><span class='hs-layout'>)</span> <span class='hs-varid'>t</span><span class='hs-layout'>,</span><span class='hs-varid'>e</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>atomizeApps</span> <span class='hs-conid'>False</span> <span class='hs-layout'>(</span><span class='hs-varid'>programSetDs</span> <span class='hs-varid'>ds</span> <span class='hs-varid'>prog</span><span class='hs-layout'>)</span>
<a name="line-152"></a>
<a name="line-153"></a>    <span class='hs-comment'>-- now we must attach rules to the existing chos, as well as the current ones</span>
<a name="line-154"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>addRule</span> <span class='hs-varid'>c</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mlookup</span> <span class='hs-layout'>(</span><span class='hs-varid'>combIdent</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span> <span class='hs-varid'>rules'</span> <span class='hs-keyword'>of</span>
<a name="line-155"></a>            <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>c</span>
<a name="line-156"></a>            <span class='hs-conid'>Just</span> <span class='hs-varid'>rs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>combRules_u</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ruleUpdate</span> <span class='hs-varop'>.</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>List</span><span class='hs-varop'>.</span><span class='hs-varid'>union</span> <span class='hs-varid'>rs</span><span class='hs-layout'>)</span> <span class='hs-varid'>c</span>
<a name="line-157"></a>    <span class='hs-varid'>prog</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>progCombinators_u</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>addRule</span><span class='hs-layout'>)</span> <span class='hs-varid'>prog</span>
<a name="line-158"></a>    <span class='hs-varid'>cho</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>updateChoHo</span> <span class='hs-varop'>$</span> <span class='hs-varid'>choCombinators_u</span> <span class='hs-layout'>(</span><span class='hs-varid'>fmap</span> <span class='hs-varid'>addRule</span><span class='hs-layout'>)</span> <span class='hs-varid'>cho</span>
<a name="line-159"></a>
<a name="line-160"></a>    <span class='hs-comment'>-- Here we substitute in all the original types, with rules and properties defined in the current module included</span>
<a name="line-161"></a>    <span class='hs-varid'>prog</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>runIdentity</span> <span class='hs-varop'>$</span> <span class='hs-varid'>annotateProgram</span> <span class='hs-layout'>(</span><span class='hs-varid'>choVarMap</span> <span class='hs-varid'>cho</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>idann</span> <span class='hs-varid'>theProps</span><span class='hs-layout'>)</span> <span class='hs-varid'>letann</span> <span class='hs-varid'>lamann</span> <span class='hs-varid'>prog</span>
<a name="line-162"></a>
<a name="line-163"></a>    <span class='hs-varid'>lintCheckProgram</span> <span class='hs-layout'>(</span><span class='hs-varid'>putErrLn</span> <span class='hs-str'>"LintPostProcess"</span><span class='hs-layout'>)</span> <span class='hs-varid'>prog</span>
<a name="line-164"></a>
<a name="line-165"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>entryPoints</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fromList</span> <span class='hs-varop'>.</span> <span class='hs-varid'>execWriter</span> <span class='hs-varop'>$</span> <span class='hs-varid'>programMapDs_</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span> <span class='hs-layout'>(</span><span class='hs-varid'>t</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>when</span>
<a name="line-166"></a>            <span class='hs-layout'>(</span><span class='hs-varid'>getProperty</span> <span class='hs-varid'>prop_EXPORTED</span> <span class='hs-varid'>t</span> <span class='hs-varop'>||</span> <span class='hs-varid'>getProperty</span> <span class='hs-varid'>prop_INSTANCE</span> <span class='hs-varid'>t</span> <span class='hs-varop'>||</span> <span class='hs-varid'>getProperty</span> <span class='hs-varid'>prop_SPECIALIZATION</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span>  <span class='hs-layout'>(</span><span class='hs-varid'>tell</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>tvrIdent</span> <span class='hs-varid'>t</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>prog</span>
<a name="line-167"></a>    <span class='hs-varid'>prog</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>prog</span> <span class='hs-layout'>{</span> <span class='hs-varid'>progEntry</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>entryPoints</span> <span class='hs-varop'>`mappend`</span> <span class='hs-varid'>progSeasoning</span> <span class='hs-varid'>prog</span> <span class='hs-layout'>}</span>
<a name="line-168"></a>
<a name="line-169"></a>    <span class='hs-varid'>lintCheckProgram</span> <span class='hs-layout'>(</span><span class='hs-varid'>putErrLn</span> <span class='hs-str'>"InitialLint"</span><span class='hs-layout'>)</span> <span class='hs-varid'>prog</span>
<a name="line-170"></a>
<a name="line-171"></a>    <span class='hs-varid'>prog</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>programPrune</span> <span class='hs-varid'>prog</span>
<a name="line-172"></a>
<a name="line-173"></a>    <span class='hs-comment'>-- initial pass, performs</span>
<a name="line-174"></a>    <span class='hs-comment'>-- eta expansion of definitons</span>
<a name="line-175"></a>    <span class='hs-comment'>-- simplify</span>
<a name="line-176"></a>    <span class='hs-comment'>-- type analysis</span>
<a name="line-177"></a>    <span class='hs-comment'>-- floating outward</span>
<a name="line-178"></a>    <span class='hs-comment'>-- simplify</span>
<a name="line-179"></a>    <span class='hs-comment'>-- floating inward</span>
<a name="line-180"></a>
<a name="line-181"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>sopt</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SS</span><span class='hs-varop'>.</span><span class='hs-varid'>cacheSimpOpts</span> <span class='hs-conid'>SS</span><span class='hs-varop'>.</span><span class='hs-varid'>emptySimplifyOpts</span> <span class='hs-layout'>{</span>
<a name="line-182"></a>            <span class='hs-conid'>SS</span><span class='hs-varop'>.</span><span class='hs-varid'>so_boundVars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>choCombinators</span> <span class='hs-varid'>cho</span><span class='hs-layout'>,</span>
<a name="line-183"></a>            <span class='hs-conid'>SS</span><span class='hs-varop'>.</span><span class='hs-varid'>so_forwardVars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>progSeasoning</span> <span class='hs-varid'>prog</span>
<a name="line-184"></a>            <span class='hs-layout'>}</span>
<a name="line-185"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>tparms</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>transformParms</span> <span class='hs-layout'>{</span>
<a name="line-186"></a>            <span class='hs-varid'>transformPass</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>"PreInit"</span><span class='hs-layout'>,</span>
<a name="line-187"></a>            <span class='hs-varid'>transformDumpProgress</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>verbose</span>
<a name="line-188"></a>            <span class='hs-layout'>}</span>
<a name="line-189"></a>
<a name="line-190"></a>    <span class='hs-comment'>-- quick float inward pass to inline once used functions and prune unused ones</span>
<a name="line-191"></a>    <span class='hs-varid'>prog</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>transformProgram</span> <span class='hs-varid'>tparms</span> <span class='hs-layout'>{</span>
<a name="line-192"></a>        <span class='hs-varid'>transformCategory</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>"FloatInward"</span><span class='hs-layout'>,</span>
<a name="line-193"></a>        <span class='hs-varid'>transformOperation</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>programFloatInward</span>
<a name="line-194"></a>        <span class='hs-layout'>}</span> <span class='hs-varid'>prog</span>
<a name="line-195"></a>
<a name="line-196"></a>    <span class='hs-varid'>putProgress</span> <span class='hs-str'>"&lt;"</span>
<a name="line-197"></a>    <span class='hs-varid'>pr_r</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>progressIONew</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varop'>$</span> <span class='hs-varid'>programDecomposedDs</span> <span class='hs-varid'>prog</span><span class='hs-layout'>)</span> <span class='hs-num'>25</span> <span class='hs-chr'>'.'</span>
<a name="line-198"></a>
<a name="line-199"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>fint</span> <span class='hs-varid'>mprog</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-200"></a>        <span class='hs-keyword'>let</span> <span class='hs-varid'>names</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprint</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>programDs</span> <span class='hs-varid'>mprog</span><span class='hs-keyglyph'>]</span>
<a name="line-201"></a>        <span class='hs-varid'>withStackStatus</span> <span class='hs-layout'>(</span><span class='hs-str'>"fint: "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>names</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-202"></a>        <span class='hs-varid'>when</span> <span class='hs-varid'>coreMini</span> <span class='hs-varop'>$</span> <span class='hs-varid'>putErrLn</span> <span class='hs-layout'>(</span><span class='hs-str'>"----\n"</span> <span class='hs-varop'>++</span> <span class='hs-varid'>names</span><span class='hs-layout'>)</span>
<a name="line-203"></a>        <span class='hs-keyword'>let</span> <span class='hs-varid'>tparms</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>transformParms</span> <span class='hs-layout'>{</span> <span class='hs-varid'>transformPass</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>"Init"</span><span class='hs-layout'>,</span> <span class='hs-varid'>transformDumpProgress</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coreMini</span> <span class='hs-layout'>}</span>
<a name="line-204"></a>
<a name="line-205"></a>        <span class='hs-varid'>lintCheckProgram</span> <span class='hs-varid'>onerrNone</span> <span class='hs-varid'>mprog</span>
<a name="line-206"></a>        <span class='hs-varid'>mprog</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>evaluate</span> <span class='hs-varop'>$</span> <span class='hs-varid'>etaAnnotateProgram</span> <span class='hs-varid'>mprog</span>
<a name="line-207"></a>        <span class='hs-varid'>lintCheckProgram</span> <span class='hs-varid'>onerrNone</span> <span class='hs-varid'>mprog</span>
<a name="line-208"></a>
<a name="line-209"></a>        <span class='hs-varid'>mprog</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>simplifyProgram</span> <span class='hs-varid'>sopt</span> <span class='hs-str'>"Init-One"</span> <span class='hs-varid'>coreMini</span> <span class='hs-varid'>mprog</span>
<a name="line-210"></a>
<a name="line-211"></a>        <span class='hs-comment'>-- this catches more static arguments if we wait until after the initial normalizing simplification pass</span>
<a name="line-212"></a>        <span class='hs-varid'>mprog</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>transformProgram</span> <span class='hs-varid'>tparms</span> <span class='hs-layout'>{</span> <span class='hs-varid'>transformSkipNoStats</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span><span class='hs-layout'>,</span> <span class='hs-varid'>transformCategory</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>"SimpleRecursive"</span>
<a name="line-213"></a>                                         <span class='hs-layout'>,</span> <span class='hs-varid'>transformOperation</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varop'>.</span> <span class='hs-varid'>staticArgumentTransform</span> <span class='hs-layout'>}</span> <span class='hs-varid'>mprog</span>
<a name="line-214"></a>
<a name="line-215"></a>        <span class='hs-varid'>mprog</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>transformProgram</span> <span class='hs-varid'>tparms</span> <span class='hs-layout'>{</span> <span class='hs-varid'>transformCategory</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>"FloatOutward"</span><span class='hs-layout'>,</span> <span class='hs-varid'>transformOperation</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>floatOutward</span> <span class='hs-layout'>}</span> <span class='hs-varid'>mprog</span>
<a name="line-216"></a>        <span class='hs-varid'>mprog</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>transformProgram</span> <span class='hs-varid'>tparms</span> <span class='hs-layout'>{</span> <span class='hs-varid'>transformCategory</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>"typeAnalyze"</span><span class='hs-layout'>,</span> <span class='hs-varid'>transformPass</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>"PreInit"</span>
<a name="line-217"></a>                                         <span class='hs-layout'>,</span> <span class='hs-varid'>transformOperation</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>typeAnalyze</span> <span class='hs-conid'>True</span> <span class='hs-layout'>}</span> <span class='hs-varid'>mprog</span>
<a name="line-218"></a>
<a name="line-219"></a>        <span class='hs-varid'>mprog</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>transformProgram</span> <span class='hs-varid'>tparms</span> <span class='hs-layout'>{</span> <span class='hs-varid'>transformCategory</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>"FloatOutward"</span><span class='hs-layout'>,</span> <span class='hs-varid'>transformOperation</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>floatOutward</span> <span class='hs-layout'>}</span> <span class='hs-varid'>mprog</span>
<a name="line-220"></a>
<a name="line-221"></a>        <span class='hs-comment'>-- perform another supersimplify in order to substitute the once used</span>
<a name="line-222"></a>        <span class='hs-comment'>-- variables back in and replace the variable of case of variables with</span>
<a name="line-223"></a>        <span class='hs-comment'>-- the default binding of the case statement.</span>
<a name="line-224"></a>        <span class='hs-varid'>mprog</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>simplifyProgram</span> <span class='hs-varid'>sopt</span> <span class='hs-str'>"Init-Two-FloatOutCleanup"</span> <span class='hs-varid'>coreMini</span> <span class='hs-varid'>mprog</span>
<a name="line-225"></a>        <span class='hs-varid'>mprog</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>transformProgram</span> <span class='hs-varid'>tparms</span> <span class='hs-layout'>{</span> <span class='hs-varid'>transformCategory</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>"typeAnalyze"</span><span class='hs-layout'>,</span> <span class='hs-varid'>transformOperation</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>typeAnalyze</span> <span class='hs-conid'>True</span> <span class='hs-layout'>}</span> <span class='hs-varid'>mprog</span>
<a name="line-226"></a>
<a name="line-227"></a>        <span class='hs-varid'>mprog</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>transformProgram</span> <span class='hs-varid'>tparms</span> <span class='hs-layout'>{</span> <span class='hs-varid'>transformCategory</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>"FloatInward"</span><span class='hs-layout'>,</span> <span class='hs-varid'>transformOperation</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>programFloatInward</span> <span class='hs-layout'>}</span> <span class='hs-varid'>mprog</span>
<a name="line-228"></a>        <span class='hs-varid'>mprog</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>Demand</span><span class='hs-varop'>.</span><span class='hs-varid'>analyzeProgram</span> <span class='hs-varid'>mprog</span>
<a name="line-229"></a>        <span class='hs-varid'>lintCheckProgram</span> <span class='hs-varid'>onerrNone</span> <span class='hs-varid'>mprog</span>
<a name="line-230"></a>        <span class='hs-varid'>mprog</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>simplifyProgram</span> <span class='hs-varid'>sopt</span> <span class='hs-str'>"Init-Three-AfterDemand"</span> <span class='hs-conid'>False</span> <span class='hs-varid'>mprog</span>
<a name="line-231"></a>        <span class='hs-varid'>when</span> <span class='hs-varid'>miniCorePass</span> <span class='hs-varop'>$</span> <span class='hs-varid'>printProgram</span> <span class='hs-varid'>mprog</span> <span class='hs-comment'>-- mapM_ (\ (v,lc) -&gt; printCheckName'' fullDataTable v lc) (programDs mprog)</span>
<a name="line-232"></a>        <span class='hs-varid'>when</span> <span class='hs-varid'>miniCoreSteps</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Stats</span><span class='hs-varop'>.</span><span class='hs-varid'>printLStat</span> <span class='hs-layout'>(</span><span class='hs-varid'>optStatLevel</span> <span class='hs-varid'>options</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-str'>"InitialOptimize:"</span> <span class='hs-varop'>++</span> <span class='hs-varid'>names</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>progStats</span> <span class='hs-varid'>mprog</span><span class='hs-layout'>)</span>
<a name="line-233"></a>        <span class='hs-varid'>wdump</span> <span class='hs-conid'>FD</span><span class='hs-varop'>.</span><span class='hs-conid'>Progress</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>let</span> <span class='hs-conid'>SubProgram</span> <span class='hs-varid'>isRec</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>progType</span> <span class='hs-varid'>mprog</span> <span class='hs-keyword'>in</span>  <span class='hs-varid'>progressIOSteps</span> <span class='hs-varid'>pr_r</span> <span class='hs-layout'>(</span><span class='hs-keyword'>if</span> <span class='hs-varid'>isRec</span> <span class='hs-keyword'>then</span> <span class='hs-str'>"*"</span> <span class='hs-keyword'>else</span> <span class='hs-str'>"."</span><span class='hs-layout'>)</span>
<a name="line-234"></a>        <span class='hs-varid'>return</span> <span class='hs-varid'>mprog</span>
<a name="line-235"></a>    <span class='hs-varid'>lintCheckProgram</span> <span class='hs-varid'>onerrNone</span> <span class='hs-varid'>prog</span>
<a name="line-236"></a>    <span class='hs-varid'>prog</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>programMapProgGroups</span> <span class='hs-varid'>mempty</span> <span class='hs-varid'>fint</span> <span class='hs-varid'>prog</span>
<a name="line-237"></a>
<a name="line-238"></a>    <span class='hs-varid'>wdump</span> <span class='hs-conid'>FD</span><span class='hs-varop'>.</span><span class='hs-conid'>Stats</span> <span class='hs-varop'>$</span>
<a name="line-239"></a>        <span class='hs-conid'>Stats</span><span class='hs-varop'>.</span><span class='hs-varid'>printLStat</span> <span class='hs-layout'>(</span><span class='hs-varid'>optStatLevel</span> <span class='hs-varid'>options</span><span class='hs-layout'>)</span> <span class='hs-str'>"Initial Pass Stats"</span> <span class='hs-layout'>(</span><span class='hs-varid'>progStats</span> <span class='hs-varid'>prog</span><span class='hs-layout'>)</span>
<a name="line-240"></a>    <span class='hs-varid'>lintCheckProgram</span> <span class='hs-varid'>onerrNone</span> <span class='hs-varid'>prog</span>
<a name="line-241"></a>
<a name="line-242"></a>    <span class='hs-varid'>prog</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>etaExpandProg</span> <span class='hs-str'>"Init-Big-One"</span> <span class='hs-varid'>prog</span> <span class='hs-layout'>{</span> <span class='hs-varid'>progStats</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mempty</span> <span class='hs-layout'>}</span>
<a name="line-243"></a>    <span class='hs-varid'>prog</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>transformProgram</span> <span class='hs-varid'>tparms</span> <span class='hs-layout'>{</span>
<a name="line-244"></a>        <span class='hs-varid'>transformPass</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>"Init-Big-One"</span><span class='hs-layout'>,</span>
<a name="line-245"></a>        <span class='hs-varid'>transformCategory</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>"FloatInward"</span><span class='hs-layout'>,</span>
<a name="line-246"></a>        <span class='hs-varid'>transformOperation</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>programFloatInward</span>
<a name="line-247"></a>        <span class='hs-layout'>}</span> <span class='hs-varid'>prog</span>
<a name="line-248"></a>
<a name="line-249"></a>    <span class='hs-varid'>prog</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>Demand</span><span class='hs-varop'>.</span><span class='hs-varid'>analyzeProgram</span> <span class='hs-varid'>prog</span>
<a name="line-250"></a>    <span class='hs-varid'>prog</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>simplifyProgram'</span> <span class='hs-varid'>sopt</span> <span class='hs-str'>"Init-Big-One"</span> <span class='hs-varid'>verbose</span> <span class='hs-layout'>(</span><span class='hs-conid'>IterateMax</span> <span class='hs-num'>4</span><span class='hs-layout'>)</span> <span class='hs-varid'>prog</span>
<a name="line-251"></a>
<a name="line-252"></a>    <span class='hs-varid'>wdump</span> <span class='hs-conid'>FD</span><span class='hs-varop'>.</span><span class='hs-conid'>Stats</span> <span class='hs-varop'>$</span>
<a name="line-253"></a>        <span class='hs-conid'>Stats</span><span class='hs-varop'>.</span><span class='hs-varid'>printLStat</span> <span class='hs-layout'>(</span><span class='hs-varid'>optStatLevel</span> <span class='hs-varid'>options</span><span class='hs-layout'>)</span> <span class='hs-str'>"Init-Big-One Stats"</span> <span class='hs-layout'>(</span><span class='hs-varid'>progStats</span> <span class='hs-varid'>prog</span><span class='hs-layout'>)</span>
<a name="line-254"></a>
<a name="line-255"></a>    <span class='hs-varid'>pr_r</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>progressIONew</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varop'>$</span> <span class='hs-varid'>programDecomposedCombs</span> <span class='hs-varid'>prog</span><span class='hs-layout'>)</span> <span class='hs-num'>25</span> <span class='hs-chr'>'.'</span>
<a name="line-256"></a>
<a name="line-257"></a>    <span class='hs-comment'>-- This is the main function that optimizes the routines before writing them out</span>
<a name="line-258"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>optWW</span> <span class='hs-varid'>mprog</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-259"></a>        <span class='hs-keyword'>let</span> <span class='hs-varid'>names</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprint</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>programDs</span> <span class='hs-varid'>mprog</span><span class='hs-keyglyph'>]</span>
<a name="line-260"></a>        <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>when</span> <span class='hs-varid'>coreMini</span> <span class='hs-varop'>$</span> <span class='hs-varid'>putErrLn</span> <span class='hs-layout'>(</span><span class='hs-str'>"----\n"</span> <span class='hs-varop'>++</span> <span class='hs-varid'>names</span><span class='hs-layout'>)</span>
<a name="line-261"></a>        <span class='hs-varid'>smap</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>get</span>
<a name="line-262"></a>        <span class='hs-keyword'>let</span> <span class='hs-varid'>tparms</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>transformParms</span> <span class='hs-layout'>{</span> <span class='hs-varid'>transformPass</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>"OptWW"</span><span class='hs-layout'>,</span> <span class='hs-varid'>transformDumpProgress</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coreMini</span> <span class='hs-layout'>}</span>
<a name="line-263"></a>            <span class='hs-varid'>sopt</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SS</span><span class='hs-varop'>.</span><span class='hs-varid'>cacheSimpOpts</span> <span class='hs-conid'>SS</span><span class='hs-varop'>.</span><span class='hs-varid'>emptySimplifyOpts</span> <span class='hs-layout'>{</span>
<a name="line-264"></a>                <span class='hs-conid'>SS</span><span class='hs-varop'>.</span><span class='hs-varid'>so_boundVars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>smap</span><span class='hs-layout'>,</span>
<a name="line-265"></a>                <span class='hs-conid'>SS</span><span class='hs-varop'>.</span><span class='hs-varid'>so_forwardVars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>progSeasoning</span> <span class='hs-varid'>mprog</span>
<a name="line-266"></a>                <span class='hs-layout'>}</span>
<a name="line-267"></a>
<a name="line-268"></a>        <span class='hs-varid'>mprog</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>simplifyProgram</span> <span class='hs-varid'>sopt</span> <span class='hs-str'>"Simplify-One"</span> <span class='hs-varid'>coreMini</span> <span class='hs-varid'>mprog</span>
<a name="line-269"></a>        <span class='hs-varid'>mprog</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>transformProgram</span> <span class='hs-varid'>tparms</span> <span class='hs-layout'>{</span> <span class='hs-varid'>transformCategory</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>"FloatInward"</span><span class='hs-layout'>,</span> <span class='hs-varid'>transformOperation</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>programFloatInward</span> <span class='hs-layout'>}</span> <span class='hs-varid'>mprog</span>
<a name="line-270"></a>        <span class='hs-varid'>mprog</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>Demand</span><span class='hs-varop'>.</span><span class='hs-varid'>analyzeProgram</span> <span class='hs-varid'>mprog</span>
<a name="line-271"></a>        <span class='hs-varid'>mprog</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>simplifyProgram</span> <span class='hs-varid'>sopt</span> <span class='hs-str'>"Simplify-Two"</span> <span class='hs-varid'>coreMini</span> <span class='hs-varid'>mprog</span>
<a name="line-272"></a>        <span class='hs-varid'>mprog</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>transformProgram</span> <span class='hs-varid'>tparms</span> <span class='hs-layout'>{</span> <span class='hs-varid'>transformCategory</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>"FloatInward"</span><span class='hs-layout'>,</span> <span class='hs-varid'>transformOperation</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>programFloatInward</span> <span class='hs-layout'>}</span> <span class='hs-varid'>mprog</span>
<a name="line-273"></a>        <span class='hs-varid'>mprog</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>Demand</span><span class='hs-varop'>.</span><span class='hs-varid'>analyzeProgram</span> <span class='hs-varid'>mprog</span>
<a name="line-274"></a>        <span class='hs-varid'>mprog</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>E</span><span class='hs-varop'>.</span><span class='hs-conid'>CPR</span><span class='hs-varop'>.</span><span class='hs-varid'>cprAnalyzeProgram</span> <span class='hs-varid'>mprog</span>
<a name="line-275"></a>        <span class='hs-varid'>mprog'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>transformProgram</span> <span class='hs-varid'>tparms</span> <span class='hs-layout'>{</span> <span class='hs-varid'>transformSkipNoStats</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span><span class='hs-layout'>,</span> <span class='hs-varid'>transformCategory</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>"WorkWrap"</span><span class='hs-layout'>,</span> <span class='hs-varid'>transformOperation</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varop'>.</span> <span class='hs-varid'>workWrapProgram</span> <span class='hs-layout'>}</span> <span class='hs-varid'>mprog</span>
<a name="line-276"></a>        <span class='hs-keyword'>let</span> <span class='hs-varid'>wws</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-layout'>(</span><span class='hs-varid'>programDs</span> <span class='hs-varid'>mprog'</span><span class='hs-layout'>)</span> <span class='hs-comment'>-</span> <span class='hs-varid'>length</span> <span class='hs-layout'>(</span><span class='hs-varid'>programDs</span> <span class='hs-varid'>mprog</span><span class='hs-layout'>)</span>
<a name="line-277"></a><span class='hs-comment'>--        liftIO $ wdump FD.Progress $ putErr (replicate wws 'w')</span>
<a name="line-278"></a>        <span class='hs-varid'>mprog</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>return</span> <span class='hs-varid'>mprog'</span>
<a name="line-279"></a>
<a name="line-280"></a>        <span class='hs-varid'>mprog</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>simplifyProgram</span> <span class='hs-varid'>sopt</span> <span class='hs-str'>"Simplify-Three"</span> <span class='hs-varid'>coreMini</span> <span class='hs-varid'>mprog</span>
<a name="line-281"></a>
<a name="line-282"></a>        <span class='hs-comment'>--mprog &lt;- transformProgram tparms { transformCategory = "FloatInward", transformOperation = programFloatInward } mprog</span>
<a name="line-283"></a>        <span class='hs-comment'>--mprog &lt;- Demand.analyzeProgram mprog</span>
<a name="line-284"></a>        <span class='hs-comment'>--mprog &lt;- return $ E.CPR.cprAnalyzeProgram mprog</span>
<a name="line-285"></a>        <span class='hs-comment'>--mprog &lt;- transformProgram tparms { transformSkipNoStats = True, transformCategory = "WorkWrap2", transformOperation = return . workWrapProgram } mprog</span>
<a name="line-286"></a>        <span class='hs-comment'>--mprog &lt;- simplifyProgram sopt "Simplify-Four" coreMini mprog</span>
<a name="line-287"></a>
<a name="line-288"></a>        <span class='hs-comment'>-- annotate our bindings for further passes</span>
<a name="line-289"></a>        <span class='hs-varid'>mprog</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>etaAnnotateProgram</span> <span class='hs-varid'>mprog</span>
<a name="line-290"></a>        <span class='hs-varid'>mprog</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>Demand</span><span class='hs-varop'>.</span><span class='hs-varid'>analyzeProgram</span> <span class='hs-varid'>mprog</span>
<a name="line-291"></a>        <span class='hs-varid'>mprog</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>E</span><span class='hs-varop'>.</span><span class='hs-conid'>CPR</span><span class='hs-varop'>.</span><span class='hs-varid'>cprAnalyzeProgram</span> <span class='hs-varid'>mprog</span>
<a name="line-292"></a>
<a name="line-293"></a>        <span class='hs-varid'>put</span> <span class='hs-varop'>$</span> <span class='hs-varid'>fromList</span> <span class='hs-keyglyph'>[</span> <span class='hs-layout'>(</span><span class='hs-varid'>combIdent</span> <span class='hs-varid'>c</span><span class='hs-layout'>,</span><span class='hs-varid'>c</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>c</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>progCombinators</span> <span class='hs-varid'>mprog</span><span class='hs-keyglyph'>]</span> <span class='hs-varop'>`</span><span class='hs-conid'>S</span><span class='hs-varop'>.</span><span class='hs-varid'>union</span><span class='hs-varop'>`</span> <span class='hs-varid'>smap</span>
<a name="line-294"></a>
<a name="line-295"></a>        <span class='hs-comment'>--liftIO $ wdump FD.Progress $ let SubProgram rec = progType mprog in  putErr (if rec then "*" else ".")</span>
<a name="line-296"></a>        <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>wdump</span> <span class='hs-conid'>FD</span><span class='hs-varop'>.</span><span class='hs-conid'>Progress</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>let</span> <span class='hs-conid'>SubProgram</span> <span class='hs-varid'>isRec</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>progType</span> <span class='hs-varid'>mprog</span> <span class='hs-keyword'>in</span>  <span class='hs-varid'>progressIOSteps</span> <span class='hs-varid'>pr_r</span> <span class='hs-layout'>(</span><span class='hs-keyword'>if</span> <span class='hs-varid'>wws</span> <span class='hs-varop'>&gt;</span> <span class='hs-num'>0</span> <span class='hs-keyword'>then</span> <span class='hs-str'>"w"</span> <span class='hs-keyword'>else</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>isRec</span> <span class='hs-keyword'>then</span> <span class='hs-str'>"*"</span> <span class='hs-keyword'>else</span> <span class='hs-str'>"."</span><span class='hs-layout'>)</span>
<a name="line-297"></a>        <span class='hs-varid'>return</span> <span class='hs-varid'>mprog</span>
<a name="line-298"></a>
<a name="line-299"></a>    <span class='hs-varid'>prog</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>evalStateT</span> <span class='hs-layout'>(</span><span class='hs-varid'>programMapProgGroups</span> <span class='hs-varid'>mempty</span> <span class='hs-varid'>optWW</span> <span class='hs-varid'>prog</span> <span class='hs-layout'>{</span> <span class='hs-varid'>progStats</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mempty</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>SS</span><span class='hs-varop'>.</span><span class='hs-varid'>so_boundVars</span> <span class='hs-varid'>sopt</span><span class='hs-layout'>)</span>
<a name="line-300"></a>    <span class='hs-varid'>putProgressLn</span> <span class='hs-str'>"&gt;"</span>
<a name="line-301"></a>    <span class='hs-varid'>wdump</span> <span class='hs-conid'>FD</span><span class='hs-varop'>.</span><span class='hs-conid'>Stats</span> <span class='hs-varop'>$</span>
<a name="line-302"></a>        <span class='hs-conid'>Stats</span><span class='hs-varop'>.</span><span class='hs-varid'>printLStat</span> <span class='hs-layout'>(</span><span class='hs-varid'>optStatLevel</span> <span class='hs-varid'>options</span><span class='hs-layout'>)</span> <span class='hs-str'>"MainPass Stats"</span> <span class='hs-layout'>(</span><span class='hs-varid'>progStats</span> <span class='hs-varid'>prog</span><span class='hs-layout'>)</span>
<a name="line-303"></a>
<a name="line-304"></a>    <span class='hs-varid'>processIOErrors</span>
<a name="line-305"></a>
<a name="line-306"></a>    <span class='hs-varid'>lintCheckProgram</span> <span class='hs-layout'>(</span><span class='hs-varid'>putErrLn</span> <span class='hs-str'>"After the workwrap/CPR"</span><span class='hs-layout'>)</span> <span class='hs-varid'>prog</span>
<a name="line-307"></a>
<a name="line-308"></a>    <span class='hs-varid'>prog</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>programPrune</span> <span class='hs-varid'>prog</span>
<a name="line-309"></a>
<a name="line-310"></a>    <span class='hs-varid'>lintCheckProgram</span> <span class='hs-layout'>(</span><span class='hs-varid'>putErrLn</span> <span class='hs-str'>"After the Opimization"</span><span class='hs-layout'>)</span> <span class='hs-varid'>prog</span>
<a name="line-311"></a>    <span class='hs-varid'>wdump</span> <span class='hs-conid'>FD</span><span class='hs-varop'>.</span><span class='hs-conid'>Core</span> <span class='hs-varop'>$</span> <span class='hs-varid'>printProgram</span> <span class='hs-varid'>prog</span>
<a name="line-312"></a>
<a name="line-313"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>newHoBuild</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>hoBuild</span> <span class='hs-varid'>ho'</span><span class='hs-layout'>)</span> <span class='hs-layout'>{</span>
<a name="line-314"></a>        <span class='hs-varid'>hoDataTable</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dataTable</span><span class='hs-layout'>,</span>
<a name="line-315"></a>        <span class='hs-varid'>hoEs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>programDs</span> <span class='hs-varid'>prog</span><span class='hs-layout'>,</span>
<a name="line-316"></a>        <span class='hs-varid'>hoRules</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hoRules</span> <span class='hs-layout'>(</span><span class='hs-varid'>hoBuild</span> <span class='hs-varid'>ho'</span><span class='hs-layout'>)</span> <span class='hs-varop'>`mappend`</span> <span class='hs-varid'>rules</span>
<a name="line-317"></a>        <span class='hs-layout'>}</span>
<a name="line-318"></a>        <span class='hs-varid'>newMap</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fmap</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>c</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>EVar</span> <span class='hs-varop'>$</span> <span class='hs-varid'>combHead</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>progCombMap</span> <span class='hs-varid'>prog</span>
<a name="line-319"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>updateChoHo</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mempty</span> <span class='hs-layout'>{</span>
<a name="line-320"></a>        <span class='hs-varid'>choHoMap</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>singleton</span> <span class='hs-layout'>(</span><span class='hs-varid'>hoModuleGroup</span> <span class='hs-varid'>ho'</span><span class='hs-layout'>)</span> <span class='hs-varid'>ho'</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hoBuild</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>newHoBuild</span><span class='hs-layout'>}</span><span class='hs-layout'>,</span>
<a name="line-321"></a>        <span class='hs-varid'>choCombinators</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fromList</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>[</span> <span class='hs-layout'>(</span><span class='hs-varid'>combIdent</span> <span class='hs-varid'>c</span><span class='hs-layout'>,</span><span class='hs-varid'>c</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>c</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>progCombinators</span> <span class='hs-varid'>prog</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<a name="line-322"></a>        <span class='hs-varid'>choExternalNames</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idMapToIdSet</span> <span class='hs-varid'>newMap</span>
<a name="line-323"></a>        <span class='hs-layout'>}</span> <span class='hs-varop'>`mappend`</span> <span class='hs-varid'>cho</span><span class='hs-layout'>,</span><span class='hs-varid'>ho'</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hoBuild</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>newHoBuild</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-324"></a>
<a name="line-325"></a><a name="coreMini"></a><span class='hs-definition'>coreMini</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dump</span> <span class='hs-conid'>FD</span><span class='hs-varop'>.</span><span class='hs-conid'>CoreMini</span>
<a name="line-326"></a><a name="corePass"></a><span class='hs-definition'>corePass</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dump</span> <span class='hs-conid'>FD</span><span class='hs-varop'>.</span><span class='hs-conid'>CorePass</span>
<a name="line-327"></a><a name="coreSteps"></a><span class='hs-definition'>coreSteps</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dump</span> <span class='hs-conid'>FD</span><span class='hs-varop'>.</span><span class='hs-conid'>CoreSteps</span>
<a name="line-328"></a><a name="miniCorePass"></a><span class='hs-definition'>miniCorePass</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coreMini</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>corePass</span>
<a name="line-329"></a><a name="miniCoreSteps"></a><span class='hs-definition'>miniCoreSteps</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coreMini</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>coreSteps</span>
<a name="line-330"></a>
<a name="line-331"></a><a name="dumpRules"></a><span class='hs-definition'>dumpRules</span> <span class='hs-varid'>rules</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-332"></a>    <span class='hs-varid'>wdump</span> <span class='hs-conid'>FD</span><span class='hs-varop'>.</span><span class='hs-conid'>Rules</span> <span class='hs-varop'>$</span> <span class='hs-varid'>putStrLn</span> <span class='hs-str'>"  ---- user rules ---- "</span> <span class='hs-varop'>&gt;&gt;</span> <span class='hs-varid'>printRules</span> <span class='hs-conid'>RuleUser</span> <span class='hs-varid'>rules</span>
<a name="line-333"></a>    <span class='hs-varid'>wdump</span> <span class='hs-conid'>FD</span><span class='hs-varop'>.</span><span class='hs-conid'>Rules</span> <span class='hs-varop'>$</span> <span class='hs-varid'>putStrLn</span> <span class='hs-str'>"  ---- user catalysts ---- "</span> <span class='hs-varop'>&gt;&gt;</span> <span class='hs-varid'>printRules</span> <span class='hs-conid'>RuleCatalyst</span> <span class='hs-varid'>rules</span>
<a name="line-334"></a>    <span class='hs-varid'>wdump</span> <span class='hs-conid'>FD</span><span class='hs-varop'>.</span><span class='hs-conid'>RulesSpec</span> <span class='hs-varop'>$</span> <span class='hs-varid'>putStrLn</span> <span class='hs-str'>"  ---- specializations ---- "</span> <span class='hs-varop'>&gt;&gt;</span> <span class='hs-varid'>printRules</span> <span class='hs-conid'>RuleSpecialization</span> <span class='hs-varid'>rules</span>
<a name="line-335"></a>
<a name="line-336"></a><a name="programPruneUnreachable"></a><span class='hs-definition'>programPruneUnreachable</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Program</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Program</span>
<a name="line-337"></a><span class='hs-definition'>programPruneUnreachable</span> <span class='hs-varid'>prog</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>progCombinators_s</span> <span class='hs-varid'>ds'</span> <span class='hs-varid'>prog</span> <span class='hs-keyword'>where</span>
<a name="line-338"></a>    <span class='hs-varid'>ds'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reachableFrom</span> <span class='hs-varid'>combIdent</span> <span class='hs-varid'>freeVars</span> <span class='hs-layout'>(</span><span class='hs-varid'>progCombinators</span> <span class='hs-varid'>prog</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>toList</span> <span class='hs-varop'>$</span> <span class='hs-varid'>progEntry</span> <span class='hs-varid'>prog</span><span class='hs-layout'>)</span>
<a name="line-339"></a>
<a name="line-340"></a><a name="programPrune"></a><span class='hs-definition'>programPrune</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Program</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>Program</span>
<a name="line-341"></a><span class='hs-definition'>programPrune</span> <span class='hs-varid'>prog</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>transformProgram</span> <span class='hs-varid'>transformParms</span> <span class='hs-layout'>{</span> <span class='hs-varid'>transformCategory</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>"PruneUnreachable"</span>
<a name="line-342"></a>                                                    <span class='hs-layout'>,</span> <span class='hs-varid'>transformDumpProgress</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>miniCorePass</span>
<a name="line-343"></a>                                                    <span class='hs-layout'>,</span> <span class='hs-varid'>transformOperation</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>evaluate</span> <span class='hs-varop'>.</span> <span class='hs-varid'>programPruneUnreachable</span> <span class='hs-layout'>}</span> <span class='hs-varid'>prog</span>
<a name="line-344"></a>
<a name="line-345"></a><a name="etaExpandProg"></a><span class='hs-definition'>etaExpandProg</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Program</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>Program</span>
<a name="line-346"></a><span class='hs-definition'>etaExpandProg</span> <span class='hs-varid'>pass</span> <span class='hs-varid'>prog</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-347"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>f</span> <span class='hs-varid'>prog</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>prog'</span> <span class='hs-layout'>{</span> <span class='hs-varid'>progStats</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>progStats</span> <span class='hs-varid'>prog</span> <span class='hs-varop'>`mappend`</span> <span class='hs-varid'>stats</span> <span class='hs-layout'>}</span> <span class='hs-keyword'>where</span>
<a name="line-348"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>prog'</span><span class='hs-layout'>,</span><span class='hs-varid'>stats</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Stats</span><span class='hs-varop'>.</span><span class='hs-varid'>runStatM</span> <span class='hs-varop'>$</span>  <span class='hs-varid'>etaExpandProgram</span> <span class='hs-varid'>prog</span>
<a name="line-349"></a>    <span class='hs-varid'>transformProgram</span> <span class='hs-varid'>transformParms</span> <span class='hs-layout'>{</span> <span class='hs-varid'>transformPass</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pass</span><span class='hs-layout'>,</span> <span class='hs-varid'>transformCategory</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>"EtaExpansion"</span>
<a name="line-350"></a>                                    <span class='hs-layout'>,</span> <span class='hs-varid'>transformDumpProgress</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>miniCorePass</span><span class='hs-layout'>,</span>  <span class='hs-varid'>transformOperation</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>evaluate</span> <span class='hs-varop'>.</span> <span class='hs-varid'>f</span> <span class='hs-layout'>}</span> <span class='hs-varid'>prog</span>
<a name="line-351"></a>
<a name="line-352"></a><a name="getExports"></a><span class='hs-definition'>getExports</span> <span class='hs-varid'>ho</span> <span class='hs-keyglyph'>=</span>  <span class='hs-conid'>Set</span><span class='hs-varop'>.</span><span class='hs-varid'>fromList</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-varid'>toId</span> <span class='hs-varop'>$</span> <span class='hs-varid'>concat</span> <span class='hs-varop'>$</span>  <span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>elems</span> <span class='hs-layout'>(</span><span class='hs-varid'>hoExports</span> <span class='hs-varid'>ho</span><span class='hs-layout'>)</span>
<a name="line-353"></a><a name="shouldBeExported"></a><span class='hs-definition'>shouldBeExported</span> <span class='hs-varid'>exports</span> <span class='hs-varid'>tvr</span>
<a name="line-354"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tvrIdent</span> <span class='hs-varid'>tvr</span> <span class='hs-varop'>`</span><span class='hs-conid'>Set</span><span class='hs-varop'>.</span><span class='hs-varid'>member</span><span class='hs-varop'>`</span> <span class='hs-varid'>exports</span> <span class='hs-varop'>||</span> <span class='hs-varid'>getProperty</span> <span class='hs-varid'>prop_SRCLOC_ANNOTATE_FUN</span> <span class='hs-varid'>tvr</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setProperty</span> <span class='hs-varid'>prop_EXPORTED</span> <span class='hs-varid'>tvr</span>
<a name="line-355"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tvr</span>
<a name="line-356"></a>
<a name="line-357"></a><a name="transTypeAnalyze"></a><span class='hs-definition'>transTypeAnalyze</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>transformParms</span> <span class='hs-layout'>{</span> <span class='hs-varid'>transformCategory</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>"typeAnalyze"</span><span class='hs-layout'>,</span>  <span class='hs-varid'>transformOperation</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>typeAnalyze</span> <span class='hs-conid'>True</span> <span class='hs-layout'>}</span>
<a name="line-358"></a>
<a name="line-359"></a><a name="simplifyProgram"></a><span class='hs-definition'>simplifyProgram</span> <span class='hs-varid'>sopt</span> <span class='hs-varid'>name</span> <span class='hs-varid'>dodump</span> <span class='hs-varid'>prog</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-360"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>istat</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>progStats</span> <span class='hs-varid'>prog</span>
<a name="line-361"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>g</span> <span class='hs-varid'>prog</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-362"></a>            <span class='hs-keyword'>let</span> <span class='hs-varid'>nprog</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SS</span><span class='hs-varop'>.</span><span class='hs-varid'>programPruneOccurance</span> <span class='hs-varid'>prog</span>
<a name="line-363"></a>            <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>corePass</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>dodump</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-364"></a>                <span class='hs-varid'>putStrLn</span> <span class='hs-str'>"-- After Occurance Analysis"</span>
<a name="line-365"></a>                <span class='hs-varid'>printProgram</span> <span class='hs-varid'>nprog</span>
<a name="line-366"></a>            <span class='hs-varid'>lintCheckProgram</span> <span class='hs-layout'>(</span><span class='hs-varid'>putErrLn</span> <span class='hs-str'>"AfterOccurance"</span><span class='hs-layout'>)</span> <span class='hs-varid'>nprog</span>
<a name="line-367"></a>            <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>SS</span><span class='hs-varop'>.</span><span class='hs-varid'>programSSimplify</span> <span class='hs-varid'>sopt</span> <span class='hs-varid'>nprog</span>
<a name="line-368"></a>    <span class='hs-varid'>prog</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>transformProgram</span> <span class='hs-varid'>transformParms</span> <span class='hs-layout'>{</span> <span class='hs-varid'>transformCategory</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>"Simplify"</span>
<a name="line-369"></a>                                            <span class='hs-layout'>,</span> <span class='hs-varid'>transformPass</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>name</span>
<a name="line-370"></a>                                            <span class='hs-layout'>,</span> <span class='hs-varid'>transformIterate</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IterateDone</span>
<a name="line-371"></a>                                            <span class='hs-layout'>,</span> <span class='hs-varid'>transformDumpProgress</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dodump</span>
<a name="line-372"></a>                                            <span class='hs-layout'>,</span> <span class='hs-varid'>transformOperation</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>g</span> <span class='hs-layout'>}</span> <span class='hs-varid'>prog</span> <span class='hs-layout'>{</span> <span class='hs-varid'>progStats</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mempty</span> <span class='hs-layout'>}</span>
<a name="line-373"></a>    <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>dodump</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-layout'>(</span><span class='hs-varid'>dump</span> <span class='hs-conid'>FD</span><span class='hs-varop'>.</span><span class='hs-conid'>Progress</span> <span class='hs-varop'>||</span> <span class='hs-varid'>coreSteps</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-374"></a>        <span class='hs-conid'>Stats</span><span class='hs-varop'>.</span><span class='hs-varid'>printLStat</span> <span class='hs-layout'>(</span><span class='hs-varid'>optStatLevel</span> <span class='hs-varid'>options</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-str'>"Total: "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>progStats</span> <span class='hs-varid'>prog</span><span class='hs-layout'>)</span>
<a name="line-375"></a>    <span class='hs-varid'>return</span> <span class='hs-varid'>prog</span> <span class='hs-layout'>{</span> <span class='hs-varid'>progStats</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>progStats</span> <span class='hs-varid'>prog</span> <span class='hs-varop'>`mappend`</span> <span class='hs-varid'>istat</span> <span class='hs-layout'>}</span>
<a name="line-376"></a>
<a name="line-377"></a><a name="simplifyProgram'"></a><span class='hs-comment'>{-
<a name="line-378"></a>simplifyProgramPStat sopt name dodump prog = do
<a name="line-379"></a>    let istat = progStats prog
<a name="line-380"></a>    let g =  SS.programSSimplifyPStat sopt { SS.so_dataTable = progDataTable prog } . SS.programPruneOccurance
<a name="line-381"></a>    prog &lt;- transformProgram ("PS:" ++ name) IterateDone dodump g prog  { progStats = mempty }
<a name="line-382"></a>    when ((dodump &amp;&amp; dump FD.Progress) || dump FD.CoreSteps) $ Stats.printStat ("Total: " ++ name) (progStats prog)
<a name="line-383"></a>    return prog { progStats = progStats prog `mappend` istat }
<a name="line-384"></a>-}</span>
<a name="line-385"></a><span class='hs-definition'>simplifyProgram'</span> <span class='hs-varid'>sopt</span> <span class='hs-varid'>name</span> <span class='hs-varid'>dodump</span> <span class='hs-varid'>iterate</span> <span class='hs-varid'>prog</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-386"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>istat</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>progStats</span> <span class='hs-varid'>prog</span>
<a name="line-387"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>g</span> <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>return</span> <span class='hs-varop'>.</span> <span class='hs-conid'>SS</span><span class='hs-varop'>.</span><span class='hs-varid'>programSSimplify</span> <span class='hs-varid'>sopt</span> <span class='hs-varop'>.</span> <span class='hs-conid'>SS</span><span class='hs-varop'>.</span><span class='hs-varid'>programPruneOccurance</span>
<a name="line-388"></a>    <span class='hs-varid'>prog</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>transformProgram</span> <span class='hs-varid'>transformParms</span> <span class='hs-layout'>{</span> <span class='hs-varid'>transformCategory</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>"Simplify"</span>
<a name="line-389"></a>                                            <span class='hs-layout'>,</span> <span class='hs-varid'>transformPass</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>name</span>
<a name="line-390"></a>                                            <span class='hs-layout'>,</span> <span class='hs-varid'>transformIterate</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>iterate</span>
<a name="line-391"></a>                                            <span class='hs-layout'>,</span> <span class='hs-varid'>transformDumpProgress</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dodump</span>
<a name="line-392"></a>                                            <span class='hs-layout'>,</span> <span class='hs-varid'>transformOperation</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>g</span> <span class='hs-layout'>}</span> <span class='hs-varid'>prog</span> <span class='hs-layout'>{</span> <span class='hs-varid'>progStats</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mempty</span> <span class='hs-layout'>}</span>
<a name="line-393"></a>    <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>dodump</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-layout'>(</span><span class='hs-varid'>dump</span> <span class='hs-conid'>FD</span><span class='hs-varop'>.</span><span class='hs-conid'>Progress</span> <span class='hs-varop'>||</span> <span class='hs-varid'>coreSteps</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Stats</span><span class='hs-varop'>.</span><span class='hs-varid'>printLStat</span> <span class='hs-layout'>(</span><span class='hs-varid'>optStatLevel</span> <span class='hs-varid'>options</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-str'>"Total: "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>progStats</span> <span class='hs-varid'>prog</span><span class='hs-layout'>)</span>
<a name="line-394"></a>    <span class='hs-varid'>return</span> <span class='hs-varid'>prog</span> <span class='hs-layout'>{</span> <span class='hs-varid'>progStats</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>progStats</span> <span class='hs-varid'>prog</span> <span class='hs-varop'>`mappend`</span> <span class='hs-varid'>istat</span> <span class='hs-layout'>}</span>
<a name="line-395"></a>
<a name="line-396"></a><a name="compileWholeProgram"></a><span class='hs-comment'>{-# NOINLINE compileWholeProgram #-}</span>
<a name="line-397"></a><span class='hs-definition'>compileWholeProgram</span> <span class='hs-varid'>prog</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-398"></a>    <span class='hs-varid'>performGC</span>
<a name="line-399"></a>
<a name="line-400"></a>    <span class='hs-varid'>when</span> <span class='hs-varid'>verbose</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-401"></a>        <span class='hs-conid'>Stats</span><span class='hs-varop'>.</span><span class='hs-varid'>print</span> <span class='hs-str'>"PassStats"</span> <span class='hs-conid'>Stats</span><span class='hs-varop'>.</span><span class='hs-varid'>theStats</span>
<a name="line-402"></a>        <span class='hs-conid'>Stats</span><span class='hs-varop'>.</span><span class='hs-varid'>clear</span> <span class='hs-conid'>Stats</span><span class='hs-varop'>.</span><span class='hs-varid'>theStats</span>
<a name="line-403"></a>
<a name="line-404"></a>    <span class='hs-varid'>esmap</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>programEsMap</span> <span class='hs-varid'>prog</span>
<a name="line-405"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>mainFunc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>parseName</span> <span class='hs-conid'>Val</span> <span class='hs-layout'>(</span><span class='hs-varid'>maybe</span> <span class='hs-str'>"Main.main"</span> <span class='hs-varid'>snd</span> <span class='hs-layout'>(</span><span class='hs-varid'>optMainFunc</span> <span class='hs-varid'>options</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-406"></a>        <span class='hs-varid'>dataTable</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>progDataTable</span> <span class='hs-varid'>prog</span>
<a name="line-407"></a>        <span class='hs-varid'>ffiExportNames</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>map</span> <span class='hs-varid'>combHead</span> <span class='hs-varop'>$</span> <span class='hs-varid'>progCombinators</span> <span class='hs-varid'>prog</span><span class='hs-layout'>,</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tvrName</span> <span class='hs-varid'>tv</span><span class='hs-layout'>,</span> <span class='hs-str'>"FE@"</span> <span class='hs-varop'>`isPrefixOf`</span> <span class='hs-varid'>show</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>]</span>
<a name="line-408"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>main</span><span class='hs-layout'>,</span><span class='hs-varid'>mainv</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getMainFunction</span> <span class='hs-varid'>dataTable</span> <span class='hs-varid'>mainFunc</span> <span class='hs-varid'>esmap</span>
<a name="line-409"></a>    <span class='hs-varid'>prog</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>programUpdate</span> <span class='hs-varid'>prog</span> <span class='hs-layout'>{</span>
<a name="line-410"></a>        <span class='hs-varid'>progMain</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tvrIdent</span> <span class='hs-varid'>main</span><span class='hs-layout'>,</span>
<a name="line-411"></a>        <span class='hs-varid'>progEntry</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fromList</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-varid'>tvrIdent</span> <span class='hs-layout'>(</span><span class='hs-varid'>main</span><span class='hs-conop'>:</span><span class='hs-varid'>ffiExportNames</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-412"></a>        <span class='hs-varid'>progCombinators</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyComb</span> <span class='hs-layout'>{</span> <span class='hs-varid'>combHead</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>main</span><span class='hs-layout'>,</span> <span class='hs-varid'>combBody</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mainv</span> <span class='hs-layout'>}</span><span class='hs-conop'>:</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>unsetProperty</span> <span class='hs-varid'>prop_EXPORTED</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>progCombinators</span> <span class='hs-varid'>prog</span><span class='hs-layout'>)</span>
<a name="line-413"></a>        <span class='hs-layout'>}</span>
<a name="line-414"></a>    <span class='hs-varid'>prog</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>transformProgram</span> <span class='hs-varid'>transformParms</span> <span class='hs-layout'>{</span>
<a name="line-415"></a>        <span class='hs-varid'>transformCategory</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>"PruneUnreachable"</span><span class='hs-layout'>,</span>
<a name="line-416"></a>        <span class='hs-varid'>transformOperation</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>evaluate</span> <span class='hs-varop'>.</span> <span class='hs-varid'>programPruneUnreachable</span>
<a name="line-417"></a>        <span class='hs-layout'>}</span> <span class='hs-varid'>prog</span>
<a name="line-418"></a>
<a name="line-419"></a>    <span class='hs-varid'>prog</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>if</span> <span class='hs-layout'>(</span><span class='hs-varid'>fopts</span> <span class='hs-conid'>FO</span><span class='hs-varop'>.</span><span class='hs-conid'>TypeAnalysis</span><span class='hs-layout'>)</span> <span class='hs-keyword'>then</span> <span class='hs-keyword'>do</span>
<a name="line-420"></a>      <span class='hs-varid'>transformProgram</span> <span class='hs-varid'>transformParms</span> <span class='hs-layout'>{</span> <span class='hs-varid'>transformCategory</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>"TypeAnalyzeMethods"</span><span class='hs-layout'>,</span>
<a name="line-421"></a>                                        <span class='hs-varid'>transformOperation</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>typeAnalyze</span> <span class='hs-conid'>False</span><span class='hs-layout'>,</span>
<a name="line-422"></a>                                        <span class='hs-varid'>transformDumpProgress</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dump</span> <span class='hs-conid'>FD</span><span class='hs-varop'>.</span><span class='hs-conid'>Progress</span> <span class='hs-layout'>}</span>
<a name="line-423"></a>                       <span class='hs-varid'>prog</span>
<a name="line-424"></a>            <span class='hs-keyword'>else</span> <span class='hs-varid'>return</span> <span class='hs-varid'>prog</span>
<a name="line-425"></a>
<a name="line-426"></a>    <span class='hs-varid'>when</span> <span class='hs-varid'>verbose</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-427"></a>        <span class='hs-varid'>putStrLn</span> <span class='hs-str'>"Type analyzed methods"</span>
<a name="line-428"></a>        <span class='hs-varid'>flip</span> <span class='hs-varid'>mapM_</span> <span class='hs-layout'>(</span><span class='hs-varid'>sortUnder</span> <span class='hs-layout'>(</span><span class='hs-varid'>show</span> <span class='hs-varop'>.</span> <span class='hs-varid'>fst</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>programDs</span> <span class='hs-varid'>prog</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-layout'>(</span><span class='hs-varid'>t</span><span class='hs-layout'>,</span><span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-429"></a>        <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-varid'>ts</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fromLam</span> <span class='hs-varid'>e</span>
<a name="line-430"></a>            <span class='hs-varid'>ts'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>takeWhile</span> <span class='hs-layout'>(</span><span class='hs-varid'>sortKindLike</span> <span class='hs-varop'>.</span> <span class='hs-varid'>getType</span><span class='hs-layout'>)</span> <span class='hs-varid'>ts</span>
<a name="line-431"></a>        <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>ts'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>putStrLn</span> <span class='hs-varop'>$</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprint</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span> <span class='hs-varop'>++</span> <span class='hs-str'>" \\"</span> <span class='hs-varop'>++</span>
<a name="line-432"></a>            <span class='hs-varid'>concat</span> <span class='hs-keyglyph'>[</span> <span class='hs-str'>"("</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span>  <span class='hs-layout'>(</span><span class='hs-conid'>Info</span><span class='hs-varop'>.</span><span class='hs-varid'>fetch</span> <span class='hs-layout'>(</span><span class='hs-varid'>tvrInfo</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Typ</span><span class='hs-layout'>)</span> <span class='hs-varop'>++</span> <span class='hs-str'>")"</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>t</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ts'</span> <span class='hs-keyglyph'>]</span>
<a name="line-433"></a>    <span class='hs-varid'>lintCheckProgram</span> <span class='hs-varid'>onerrNone</span> <span class='hs-varid'>prog</span>
<a name="line-434"></a>    <span class='hs-varid'>prog</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>programPrune</span> <span class='hs-varid'>prog</span>
<a name="line-435"></a>
<a name="line-436"></a>    <span class='hs-varid'>cmethods</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>do</span>
<a name="line-437"></a>        <span class='hs-keyword'>let</span> <span class='hs-varid'>es'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>concatMap</span> <span class='hs-varid'>expandPlaceholder</span> <span class='hs-layout'>(</span><span class='hs-varid'>progCombinators</span> <span class='hs-varid'>prog</span><span class='hs-layout'>)</span>
<a name="line-438"></a>        <span class='hs-varid'>es'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>return</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>combBody_u</span> <span class='hs-varid'>floatInward</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>|</span>  <span class='hs-varid'>e</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>es'</span> <span class='hs-keyglyph'>]</span>
<a name="line-439"></a>        <span class='hs-varid'>wdump</span> <span class='hs-conid'>FD</span><span class='hs-varop'>.</span><span class='hs-conid'>Class</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-440"></a>            <span class='hs-varid'>sequence_</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>printCheckName''</span> <span class='hs-varid'>dataTable</span> <span class='hs-layout'>(</span><span class='hs-varid'>combHead</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>combBody</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span>  <span class='hs-varid'>x</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>es'</span><span class='hs-keyglyph'>]</span>
<a name="line-441"></a>        <span class='hs-varid'>return</span> <span class='hs-varid'>es'</span>
<a name="line-442"></a>
<a name="line-443"></a>    <span class='hs-varid'>prog</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>evaluate</span> <span class='hs-varop'>$</span> <span class='hs-varid'>progCombinators_s</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span> <span class='hs-varid'>p</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>p</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>progCombinators</span> <span class='hs-varid'>prog</span><span class='hs-layout'>,</span>
<a name="line-444"></a>        <span class='hs-varid'>combHead</span> <span class='hs-varid'>p</span> <span class='hs-varop'>`notElem`</span> <span class='hs-varid'>map</span> <span class='hs-varid'>combHead</span> <span class='hs-varid'>cmethods</span><span class='hs-keyglyph'>]</span> <span class='hs-varop'>++</span> <span class='hs-varid'>cmethods</span><span class='hs-layout'>)</span> <span class='hs-varid'>prog</span>
<a name="line-445"></a>    <span class='hs-varid'>prog</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>annotateProgram</span> <span class='hs-varid'>mempty</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-varid'>nfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>unsetProperty</span> <span class='hs-varid'>prop_INSTANCE</span> <span class='hs-varid'>nfo</span><span class='hs-layout'>)</span>
<a name="line-446"></a>        <span class='hs-varid'>letann</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-varid'>nfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>nfo</span><span class='hs-layout'>)</span> <span class='hs-varid'>prog</span>
<a name="line-447"></a>
<a name="line-448"></a>    <span class='hs-keyword'>if</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>fopts</span> <span class='hs-conid'>FO</span><span class='hs-varop'>.</span><span class='hs-conid'>GlobalOptimize</span><span class='hs-layout'>)</span> <span class='hs-keyword'>then</span> <span class='hs-keyword'>do</span>
<a name="line-449"></a>        <span class='hs-varid'>prog</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>programPrune</span> <span class='hs-varid'>prog</span>
<a name="line-450"></a>        <span class='hs-varid'>wdump</span> <span class='hs-conid'>FD</span><span class='hs-varop'>.</span><span class='hs-conid'>CoreBeforelift</span> <span class='hs-varop'>$</span> <span class='hs-varid'>printProgram</span> <span class='hs-varid'>prog</span>
<a name="line-451"></a>        <span class='hs-varid'>prog</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>transformProgram</span> <span class='hs-varid'>transformParms</span> <span class='hs-layout'>{</span>
<a name="line-452"></a>            <span class='hs-varid'>transformCategory</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>"LambdaLift"</span><span class='hs-layout'>,</span>
<a name="line-453"></a>            <span class='hs-varid'>transformDumpProgress</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dump</span> <span class='hs-conid'>FD</span><span class='hs-varop'>.</span><span class='hs-conid'>Progress</span><span class='hs-layout'>,</span>
<a name="line-454"></a>            <span class='hs-varid'>transformOperation</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lambdaLift</span> <span class='hs-layout'>}</span> <span class='hs-varid'>prog</span>
<a name="line-455"></a>        <span class='hs-varid'>wdump</span> <span class='hs-conid'>FD</span><span class='hs-varop'>.</span><span class='hs-conid'>CoreAfterlift</span> <span class='hs-varop'>$</span> <span class='hs-varid'>printProgram</span> <span class='hs-varid'>prog</span>
<a name="line-456"></a>        <span class='hs-varid'>prog</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>atomizeApps</span> <span class='hs-conid'>True</span> <span class='hs-varid'>prog</span>
<a name="line-457"></a>        <span class='hs-varid'>wdump</span> <span class='hs-conid'>FD</span><span class='hs-varop'>.</span><span class='hs-conid'>CoreMangled</span> <span class='hs-varop'>$</span> <span class='hs-varid'>dumpCore</span> <span class='hs-str'>"mangled"</span> <span class='hs-varid'>prog</span>
<a name="line-458"></a>        <span class='hs-varid'>return</span> <span class='hs-varid'>prog</span>
<a name="line-459"></a>     <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span>
<a name="line-460"></a>    <span class='hs-varid'>prog</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>transformProgram</span> <span class='hs-varid'>transTypeAnalyze</span> <span class='hs-layout'>{</span>
<a name="line-461"></a>        <span class='hs-varid'>transformPass</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>"Main-AfterMethod"</span><span class='hs-layout'>,</span>
<a name="line-462"></a>        <span class='hs-varid'>transformDumpProgress</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>verbose</span> <span class='hs-layout'>}</span> <span class='hs-varid'>prog</span>
<a name="line-463"></a>    <span class='hs-varid'>prog</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>simplifyProgram</span> <span class='hs-conid'>SS</span><span class='hs-varop'>.</span><span class='hs-varid'>emptySimplifyOpts</span> <span class='hs-str'>"Main-One"</span> <span class='hs-varid'>verbose</span> <span class='hs-varid'>prog</span>
<a name="line-464"></a>    <span class='hs-varid'>prog</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>etaExpandProg</span> <span class='hs-str'>"Main-AfterOne"</span> <span class='hs-varid'>prog</span>
<a name="line-465"></a>    <span class='hs-varid'>wdump</span> <span class='hs-conid'>FD</span><span class='hs-varop'>.</span><span class='hs-conid'>CorePass</span> <span class='hs-varop'>$</span> <span class='hs-varid'>dumpCore</span> <span class='hs-str'>"before-TypeAnalyze-Main-AfterSimp"</span> <span class='hs-varid'>prog</span>
<a name="line-466"></a>    <span class='hs-varid'>prog</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>transformProgram</span> <span class='hs-varid'>transTypeAnalyze</span> <span class='hs-layout'>{</span>
<a name="line-467"></a>        <span class='hs-varid'>transformPass</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>"Main-AfterSimp"</span><span class='hs-layout'>,</span> <span class='hs-varid'>transformDumpProgress</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>verbose</span> <span class='hs-layout'>}</span> <span class='hs-varid'>prog</span>
<a name="line-468"></a>    <span class='hs-varid'>prog</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>simplifyProgram</span> <span class='hs-conid'>SS</span><span class='hs-varop'>.</span><span class='hs-varid'>emptySimplifyOpts</span> <span class='hs-str'>"Main-Two"</span> <span class='hs-varid'>verbose</span> <span class='hs-varid'>prog</span>
<a name="line-469"></a>
<a name="line-470"></a>    <span class='hs-comment'>-- run optimization again with no rules enabled</span>
<a name="line-471"></a>    <span class='hs-varid'>prog</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>runIdentity</span> <span class='hs-varop'>$</span> <span class='hs-varid'>annotateProgram</span> <span class='hs-varid'>mempty</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-varid'>nfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span>
<a name="line-472"></a>        <span class='hs-varid'>modifyProperties</span> <span class='hs-layout'>(</span><span class='hs-varid'>flip</span> <span class='hs-layout'>(</span><span class='hs-varid'>foldr</span> <span class='hs-conid'>S</span><span class='hs-varop'>.</span><span class='hs-varid'>delete</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>prop_HASRULE</span><span class='hs-layout'>,</span><span class='hs-varid'>prop_WORKER</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-varid'>nfo</span><span class='hs-layout'>)</span>
<a name="line-473"></a>        <span class='hs-varid'>letann</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span><span class='hs-layout'>)</span> <span class='hs-varid'>prog</span>
<a name="line-474"></a>    <span class='hs-comment'>--prog &lt;- transformProgram "float inward" DontIterate True programFloatInward prog</span>
<a name="line-475"></a>
<a name="line-476"></a>    <span class='hs-varid'>prog</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>simplifyProgram</span> <span class='hs-conid'>SS</span><span class='hs-varop'>.</span><span class='hs-varid'>emptySimplifyOpts</span> <span class='hs-layout'>{</span> <span class='hs-conid'>SS</span><span class='hs-varop'>.</span><span class='hs-varid'>so_finalPhase</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span> <span class='hs-layout'>}</span>
<a name="line-477"></a>        <span class='hs-str'>"SuperSimplify no rules"</span> <span class='hs-varid'>verbose</span> <span class='hs-varid'>prog</span>
<a name="line-478"></a>
<a name="line-479"></a>    <span class='hs-comment'>-- We should float inward right before lambda lifting so that when a case statement is lifted out, it takes any local definitions with it.</span>
<a name="line-480"></a><span class='hs-comment'>--    prog &lt;- transformProgram transformParms {</span>
<a name="line-481"></a><span class='hs-comment'>--        transformCategory = "FloatInward",</span>
<a name="line-482"></a><span class='hs-comment'>--        transformDumpProgress = dump FD.Progress,</span>
<a name="line-483"></a><span class='hs-comment'>--        transformOperation = programFloatInward</span>
<a name="line-484"></a><span class='hs-comment'>--        } prog</span>
<a name="line-485"></a>    <span class='hs-comment'>-- perform lambda lifting</span>
<a name="line-486"></a><span class='hs-comment'>--    prog &lt;- denewtypeProgram prog</span>
<a name="line-487"></a>
<a name="line-488"></a>    <span class='hs-varid'>prog</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>transformProgram</span> <span class='hs-varid'>transformParms</span> <span class='hs-layout'>{</span>
<a name="line-489"></a>        <span class='hs-varid'>transformCategory</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>"BoxifyProgram"</span><span class='hs-layout'>,</span>
<a name="line-490"></a>        <span class='hs-varid'>transformDumpProgress</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dump</span> <span class='hs-conid'>FD</span><span class='hs-varop'>.</span><span class='hs-conid'>Progress</span><span class='hs-layout'>,</span>
<a name="line-491"></a>        <span class='hs-varid'>transformOperation</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>boxifyProgram</span> <span class='hs-layout'>}</span> <span class='hs-varid'>prog</span>
<a name="line-492"></a>    <span class='hs-varid'>prog</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>programPrune</span> <span class='hs-varid'>prog</span>
<a name="line-493"></a>
<a name="line-494"></a>    <span class='hs-varid'>prog</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>Demand</span><span class='hs-varop'>.</span><span class='hs-varid'>analyzeProgram</span> <span class='hs-varid'>prog</span>
<a name="line-495"></a>    <span class='hs-varid'>prog</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>E</span><span class='hs-varop'>.</span><span class='hs-conid'>CPR</span><span class='hs-varop'>.</span><span class='hs-varid'>cprAnalyzeProgram</span> <span class='hs-varid'>prog</span>
<a name="line-496"></a>    <span class='hs-varid'>prog</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>transformProgram</span> <span class='hs-varid'>transformParms</span> <span class='hs-layout'>{</span>
<a name="line-497"></a>        <span class='hs-varid'>transformCategory</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>"Boxy WorkWrap"</span><span class='hs-layout'>,</span>
<a name="line-498"></a>        <span class='hs-varid'>transformDumpProgress</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dump</span> <span class='hs-conid'>FD</span><span class='hs-varop'>.</span><span class='hs-conid'>Progress</span><span class='hs-layout'>,</span>
<a name="line-499"></a>        <span class='hs-varid'>transformOperation</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>evaluate</span> <span class='hs-varop'>.</span> <span class='hs-varid'>workWrapProgram</span> <span class='hs-layout'>}</span> <span class='hs-varid'>prog</span>
<a name="line-500"></a>    <span class='hs-varid'>prog</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>simplifyProgram</span> <span class='hs-conid'>SS</span><span class='hs-varop'>.</span><span class='hs-varid'>emptySimplifyOpts</span> <span class='hs-layout'>{</span> <span class='hs-conid'>SS</span><span class='hs-varop'>.</span><span class='hs-varid'>so_finalPhase</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span> <span class='hs-layout'>}</span>
<a name="line-501"></a>        <span class='hs-str'>"SuperSimplify after Boxy WorkWrap"</span> <span class='hs-varid'>verbose</span> <span class='hs-varid'>prog</span>
<a name="line-502"></a>    <span class='hs-varid'>prog</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>runIdentity</span> <span class='hs-varop'>$</span> <span class='hs-varid'>programMapBodies</span> <span class='hs-layout'>(</span><span class='hs-varid'>return</span> <span class='hs-varop'>.</span> <span class='hs-varid'>cleanupE</span><span class='hs-layout'>)</span> <span class='hs-varid'>prog</span>
<a name="line-503"></a>
<a name="line-504"></a>    <span class='hs-varid'>wdump</span> <span class='hs-conid'>FD</span><span class='hs-varop'>.</span><span class='hs-conid'>CoreBeforelift</span> <span class='hs-varop'>$</span> <span class='hs-varid'>dumpCore</span> <span class='hs-str'>"before-lift"</span> <span class='hs-varid'>prog</span>
<a name="line-505"></a>    <span class='hs-varid'>prog</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>transformProgram</span> <span class='hs-varid'>transformParms</span> <span class='hs-layout'>{</span>
<a name="line-506"></a>        <span class='hs-varid'>transformCategory</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>"LambdaLift"</span><span class='hs-layout'>,</span>
<a name="line-507"></a>        <span class='hs-varid'>transformDumpProgress</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dump</span> <span class='hs-conid'>FD</span><span class='hs-varop'>.</span><span class='hs-conid'>Progress</span><span class='hs-layout'>,</span>
<a name="line-508"></a>        <span class='hs-varid'>transformOperation</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lambdaLift</span> <span class='hs-layout'>}</span> <span class='hs-varid'>prog</span>
<a name="line-509"></a>
<a name="line-510"></a>    <span class='hs-varid'>wdump</span> <span class='hs-conid'>FD</span><span class='hs-varop'>.</span><span class='hs-conid'>CoreAfterlift</span> <span class='hs-varop'>$</span> <span class='hs-varid'>dumpCore</span> <span class='hs-str'>"after-lift"</span> <span class='hs-varid'>prog</span>
<a name="line-511"></a>
<a name="line-512"></a>    <span class='hs-varid'>finalStats</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>Stats</span><span class='hs-varop'>.</span><span class='hs-varid'>new</span>
<a name="line-513"></a>
<a name="line-514"></a>    <span class='hs-comment'>-- final optimization pass to clean up lambda lifting droppings</span>
<a name="line-515"></a><span class='hs-comment'>--    prog &lt;- flip programMapBodies prog $ \ e -&gt; do</span>
<a name="line-516"></a><span class='hs-comment'>--        let cm stats e = do</span>
<a name="line-517"></a><span class='hs-comment'>--            let sopt = mempty {  SS.so_dataTable = dataTable }</span>
<a name="line-518"></a><span class='hs-comment'>--            let (stat, e') = SS.simplifyE sopt e</span>
<a name="line-519"></a><span class='hs-comment'>--            Stats.tickStat stats stat</span>
<a name="line-520"></a><span class='hs-comment'>--            return e'</span>
<a name="line-521"></a><span class='hs-comment'>--        doopt (mangle' Nothing dataTable) False finalStats "PostLambdaLift"  cm e</span>
<a name="line-522"></a><span class='hs-comment'>--    wdump FD.Progress $ Stats.print "PostLifting" finalStats</span>
<a name="line-523"></a>
<a name="line-524"></a>    <span class='hs-varid'>lintCheckProgram</span> <span class='hs-layout'>(</span><span class='hs-varid'>putErrLn</span> <span class='hs-str'>"LintPostLifting"</span><span class='hs-layout'>)</span> <span class='hs-varid'>prog</span>
<a name="line-525"></a>
<a name="line-526"></a><span class='hs-comment'>--    wdump FD.Progress $ printEStats (programE prog)</span>
<a name="line-527"></a>
<a name="line-528"></a>    <span class='hs-varid'>prog</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>Demand</span><span class='hs-varop'>.</span><span class='hs-varid'>analyzeProgram</span> <span class='hs-varid'>prog</span>
<a name="line-529"></a>    <span class='hs-varid'>prog</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>E</span><span class='hs-varop'>.</span><span class='hs-conid'>CPR</span><span class='hs-varop'>.</span><span class='hs-varid'>cprAnalyzeProgram</span> <span class='hs-varid'>prog</span>
<a name="line-530"></a>    <span class='hs-varid'>prog</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>simplifyProgram</span> <span class='hs-conid'>SS</span><span class='hs-varop'>.</span><span class='hs-varid'>emptySimplifyOpts</span> <span class='hs-layout'>{</span>
<a name="line-531"></a>        <span class='hs-conid'>SS</span><span class='hs-varop'>.</span><span class='hs-varid'>so_postLift</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span><span class='hs-layout'>,</span> <span class='hs-conid'>SS</span><span class='hs-varop'>.</span><span class='hs-varid'>so_finalPhase</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span> <span class='hs-layout'>}</span> <span class='hs-str'>"PostLiftSimplify"</span> <span class='hs-varid'>verbose</span> <span class='hs-varid'>prog</span>
<a name="line-532"></a><span class='hs-comment'>--    prog &lt;- programFloatInward prog</span>
<a name="line-533"></a>
<a name="line-534"></a>    <span class='hs-varid'>when</span> <span class='hs-varid'>verbose</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-535"></a>        <span class='hs-conid'>Stats</span><span class='hs-varop'>.</span><span class='hs-varid'>print</span> <span class='hs-str'>"PassStats"</span> <span class='hs-conid'>Stats</span><span class='hs-varop'>.</span><span class='hs-varid'>theStats</span>
<a name="line-536"></a>        <span class='hs-conid'>Stats</span><span class='hs-varop'>.</span><span class='hs-varid'>clear</span> <span class='hs-conid'>Stats</span><span class='hs-varop'>.</span><span class='hs-varid'>theStats</span>
<a name="line-537"></a>
<a name="line-538"></a>    <span class='hs-varid'>prog</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>atomizeApps</span> <span class='hs-conid'>True</span> <span class='hs-varid'>prog</span>
<a name="line-539"></a>    <span class='hs-varid'>wdump</span> <span class='hs-conid'>FD</span><span class='hs-varop'>.</span><span class='hs-conid'>CoreMangled</span> <span class='hs-varop'>$</span> <span class='hs-varid'>dumpCore</span> <span class='hs-str'>"mangled"</span> <span class='hs-varid'>prog</span>
<a name="line-540"></a>    <span class='hs-varid'>return</span> <span class='hs-varid'>prog</span>
<a name="line-541"></a>
<a name="line-542"></a><span class='hs-comment'>-- | this gets rid of all type variables, replacing them with boxes that can hold any type.</span>
<a name="line-543"></a><span class='hs-comment'>-- The program is still type-safe, but all polymorphism has been removed in favor of</span>
<a name="line-544"></a><span class='hs-comment'>-- implicit coercion to a universal type in preparation for the grin transformation.</span>
<a name="line-545"></a>
<a name="line-546"></a><a name="boxifyProgram"></a><span class='hs-definition'>boxifyProgram</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Program</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>Program</span>
<a name="line-547"></a><span class='hs-definition'>boxifyProgram</span> <span class='hs-varid'>prog</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ans</span> <span class='hs-keyword'>where</span>
<a name="line-548"></a>    <span class='hs-varid'>ans</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>programMapDs</span> <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-varid'>progCombinators_u</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varop'>$</span> <span class='hs-varid'>combRules_s</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-varid'>prog</span><span class='hs-layout'>)</span>
<a name="line-549"></a>    <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-varid'>t</span><span class='hs-layout'>,</span><span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-550"></a>        <span class='hs-varid'>e</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>runReader</span> <span class='hs-layout'>(</span><span class='hs-varid'>g</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-conid'>Set</span><span class='hs-varop'>.</span><span class='hs-varid'>empty</span>
<a name="line-551"></a>        <span class='hs-varid'>tt</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>runReader</span> <span class='hs-layout'>(</span><span class='hs-varid'>boxify</span> <span class='hs-layout'>(</span><span class='hs-varid'>tvrType</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-conid'>Set</span><span class='hs-varop'>.</span><span class='hs-varid'>empty</span>
<a name="line-552"></a>        <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>t</span> <span class='hs-layout'>{</span><span class='hs-varid'>tvrType</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tt</span><span class='hs-layout'>}</span><span class='hs-layout'>,</span><span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-553"></a>    <span class='hs-sel'>_tv</span> <span class='hs-varid'>t</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>t</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tvrType</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>boxify</span> <span class='hs-layout'>(</span><span class='hs-varid'>tvrType</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-554"></a>    <span class='hs-varid'>g</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-555"></a>        <span class='hs-varid'>emapEG</span> <span class='hs-varid'>g</span> <span class='hs-layout'>(</span><span class='hs-varid'>boxify</span><span class='hs-layout'>)</span> <span class='hs-varid'>e</span> <span class='hs-comment'>-- (\e -&gt; do putStrLn ("box: " ++ pprint e) ; return $ boxify e) e</span>
<a name="line-556"></a><span class='hs-comment'>--    boxify t | Just e &lt;- followAlias (progDataTable prog) t = boxify e</span>
<a name="line-557"></a>    <span class='hs-varid'>boxify</span> <span class='hs-layout'>(</span><span class='hs-varid'>from_unsafeCoerce</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>e</span><span class='hs-layout'>,</span><span class='hs-varid'>t</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-558"></a>        <span class='hs-varid'>t'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>boxify</span> <span class='hs-varid'>t</span>
<a name="line-559"></a>        <span class='hs-varid'>e'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>boxify</span> <span class='hs-varid'>e</span>
<a name="line-560"></a>        <span class='hs-keyword'>case</span> <span class='hs-varid'>typesCompatable</span> <span class='hs-varid'>t'</span> <span class='hs-layout'>(</span><span class='hs-varid'>getType</span> <span class='hs-varid'>e'</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-561"></a>            <span class='hs-conid'>Just</span> <span class='hs-conid'>()</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>e</span>
<a name="line-562"></a>            <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>prim_unsafeCoerce</span> <span class='hs-varid'>e'</span> <span class='hs-varid'>t'</span>
<a name="line-563"></a>    <span class='hs-varid'>boxify</span> <span class='hs-layout'>(</span><span class='hs-conid'>EPi</span> <span class='hs-varid'>t</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>local</span> <span class='hs-layout'>(</span><span class='hs-conid'>Set</span><span class='hs-varop'>.</span><span class='hs-varid'>insert</span> <span class='hs-layout'>(</span><span class='hs-varid'>tvrIdent</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-564"></a>        <span class='hs-varid'>nt</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>boxify</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tvrType</span> <span class='hs-varid'>t</span>
<a name="line-565"></a>        <span class='hs-varid'>ne</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>boxify</span> <span class='hs-varid'>e</span>
<a name="line-566"></a>        <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>EPi</span> <span class='hs-varid'>t</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tvrType</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nt</span> <span class='hs-layout'>}</span> <span class='hs-varid'>ne</span>
<a name="line-567"></a>    <span class='hs-varid'>boxify</span> <span class='hs-varid'>v</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>EVar</span> <span class='hs-varid'>vr</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>canBeBox</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-568"></a>        <span class='hs-varid'>s</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ask</span>
<a name="line-569"></a>        <span class='hs-keyword'>if</span> <span class='hs-varid'>tvrIdent</span> <span class='hs-varid'>vr</span> <span class='hs-varop'>`</span><span class='hs-conid'>Set</span><span class='hs-varop'>.</span><span class='hs-varid'>member</span><span class='hs-varop'>`</span> <span class='hs-varid'>s</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-varid'>v</span> <span class='hs-keyword'>else</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mktBox</span> <span class='hs-layout'>(</span><span class='hs-varid'>tvrType</span> <span class='hs-varid'>vr</span><span class='hs-layout'>)</span>
<a name="line-570"></a>    <span class='hs-varid'>boxify</span> <span class='hs-layout'>(</span><span class='hs-conid'>ELit</span> <span class='hs-varid'>lc</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-571"></a>        <span class='hs-varid'>na</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>boxify</span> <span class='hs-layout'>(</span><span class='hs-varid'>litArgs</span> <span class='hs-varid'>lc</span><span class='hs-layout'>)</span>
<a name="line-572"></a>        <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>ELit</span> <span class='hs-varid'>lc</span> <span class='hs-layout'>{</span> <span class='hs-varid'>litArgs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>na</span> <span class='hs-layout'>}</span>
<a name="line-573"></a><span class='hs-comment'>--    boxify v@(EAp _ _) | canBeBox v = mktBox (getType v)</span>
<a name="line-574"></a><span class='hs-comment'>--    boxify (EAp (ELam t b) e) = boxify (subst t e b)</span>
<a name="line-575"></a> <span class='hs-comment'>--   boxify (EAp a b) = EAp (boxify a) b -- TODO there should be no applications at the type level by now (boxify b)</span>
<a name="line-576"></a>    <span class='hs-varid'>boxify</span> <span class='hs-layout'>(</span><span class='hs-conid'>EAp</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liftM2</span> <span class='hs-varid'>eAp</span> <span class='hs-layout'>(</span><span class='hs-varid'>boxify</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>boxify</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>
<a name="line-577"></a>    <span class='hs-varid'>boxify</span> <span class='hs-varid'>s</span><span class='hs-keyglyph'>@</span><span class='hs-conid'>ESort</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>s</span>
<a name="line-578"></a>    <span class='hs-varid'>boxify</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>error</span> <span class='hs-varop'>$</span> <span class='hs-str'>"boxify: "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>x</span>
<a name="line-579"></a>
<a name="line-580"></a><a name="cleanupE"></a><span class='hs-comment'>-- | get rid of unused bindings</span>
<a name="line-581"></a><span class='hs-definition'>cleanupE</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>E</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>E</span>
<a name="line-582"></a><span class='hs-definition'>cleanupE</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runIdentity</span> <span class='hs-layout'>(</span><span class='hs-varid'>f</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-583"></a>    <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-conid'>ELam</span> <span class='hs-varid'>t</span><span class='hs-keyglyph'>@</span><span class='hs-conid'>TVr</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tvrIdent</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>v</span> <span class='hs-layout'>}</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>v</span> <span class='hs-varop'>/=</span> <span class='hs-varid'>emptyId</span><span class='hs-layout'>,</span> <span class='hs-varid'>v</span> <span class='hs-varop'>`notMember`</span> <span class='hs-varid'>freeIds</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-conid'>ELam</span> <span class='hs-varid'>t</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tvrIdent</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyId</span> <span class='hs-layout'>}</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-584"></a>    <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-conid'>EPi</span> <span class='hs-varid'>t</span><span class='hs-keyglyph'>@</span><span class='hs-conid'>TVr</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tvrIdent</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>v</span> <span class='hs-layout'>}</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>v</span> <span class='hs-varop'>/=</span> <span class='hs-varid'>emptyId</span><span class='hs-layout'>,</span> <span class='hs-varid'>v</span> <span class='hs-varop'>`notMember`</span> <span class='hs-varid'>freeIds</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-conid'>EPi</span> <span class='hs-varid'>t</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tvrIdent</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyId</span> <span class='hs-layout'>}</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-585"></a>    <span class='hs-varid'>f</span> <span class='hs-varid'>ec</span><span class='hs-keyglyph'>@</span><span class='hs-conid'>ECase</span> <span class='hs-layout'>{</span> <span class='hs-varid'>eCaseBind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>t</span><span class='hs-keyglyph'>@</span><span class='hs-conid'>TVr</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tvrIdent</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>v</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>v</span> <span class='hs-varop'>/=</span> <span class='hs-varid'>emptyId</span><span class='hs-layout'>,</span> <span class='hs-varid'>v</span> <span class='hs-varop'>`notMember`</span> <span class='hs-layout'>(</span><span class='hs-varid'>freeVars</span> <span class='hs-layout'>(</span><span class='hs-varid'>caseBodies</span> <span class='hs-varid'>ec</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>::</span><span class='hs-conid'>IdSet</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>f</span> <span class='hs-varid'>ec</span> <span class='hs-layout'>{</span> <span class='hs-varid'>eCaseBind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>t</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tvrIdent</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyId</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-586"></a>    <span class='hs-varid'>f</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emapEG</span> <span class='hs-varid'>f</span> <span class='hs-varid'>f</span> <span class='hs-varid'>e</span>
</pre></body>
</html>
