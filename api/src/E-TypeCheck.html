<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>drift_processed/E/TypeCheck.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>{- Generated by DrIFT (Automatic class derivations for Haskell) -}</span>
<a name="line-2"></a><span class='hs-comment'>{-# LINE 1 "src/E/TypeCheck.hs" #-}</span>
<a name="line-3"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>E</span><span class='hs-varop'>.</span><span class='hs-conid'>TypeCheck</span><span class='hs-layout'>(</span>
<a name="line-4"></a>    <span class='hs-varid'>canBeBox</span><span class='hs-layout'>,</span>
<a name="line-5"></a>    <span class='hs-varid'>eAp</span><span class='hs-layout'>,</span>
<a name="line-6"></a>    <span class='hs-varid'>inferType</span><span class='hs-layout'>,</span>
<a name="line-7"></a>    <span class='hs-varid'>infertype</span><span class='hs-layout'>,</span>
<a name="line-8"></a>    <span class='hs-varid'>typecheck</span><span class='hs-layout'>,</span>
<a name="line-9"></a>    <span class='hs-varid'>match</span><span class='hs-layout'>,</span>
<a name="line-10"></a>    <span class='hs-varid'>sortSortLike</span><span class='hs-layout'>,</span>
<a name="line-11"></a>    <span class='hs-varid'>sortKindLike</span><span class='hs-layout'>,</span>
<a name="line-12"></a>    <span class='hs-varid'>sortTermLike</span><span class='hs-layout'>,</span>
<a name="line-13"></a>    <span class='hs-varid'>sortTypeLike</span><span class='hs-layout'>,</span>
<a name="line-14"></a>    <span class='hs-varid'>typeInfer</span><span class='hs-layout'>,</span>
<a name="line-15"></a>    <span class='hs-varid'>typeInfer'</span>
<a name="line-16"></a>    <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-17"></a>
<a name="line-18"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span><span class='hs-varop'>.</span><span class='hs-conid'>Reader</span>
<a name="line-19"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span><span class='hs-varop'>.</span><span class='hs-conid'>Writer</span>
<a name="line-20"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Map</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>Map</span>
<a name="line-21"></a>
<a name="line-22"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Doc</span><span class='hs-varop'>.</span><span class='hs-conid'>DocLike</span>
<a name="line-23"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Doc</span><span class='hs-varop'>.</span><span class='hs-conid'>PPrint</span>
<a name="line-24"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Doc</span><span class='hs-varop'>.</span><span class='hs-conid'>Pretty</span>
<a name="line-25"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>E</span><span class='hs-varop'>.</span><span class='hs-conid'>E</span>
<a name="line-26"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>E</span><span class='hs-varop'>.</span><span class='hs-conid'>Eval</span><span class='hs-layout'>(</span><span class='hs-varid'>strong</span><span class='hs-layout'>)</span>
<a name="line-27"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>E</span><span class='hs-varop'>.</span><span class='hs-conid'>Subst</span>
<a name="line-28"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GenUtil</span>
<a name="line-29"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Name</span><span class='hs-varop'>.</span><span class='hs-conid'>Id</span>
<a name="line-30"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Name</span><span class='hs-varop'>.</span><span class='hs-conid'>Name</span>
<a name="line-31"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Name</span><span class='hs-varop'>.</span><span class='hs-conid'>Names</span>
<a name="line-32"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Support</span><span class='hs-varop'>.</span><span class='hs-conid'>CanType</span>
<a name="line-33"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span><span class='hs-varop'>.</span><span class='hs-conid'>ContextMonad</span>
<a name="line-34"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span><span class='hs-varop'>.</span><span class='hs-conid'>SetLike</span>
<a name="line-35"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Util</span><span class='hs-varop'>.</span><span class='hs-conid'>Seq</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>Seq</span>
<a name="line-36"></a><span class='hs-keyword'>import</span> <span class='hs-comment'>{-# SOURCE #-}</span> <span class='hs-conid'>DataConstructors</span>
<a name="line-37"></a><span class='hs-keyword'>import</span> <span class='hs-comment'>{-# SOURCE #-}</span> <span class='hs-conid'>E</span><span class='hs-varop'>.</span><span class='hs-conid'>Show</span>
<a name="line-38"></a>
<a name="line-39"></a><span class='hs-comment'>{-@Internals
<a name="line-40"></a>
<a name="line-41"></a># Ajhc Core Type System
<a name="line-42"></a>
<a name="line-43"></a>Ajhc's core is based on a pure type system. A pure type system (also called a
<a name="line-44"></a>PTS) is actually a parameterized set of type systems. Ajhc's version is
<a name="line-45"></a>described by the following.
<a name="line-46"></a>
<a name="line-47"></a>    Sorts  = (*, !, **, #, (#), ##, □)
<a name="line-48"></a>    Axioms = (*:**, #:##, !:**, **:□, ##:□)
<a name="line-49"></a>
<a name="line-50"></a>    -- sort kind
<a name="line-51"></a>    *   is the kind of boxed values
<a name="line-52"></a>    !   is the kind of boxed strict values
<a name="line-53"></a>    #   is the kind of unboxed values
<a name="line-54"></a>    (#) is the kind of unboxed tuples
<a name="line-55"></a>    -- sort superkind
<a name="line-56"></a>    **  is the superkind of all boxed value
<a name="line-57"></a>    ##  is the superkind of all unboxed values
<a name="line-58"></a>    -- sort box
<a name="line-59"></a>    □   superkinds inhabit this
<a name="line-60"></a>
<a name="line-61"></a>    in addition there exist user defined kinds, which are always of supersort ##
<a name="line-62"></a>
<a name="line-63"></a>The following Rules table shows what sort of abstractions are allowed, a rule
<a name="line-64"></a>of the form (A,B,C) means you can have functions of things of sort A to things
<a name="line-65"></a>of sort B and the result is something of sort C. _Function_ in this context
<a name="line-66"></a>subsumes both term and type level abstractions.
<a name="line-67"></a>
<a name="line-68"></a>Notice that functions are always boxed, but may be strict if they take an
<a name="line-69"></a>unboxed tuple as an argument.  When a function is strict it means that it is
<a name="line-70"></a>represented by a pointer to code directly, it cannot be a suspended value that
<a name="line-71"></a>evaluates to a function.
<a name="line-72"></a>
<a name="line-73"></a>These type system rules apply to lambda abstractions. It is possible that data
<a name="line-74"></a>constructors might exist that cannot be given a type on their own with these
<a name="line-75"></a>rules, even though when fully applied it has a well formed type. An example
<a name="line-76"></a>would be unboxed tuples. This presents no difficulty as one concludes correctly
<a name="line-77"></a>that it is a type error for these constructors to ever appear when not fully
<a name="line-78"></a>saturated with arguments.
<a name="line-79"></a>
<a name="line-80"></a>    as a shortcut we will use *# to mean every combination involving * and #, and so forth.
<a name="line-81"></a>    for instance, (*#,*#,*) means the set (*,*,*) (#,*,*) (*,#,*) (#,#,*)
<a name="line-82"></a>
<a name="line-83"></a>    Rules =
<a name="line-84"></a>       (*#!,*#!,*)  -- functions from values to values are boxed and lazy
<a name="line-85"></a>       (*#!,(#),*)  -- functions from values to unboxed tuples are boxed and lazy
<a name="line-86"></a>       ((#),*#!,!)  -- functions from unboxed tuples to values are boxed and strict
<a name="line-87"></a>       ((#),(#),!)  -- functions from unboxed tuples to unboxed tuples are boxed and strict
<a name="line-88"></a>       (**,*,*)     -- may have a function from an unboxed type to a value
<a name="line-89"></a>       (**,#,*)
<a name="line-90"></a>       (**,!,*)
<a name="line-91"></a>       (**,**,**)  -- we have functions from types to types
<a name="line-92"></a>       (**,##,##)  -- MutArray_ :: * -&gt; #
<a name="line-93"></a>       (##,##,##)  -- Complex_ :: # -&gt; #
<a name="line-94"></a>
<a name="line-95"></a>    The defining feature of boxed values is
<a name="line-96"></a>
<a name="line-97"></a>    _|_ :: t iff t::*
<a name="line-98"></a>
<a name="line-99"></a>    This PTS is functional but not injective
<a name="line-100"></a>
<a name="line-101"></a>The PTS can be considered stratified into the following levels
<a name="line-102"></a>
<a name="line-103"></a>    □                - sort box
<a name="line-104"></a>    **,##,           - sort superkind
<a name="line-105"></a>    *,#,(#),!        - sort kind
<a name="line-106"></a>    Int,Bits32_,Char - sort type
<a name="line-107"></a>    3,True,"bob"     - sort value
<a name="line-108"></a>
<a name="line-109"></a>## On boxed kinds
<a name="line-110"></a>
<a name="line-111"></a>The boxed kinds (* and !) represent types that have a uniform run time
<a name="line-112"></a>representation. Due to this, functions may be written that are polymorphic in types of these kinds.
<a name="line-113"></a>Hence the rules of the form (**,?,?), allowing taking types of boxed kinds as arguments.
<a name="line-114"></a>
<a name="line-115"></a>the unboxed kind # is inhabited with types that have their own specific run
<a name="line-116"></a>time representation. Hence you cannot write functions that are polymorphic in
<a name="line-117"></a>unboxed types
<a name="line-118"></a>
<a name="line-119"></a>## On sort box, the unboxed tuple, and friends
<a name="line-120"></a>
<a name="line-121"></a>Although sort box does not appear in the code, it is useful from a theoretical
<a name="line-122"></a>point of view to talk about certain types such as the types of unboxed tuples.
<a name="line-123"></a>Unboxed tuples may have boxed and unboxed arguments, without sort box it would
<a name="line-124"></a>be impossible to express this since it must be superkind polymorphic. sort box
<a name="line-125"></a>allows one to express this as (in the case of the unboxed 2-tuple)
<a name="line-126"></a>
<a name="line-127"></a>    ∀s1:□ ∀s2:□ ∀k1:s1 ∀k2:s2 ∀t1:k1 ∀t2:k2 . (# t1, t2 #)
<a name="line-128"></a>
<a name="line-129"></a>However, although this is a valid typing of what it would mean if a unboxed
<a name="line-130"></a>tuple were not fully applied, since we do not have any rules of form (##,?,?) or
<a name="line-131"></a>(□,?,?) this type obviously does not typecheck. Which is what enforces the
<a name="line-132"></a>invarient that unboxed tuples are always fully applied, and is also why we do
<a name="line-133"></a>not need a code representation of sort box.
<a name="line-134"></a>
<a name="line-135"></a>### Do we need a superbox?
<a name="line-136"></a>
<a name="line-137"></a>You will notice that if you look at the axioms involving the sorts, you end up
<a name="line-138"></a>with a disjoint graph
<a name="line-139"></a>
<a name="line-140"></a>             □             - the box
<a name="line-141"></a>            / \
<a name="line-142"></a>          **   ##          - superkind
<a name="line-143"></a>          /\     \
<a name="line-144"></a>         *  !     #   (#)  - kind
<a name="line-145"></a>
<a name="line-146"></a>This is simply due to the fact that nothing is polymorphic in unboxed tuples of
<a name="line-147"></a>kind (#) so we never need to refer to any super-sorts of them. We can add sorts
<a name="line-148"></a>(##),(□) and □□ to fill in the gaps, but since these sorts will never appear in
<a name="line-149"></a>code or discourse, we will ignore them from now on.
<a name="line-150"></a>
<a name="line-151"></a>               □□            - sort superbox
<a name="line-152"></a>              /  \
<a name="line-153"></a>             □    (□)        - sort box
<a name="line-154"></a>            / \      \
<a name="line-155"></a>          **   ##     (##)   - sort superkind
<a name="line-156"></a>          /\     \    |
<a name="line-157"></a>         *  !     #   (#)    - sort kind
<a name="line-158"></a>
<a name="line-159"></a>-}</span>
<a name="line-160"></a>
<a name="line-161"></a><a name="ptsAxioms"></a><span class='hs-definition'>ptsAxioms</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-conid'>Map</span> <span class='hs-conid'>ESort</span> <span class='hs-conid'>ESort</span>
<a name="line-162"></a><span class='hs-definition'>ptsAxioms</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>fromList</span> <span class='hs-keyglyph'>[</span>
<a name="line-163"></a>    <span class='hs-layout'>(</span><span class='hs-conid'>EStar</span><span class='hs-layout'>,</span><span class='hs-conid'>EStarStar</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-164"></a>    <span class='hs-layout'>(</span><span class='hs-conid'>EBang</span><span class='hs-layout'>,</span><span class='hs-conid'>EStarStar</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-165"></a>    <span class='hs-layout'>(</span><span class='hs-conid'>EHash</span><span class='hs-layout'>,</span><span class='hs-conid'>EHashHash</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-166"></a>    <span class='hs-layout'>(</span><span class='hs-conid'>ETuple</span><span class='hs-layout'>,</span><span class='hs-conid'>EHashHash</span><span class='hs-layout'>)</span>
<a name="line-167"></a>    <span class='hs-keyglyph'>]</span>
<a name="line-168"></a>
<a name="line-169"></a><a name="ptsRulesMap"></a><span class='hs-definition'>ptsRulesMap</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-conid'>Map</span> <span class='hs-layout'>(</span><span class='hs-conid'>ESort</span><span class='hs-layout'>,</span><span class='hs-conid'>ESort</span><span class='hs-layout'>)</span> <span class='hs-conid'>ESort</span>
<a name="line-170"></a><span class='hs-definition'>ptsRulesMap</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>fromList</span> <span class='hs-keyglyph'>[</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span><span class='hs-varid'>b</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span><span class='hs-varid'>c</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-keyword'>as</span><span class='hs-layout'>,</span><span class='hs-varid'>bs</span><span class='hs-layout'>,</span><span class='hs-varid'>c</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ptsRules</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>as</span><span class='hs-layout'>,</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>bs</span>  <span class='hs-keyglyph'>]</span> <span class='hs-keyword'>where</span>
<a name="line-171"></a>    <span class='hs-varid'>starHashBang</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>EStar</span><span class='hs-layout'>,</span><span class='hs-conid'>EHash</span><span class='hs-layout'>,</span><span class='hs-conid'>EBang</span><span class='hs-keyglyph'>]</span>
<a name="line-172"></a>    <span class='hs-varid'>ptsRules</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span>
<a name="line-173"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>starHashBang</span><span class='hs-layout'>,</span><span class='hs-conid'>ETuple</span><span class='hs-conop'>:</span><span class='hs-varid'>starHashBang</span><span class='hs-layout'>,</span><span class='hs-conid'>EStar</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-174"></a>        <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>ETuple</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span><span class='hs-conid'>ETuple</span><span class='hs-conop'>:</span><span class='hs-varid'>starHashBang</span><span class='hs-layout'>,</span><span class='hs-conid'>EBang</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-175"></a>        <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>EStarStar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span><span class='hs-varid'>starHashBang</span><span class='hs-layout'>,</span><span class='hs-conid'>EStar</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-176"></a>        <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>EStarStar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>EStarStar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span><span class='hs-conid'>EStarStar</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-177"></a>        <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>EStarStar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>EHashHash</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span><span class='hs-conid'>EHashHash</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-178"></a>        <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>EHashHash</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>EHashHash</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span><span class='hs-conid'>EHashHash</span><span class='hs-layout'>)</span>
<a name="line-179"></a>        <span class='hs-keyglyph'>]</span>
<a name="line-180"></a>
<a name="line-181"></a><a name="canBeBox"></a><span class='hs-definition'>canBeBox</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>getType</span> <span class='hs-layout'>(</span><span class='hs-varid'>getType</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span> <span class='hs-varop'>==</span> <span class='hs-conid'>ESort</span> <span class='hs-conid'>EStarStar</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-182"></a><span class='hs-definition'>canBeBox</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-183"></a>
<a name="line-184"></a><a name="tBox"></a><span class='hs-definition'>tBox</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mktBox</span> <span class='hs-varid'>eStar</span>
<a name="line-185"></a>
<a name="line-186"></a><a name="monadicLookup"></a><span class='hs-definition'>monadicLookup</span> <span class='hs-varid'>key</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>lookup</span> <span class='hs-varid'>key</span> <span class='hs-varid'>m</span> <span class='hs-keyword'>of</span>
<a name="line-187"></a>    <span class='hs-conid'>Just</span> <span class='hs-varid'>x</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>x</span>
<a name="line-188"></a>    <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>fail</span> <span class='hs-str'>"Key not found"</span>
<a name="line-189"></a>
<a name="line-190"></a><a name="instance%20CanType%20E"></a><span class='hs-comment'>-- Fast (and lazy, and perhaps unsafe) typeof</span>
<a name="line-191"></a><a name="instance%20CanType%20E"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>CanType</span> <span class='hs-conid'>E</span> <span class='hs-keyword'>where</span>
<a name="line-192"></a>    <span class='hs-keyword'>type</span> <span class='hs-conid'>TypeOf</span> <span class='hs-conid'>E</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>E</span>
<a name="line-193"></a>    <span class='hs-varid'>getType</span> <span class='hs-layout'>(</span><span class='hs-conid'>ESort</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ESort</span> <span class='hs-varop'>$</span> <span class='hs-varid'>getType</span> <span class='hs-varid'>s</span>
<a name="line-194"></a>    <span class='hs-varid'>getType</span> <span class='hs-layout'>(</span><span class='hs-conid'>ELit</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getType</span> <span class='hs-varid'>l</span>
<a name="line-195"></a>    <span class='hs-varid'>getType</span> <span class='hs-layout'>(</span><span class='hs-conid'>EVar</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>getType</span> <span class='hs-varid'>v</span>
<a name="line-196"></a>    <span class='hs-varid'>getType</span> <span class='hs-varid'>e</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>EPi</span> <span class='hs-conid'>TVr</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tvrType</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>a</span> <span class='hs-layout'>}</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>
<a name="line-197"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isUnknown</span> <span class='hs-varid'>typa</span> <span class='hs-varop'>||</span> <span class='hs-varid'>isUnknown</span> <span class='hs-varid'>typb</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Unknown</span>
<a name="line-198"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>maybe</span> <span class='hs-layout'>(</span><span class='hs-varid'>error</span> <span class='hs-varop'>$</span> <span class='hs-str'>"E.TypeCheck.getType: "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-layout'>(</span><span class='hs-varid'>e</span><span class='hs-layout'>,</span><span class='hs-varid'>getType</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span><span class='hs-varid'>getType</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-conid'>ESort</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-199"></a>            <span class='hs-conid'>ESort</span> <span class='hs-varid'>s1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>getType</span> <span class='hs-varid'>a</span>
<a name="line-200"></a>            <span class='hs-conid'>ESort</span> <span class='hs-varid'>s2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>getType</span> <span class='hs-varid'>b</span>
<a name="line-201"></a>            <span class='hs-varid'>monadicLookup</span> <span class='hs-layout'>(</span><span class='hs-varid'>s1</span><span class='hs-layout'>,</span><span class='hs-varid'>s2</span><span class='hs-layout'>)</span> <span class='hs-varid'>ptsRulesMap</span>
<a name="line-202"></a>        <span class='hs-keyword'>where</span> <span class='hs-varid'>typa</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getType</span> <span class='hs-varid'>a</span><span class='hs-layout'>;</span> <span class='hs-varid'>typb</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getType</span> <span class='hs-varid'>b</span>
<a name="line-203"></a>    <span class='hs-varid'>getType</span> <span class='hs-layout'>(</span><span class='hs-conid'>EAp</span> <span class='hs-layout'>(</span><span class='hs-conid'>ELit</span> <span class='hs-conid'>LitCons</span> <span class='hs-layout'>{</span> <span class='hs-varid'>litType</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EPi</span> <span class='hs-varid'>tvr</span> <span class='hs-varid'>a</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getType</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst</span> <span class='hs-varid'>tvr</span> <span class='hs-varid'>b</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-204"></a>    <span class='hs-varid'>getType</span> <span class='hs-layout'>(</span><span class='hs-conid'>EAp</span> <span class='hs-layout'>(</span><span class='hs-conid'>ELit</span> <span class='hs-varid'>lc</span><span class='hs-keyglyph'>@</span><span class='hs-conid'>LitCons</span> <span class='hs-layout'>{</span> <span class='hs-varid'>litAliasFor</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>af</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getType</span> <span class='hs-layout'>(</span><span class='hs-varid'>foldl</span> <span class='hs-varid'>eAp</span> <span class='hs-varid'>af</span> <span class='hs-layout'>(</span><span class='hs-varid'>litArgs</span> <span class='hs-varid'>lc</span> <span class='hs-varop'>++</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>b</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-205"></a>    <span class='hs-varid'>getType</span> <span class='hs-layout'>(</span><span class='hs-conid'>EAp</span> <span class='hs-layout'>(</span><span class='hs-conid'>EPi</span> <span class='hs-varid'>tvr</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getType</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst</span> <span class='hs-varid'>tvr</span> <span class='hs-varid'>b</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-206"></a>    <span class='hs-varid'>getType</span> <span class='hs-varid'>e</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>EAp</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ans</span> <span class='hs-keyword'>where</span>
<a name="line-207"></a>        <span class='hs-varid'>ans</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>isUnknown</span> <span class='hs-varid'>typa</span> <span class='hs-keyword'>then</span> <span class='hs-conid'>Unknown</span> <span class='hs-keyword'>else</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>a</span> <span class='hs-varop'>==</span> <span class='hs-varid'>tBox</span> <span class='hs-varop'>||</span> <span class='hs-varid'>typa</span> <span class='hs-varop'>==</span> <span class='hs-varid'>tBox</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>tBox</span> <span class='hs-keyword'>else</span> <span class='hs-layout'>(</span><span class='hs-keyword'>case</span> <span class='hs-varid'>a</span> <span class='hs-keyword'>of</span>
<a name="line-208"></a>            <span class='hs-layout'>(</span><span class='hs-conid'>ELit</span> <span class='hs-conid'>LitCons</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>error</span> <span class='hs-varop'>$</span> <span class='hs-str'>"getType: application of type alias "</span> <span class='hs-varop'>++</span> <span class='hs-layout'>(</span><span class='hs-varid'>render</span> <span class='hs-varop'>$</span> <span class='hs-varid'>parens</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ePretty</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-209"></a>            <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>eAp</span> <span class='hs-varid'>typa</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>
<a name="line-210"></a>        <span class='hs-varid'>typa</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getType</span> <span class='hs-varid'>a</span>
<a name="line-211"></a>    <span class='hs-varid'>getType</span> <span class='hs-layout'>(</span><span class='hs-conid'>ELam</span> <span class='hs-layout'>(</span><span class='hs-conid'>TVr</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tvrIdent</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>x</span><span class='hs-layout'>,</span> <span class='hs-varid'>tvrType</span> <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>a</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EPi</span> <span class='hs-layout'>(</span><span class='hs-varid'>tVr</span> <span class='hs-varid'>x</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>getType</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>
<a name="line-212"></a>    <span class='hs-varid'>getType</span> <span class='hs-layout'>(</span><span class='hs-conid'>ELetRec</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getType</span> <span class='hs-varid'>e</span>
<a name="line-213"></a>    <span class='hs-varid'>getType</span> <span class='hs-conid'>ECase</span> <span class='hs-layout'>{</span><span class='hs-varid'>eCaseType</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty</span>
<a name="line-214"></a>    <span class='hs-varid'>getType</span> <span class='hs-layout'>(</span><span class='hs-conid'>EError</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>e</span>
<a name="line-215"></a>    <span class='hs-varid'>getType</span> <span class='hs-layout'>(</span><span class='hs-conid'>EPrim</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>t</span>
<a name="line-216"></a>    <span class='hs-varid'>getType</span> <span class='hs-conid'>Unknown</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Unknown</span>
<a name="line-217"></a>
<a name="line-218"></a><a name="instance%20CanType%20ESort"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>CanType</span> <span class='hs-conid'>ESort</span> <span class='hs-keyword'>where</span>
<a name="line-219"></a>    <span class='hs-keyword'>type</span> <span class='hs-conid'>TypeOf</span> <span class='hs-conid'>ESort</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ESort</span>
<a name="line-220"></a>    <span class='hs-varid'>getType</span> <span class='hs-layout'>(</span><span class='hs-conid'>ESortNamed</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EHashHash</span>
<a name="line-221"></a>    <span class='hs-varid'>getType</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>lookup</span> <span class='hs-varid'>s</span> <span class='hs-varid'>ptsAxioms</span> <span class='hs-keyword'>of</span>
<a name="line-222"></a>        <span class='hs-conid'>Just</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>s</span>
<a name="line-223"></a>        <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>error</span> <span class='hs-varop'>$</span> <span class='hs-str'>"getType: "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>s</span>
<a name="line-224"></a><a name="instance%20CanType%20TVr"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>CanType</span> <span class='hs-conid'>TVr</span> <span class='hs-keyword'>where</span>
<a name="line-225"></a>    <span class='hs-keyword'>type</span> <span class='hs-conid'>TypeOf</span> <span class='hs-conid'>TVr</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>E</span>
<a name="line-226"></a>    <span class='hs-varid'>getType</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tvrType</span>
<a name="line-227"></a><a name="instance%20CanType%20(Lit%20x%20t)"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>CanType</span> <span class='hs-layout'>(</span><span class='hs-conid'>Lit</span> <span class='hs-varid'>x</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-228"></a>    <span class='hs-keyword'>type</span> <span class='hs-conid'>TypeOf</span> <span class='hs-layout'>(</span><span class='hs-conid'>Lit</span> <span class='hs-varid'>x</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>t</span>
<a name="line-229"></a>    <span class='hs-varid'>getType</span> <span class='hs-varid'>l</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>litType</span> <span class='hs-varid'>l</span>
<a name="line-230"></a><a name="instance%20CanType%20(Alt%20e)"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>CanType</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>CanType</span> <span class='hs-layout'>(</span><span class='hs-conid'>Alt</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-231"></a>    <span class='hs-keyword'>type</span> <span class='hs-conid'>TypeOf</span> <span class='hs-layout'>(</span><span class='hs-conid'>Alt</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TypeOf</span> <span class='hs-varid'>e</span>
<a name="line-232"></a>    <span class='hs-varid'>getType</span> <span class='hs-layout'>(</span><span class='hs-conid'>Alt</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getType</span> <span class='hs-varid'>e</span>
<a name="line-233"></a>
<a name="line-234"></a><a name="sortSortLike"></a><span class='hs-definition'>sortSortLike</span> <span class='hs-layout'>(</span><span class='hs-conid'>ESort</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isEHashHash</span> <span class='hs-varid'>s</span> <span class='hs-varop'>||</span> <span class='hs-varid'>isEStarStar</span> <span class='hs-varid'>s</span>
<a name="line-235"></a><span class='hs-definition'>sortSortLike</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-236"></a>
<a name="line-237"></a><a name="sortKindLike"></a><span class='hs-definition'>sortKindLike</span> <span class='hs-layout'>(</span><span class='hs-conid'>ESort</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isEHashHash</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isEStarStar</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span>
<a name="line-238"></a><span class='hs-definition'>sortKindLike</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sortSortLike</span> <span class='hs-layout'>(</span><span class='hs-varid'>getType</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-239"></a>
<a name="line-240"></a><a name="sortTypeLike"></a><span class='hs-definition'>sortTypeLike</span> <span class='hs-conid'>ESort</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-241"></a><span class='hs-definition'>sortTypeLike</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sortKindLike</span> <span class='hs-layout'>(</span><span class='hs-varid'>getType</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-242"></a>
<a name="line-243"></a><a name="sortTermLike"></a><span class='hs-definition'>sortTermLike</span> <span class='hs-conid'>ESort</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-244"></a><span class='hs-definition'>sortTermLike</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sortTypeLike</span> <span class='hs-layout'>(</span><span class='hs-varid'>getType</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-245"></a>
<a name="line-246"></a><a name="withContextDoc"></a><span class='hs-definition'>withContextDoc</span> <span class='hs-varid'>s</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withContext</span> <span class='hs-layout'>(</span><span class='hs-varid'>render</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-varid'>a</span>
<a name="line-247"></a>
<a name="line-248"></a><span class='hs-comment'>-- | Perform a full typecheck, evaluating type terms as necessary.</span>
<a name="line-249"></a>
<a name="line-250"></a><a name="inferType"></a><span class='hs-definition'>inferType</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>ContextMonad</span> <span class='hs-varid'>m</span><span class='hs-layout'>,</span> <span class='hs-conid'>ContextOf</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>~</span> <span class='hs-conid'>String</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>DataTable</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>TVr</span><span class='hs-layout'>,</span><span class='hs-conid'>E</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>E</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>E</span>
<a name="line-251"></a><span class='hs-definition'>inferType</span> <span class='hs-varid'>dataTable</span> <span class='hs-varid'>ds</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rfc</span> <span class='hs-varid'>e</span> <span class='hs-keyword'>where</span>
<a name="line-252"></a>    <span class='hs-varid'>inferType'</span> <span class='hs-varid'>ds</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inferType</span> <span class='hs-varid'>dataTable</span> <span class='hs-varid'>ds</span> <span class='hs-varid'>e</span>
<a name="line-253"></a>    <span class='hs-varid'>prettyE</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ePretty</span>
<a name="line-254"></a>    <span class='hs-varid'>rfc</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>withContextDoc</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"fullCheck:"</span> <span class='hs-varop'>&lt;/&gt;</span> <span class='hs-varid'>prettyE</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>fc</span> <span class='hs-varid'>e</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-varid'>strong'</span><span class='hs-layout'>)</span>
<a name="line-255"></a>    <span class='hs-varid'>rfc'</span> <span class='hs-varid'>nds</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withContextDoc</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"fullCheck':"</span> <span class='hs-varop'>&lt;/&gt;</span> <span class='hs-varid'>prettyE</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>inferType'</span> <span class='hs-varid'>nds</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-256"></a>    <span class='hs-varid'>strong'</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withContextDoc</span> <span class='hs-layout'>(</span><span class='hs-varid'>parens</span> <span class='hs-varop'>$</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Strong:"</span> <span class='hs-varop'>&lt;/&gt;</span> <span class='hs-varid'>prettyE</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>strong</span> <span class='hs-varid'>ds</span> <span class='hs-varid'>e</span>
<a name="line-257"></a>    <span class='hs-varid'>fc</span> <span class='hs-varid'>s</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>ESort</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>getType</span> <span class='hs-varid'>s</span>
<a name="line-258"></a>    <span class='hs-varid'>fc</span> <span class='hs-layout'>(</span><span class='hs-conid'>ELit</span> <span class='hs-varid'>lc</span><span class='hs-keyglyph'>@</span><span class='hs-conid'>LitCons</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>lc'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>updateLit</span> <span class='hs-varid'>dataTable</span> <span class='hs-varid'>lc</span><span class='hs-layout'>,</span> <span class='hs-varid'>litAliasFor</span> <span class='hs-varid'>lc</span> <span class='hs-varop'>/=</span> <span class='hs-varid'>litAliasFor</span> <span class='hs-varid'>lc'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fail</span> <span class='hs-varop'>$</span> <span class='hs-str'>"Alias not correct: "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-layout'>(</span><span class='hs-varid'>lc</span><span class='hs-layout'>,</span> <span class='hs-varid'>litAliasFor</span> <span class='hs-varid'>lc'</span><span class='hs-layout'>)</span>
<a name="line-259"></a>    <span class='hs-varid'>fc</span> <span class='hs-layout'>(</span><span class='hs-conid'>ELit</span> <span class='hs-conid'>LitCons</span> <span class='hs-layout'>{</span> <span class='hs-varid'>litName</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-varid'>litArgs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>es</span><span class='hs-layout'>,</span> <span class='hs-varid'>litType</span> <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>t</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>nameType</span> <span class='hs-varid'>n</span> <span class='hs-varop'>==</span> <span class='hs-conid'>TypeConstructor</span><span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>fromUnboxedNameTuple</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-260"></a>        <span class='hs-varid'>withContext</span> <span class='hs-layout'>(</span><span class='hs-str'>"Checking Unboxed Tuple: "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-261"></a>        <span class='hs-comment'>-- we omit kind checking for unboxed tuples</span>
<a name="line-262"></a>        <span class='hs-varid'>valid</span> <span class='hs-varid'>t</span>
<a name="line-263"></a>        <span class='hs-varid'>es'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>rfc</span> <span class='hs-varid'>es</span>
<a name="line-264"></a>        <span class='hs-varid'>strong'</span> <span class='hs-varid'>t</span>
<a name="line-265"></a>    <span class='hs-varid'>fc</span> <span class='hs-varid'>e</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>ELit</span> <span class='hs-conid'>LitCons</span> <span class='hs-layout'>{</span> <span class='hs-varid'>litName</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-varid'>litArgs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>es</span><span class='hs-layout'>,</span> <span class='hs-varid'>litType</span> <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>t</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-266"></a>        <span class='hs-varid'>withContext</span> <span class='hs-layout'>(</span><span class='hs-str'>"Checking Constructor: "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-267"></a>        <span class='hs-varid'>valid</span> <span class='hs-varid'>t</span>
<a name="line-268"></a>        <span class='hs-varid'>es'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>rfc</span> <span class='hs-varid'>es</span>
<a name="line-269"></a>        <span class='hs-varid'>t'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>strong'</span> <span class='hs-varid'>t</span>
<a name="line-270"></a>        <span class='hs-keyword'>let</span> <span class='hs-varid'>sts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>slotTypes</span> <span class='hs-varid'>dataTable</span> <span class='hs-varid'>n</span> <span class='hs-varid'>t</span>
<a name="line-271"></a>            <span class='hs-varid'>les</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>es</span>
<a name="line-272"></a>            <span class='hs-varid'>lsts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>sts</span>
<a name="line-273"></a>        <span class='hs-varid'>withContext</span> <span class='hs-layout'>(</span><span class='hs-str'>"Checking Args: "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-layout'>(</span><span class='hs-varid'>sts</span><span class='hs-layout'>,</span><span class='hs-varid'>es'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-274"></a>        <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>les</span> <span class='hs-varop'>==</span> <span class='hs-varid'>lsts</span> <span class='hs-varop'>||</span> <span class='hs-layout'>(</span><span class='hs-varid'>les</span> <span class='hs-varop'>&lt;</span> <span class='hs-varid'>lsts</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isEPi</span> <span class='hs-varid'>t'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-275"></a>            <span class='hs-varid'>fail</span> <span class='hs-str'>"constructor with wrong number of arguments"</span>
<a name="line-276"></a>        <span class='hs-varid'>zipWithM_</span> <span class='hs-varid'>eq</span> <span class='hs-varid'>sts</span> <span class='hs-varid'>es'</span>
<a name="line-277"></a>        <span class='hs-varid'>return</span> <span class='hs-varid'>t'</span>
<a name="line-278"></a>    <span class='hs-varid'>fc</span> <span class='hs-varid'>e</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>ELit</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>t</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getType</span> <span class='hs-varid'>e</span> <span class='hs-keyword'>in</span> <span class='hs-varid'>valid</span> <span class='hs-varid'>t</span> <span class='hs-varop'>&gt;&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>t</span>
<a name="line-279"></a>    <span class='hs-varid'>fc</span> <span class='hs-layout'>(</span><span class='hs-conid'>EVar</span> <span class='hs-layout'>(</span><span class='hs-conid'>TVr</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tvrIdent</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eid</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>eid</span> <span class='hs-varop'>==</span> <span class='hs-varid'>emptyId</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fail</span> <span class='hs-str'>"variable with nothing!"</span>
<a name="line-280"></a>    <span class='hs-varid'>fc</span> <span class='hs-layout'>(</span><span class='hs-conid'>EVar</span> <span class='hs-layout'>(</span><span class='hs-conid'>TVr</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tvrType</span> <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>t</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>valid</span> <span class='hs-varid'>t</span> <span class='hs-varop'>&gt;&gt;</span> <span class='hs-varid'>strong'</span> <span class='hs-varid'>t</span>
<a name="line-281"></a>    <span class='hs-varid'>fc</span> <span class='hs-layout'>(</span><span class='hs-conid'>EPi</span> <span class='hs-layout'>(</span><span class='hs-conid'>TVr</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tvrIdent</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-varid'>tvrType</span> <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>at</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-282"></a>        <span class='hs-conid'>ESort</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rfc</span> <span class='hs-varid'>at</span>
<a name="line-283"></a>        <span class='hs-conid'>ESort</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rfc'</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>d</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>d</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-varid'>v</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ds</span><span class='hs-layout'>,</span> <span class='hs-varid'>tvrIdent</span> <span class='hs-varid'>v</span> <span class='hs-varop'>/=</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>]</span> <span class='hs-varid'>b</span>
<a name="line-284"></a>        <span class='hs-varid'>liftM</span> <span class='hs-conid'>ESort</span> <span class='hs-varop'>$</span> <span class='hs-varid'>monadicLookup</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span><span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-varid'>ptsRulesMap</span>
<a name="line-285"></a>        <span class='hs-comment'>--valid at &gt;&gt; rfc' [ d | d@(v,_) &lt;- ds, tvrIdent v /= n ] b</span>
<a name="line-286"></a>    <span class='hs-comment'>--fc (ELam tvr@(TVr n at) b) = valid at &gt;&gt; rfc' [ d | d@(v,_) &lt;- ds, tvrIdent v /= n ] b &gt;&gt;= \b' -&gt; (strong' $ EPi tvr b')</span>
<a name="line-287"></a>    <span class='hs-varid'>fc</span> <span class='hs-layout'>(</span><span class='hs-conid'>ELam</span> <span class='hs-varid'>tvr</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TVr</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tvrIdent</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-varid'>tvrType</span> <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>at</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-288"></a>        <span class='hs-varid'>withContext</span> <span class='hs-str'>"Checking Lambda"</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-289"></a>        <span class='hs-varid'>valid</span> <span class='hs-varid'>at</span>
<a name="line-290"></a>        <span class='hs-varid'>b'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>withContext</span> <span class='hs-str'>"Checking Lambda Body"</span> <span class='hs-varop'>$</span> <span class='hs-varid'>rfc'</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>d</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>d</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-varid'>v</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ds</span><span class='hs-layout'>,</span> <span class='hs-varid'>tvrIdent</span> <span class='hs-varid'>v</span> <span class='hs-varop'>/=</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>]</span> <span class='hs-varid'>b</span>
<a name="line-291"></a>        <span class='hs-varid'>withContext</span> <span class='hs-str'>"Checking lambda pi"</span> <span class='hs-varop'>$</span> <span class='hs-varid'>strong'</span> <span class='hs-varop'>$</span> <span class='hs-conid'>EPi</span> <span class='hs-varid'>tvr</span> <span class='hs-varid'>b'</span>
<a name="line-292"></a>    <span class='hs-varid'>fc</span> <span class='hs-layout'>(</span><span class='hs-conid'>EAp</span> <span class='hs-layout'>(</span><span class='hs-conid'>EPi</span> <span class='hs-varid'>tvr</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rfc</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst</span> <span class='hs-varid'>tvr</span> <span class='hs-varid'>b</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-293"></a>    <span class='hs-varid'>fc</span> <span class='hs-layout'>(</span><span class='hs-conid'>EAp</span> <span class='hs-layout'>(</span><span class='hs-conid'>ELit</span> <span class='hs-varid'>lc</span><span class='hs-keyglyph'>@</span><span class='hs-conid'>LitCons</span> <span class='hs-layout'>{</span> <span class='hs-varid'>litAliasFor</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>af</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rfc</span> <span class='hs-layout'>(</span><span class='hs-conid'>EAp</span> <span class='hs-layout'>(</span><span class='hs-varid'>foldl</span> <span class='hs-varid'>eAp</span> <span class='hs-varid'>af</span> <span class='hs-layout'>(</span><span class='hs-varid'>litArgs</span> <span class='hs-varid'>lc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>
<a name="line-294"></a>    <span class='hs-varid'>fc</span> <span class='hs-layout'>(</span><span class='hs-conid'>EAp</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-295"></a>        <span class='hs-varid'>withContextDoc</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"EAp:"</span> <span class='hs-varop'>&lt;/&gt;</span> <span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>prettyE</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;/&gt;</span> <span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>prettyE</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-296"></a>            <span class='hs-varid'>a'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rfc</span> <span class='hs-varid'>a</span>
<a name="line-297"></a>            <span class='hs-keyword'>if</span> <span class='hs-varid'>a'</span> <span class='hs-varop'>==</span> <span class='hs-varid'>tBox</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-varid'>tBox</span> <span class='hs-keyword'>else</span> <span class='hs-varid'>strong'</span> <span class='hs-layout'>(</span><span class='hs-varid'>eAp</span> <span class='hs-varid'>a'</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>
<a name="line-298"></a>    <span class='hs-varid'>fc</span> <span class='hs-layout'>(</span><span class='hs-conid'>ELetRec</span> <span class='hs-varid'>vs</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-299"></a>        <span class='hs-keyword'>let</span> <span class='hs-varid'>ck</span> <span class='hs-layout'>(</span><span class='hs-conid'>TVr</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tvrIdent</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eid</span> <span class='hs-layout'>}</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>eid</span> <span class='hs-varop'>==</span> <span class='hs-varid'>emptyId</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fail</span> <span class='hs-str'>"binding of empty var"</span>
<a name="line-300"></a>            <span class='hs-varid'>ck</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TVr</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tvrType</span> <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>t</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span><span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withContextDoc</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>text</span> <span class='hs-str'>"Checking Let: "</span><span class='hs-layout'>,</span> <span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprint</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span><span class='hs-varid'>text</span>  <span class='hs-str'>" = "</span><span class='hs-layout'>,</span> <span class='hs-varid'>parens</span> <span class='hs-varop'>$</span> <span class='hs-varid'>prettyE</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>  <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-301"></a>                <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>getType</span> <span class='hs-varid'>t</span> <span class='hs-varop'>==</span> <span class='hs-varid'>eHash</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isEPi</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>fail</span> <span class='hs-varop'>$</span> <span class='hs-str'>"Let binding unboxed value: "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv</span><span class='hs-layout'>,</span><span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-302"></a>                <span class='hs-varid'>valid'</span> <span class='hs-varid'>nds</span> <span class='hs-varid'>t</span>
<a name="line-303"></a>                <span class='hs-varid'>fceq</span> <span class='hs-varid'>nds</span> <span class='hs-varid'>e</span> <span class='hs-varid'>t</span>
<a name="line-304"></a>            <span class='hs-varid'>nds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vs</span> <span class='hs-varop'>++</span> <span class='hs-varid'>ds</span>
<a name="line-305"></a>        <span class='hs-varid'>mapM_</span> <span class='hs-varid'>ck</span> <span class='hs-varid'>vs</span>
<a name="line-306"></a>        <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>hasRepeatUnder</span> <span class='hs-layout'>(</span><span class='hs-varid'>tvrIdent</span> <span class='hs-varop'>.</span> <span class='hs-varid'>fst</span><span class='hs-layout'>)</span> <span class='hs-varid'>vs</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>fail</span> <span class='hs-str'>"Repeat Variable in ELetRec"</span>
<a name="line-307"></a>        <span class='hs-varid'>inferType'</span> <span class='hs-varid'>nds</span> <span class='hs-varid'>e</span>
<a name="line-308"></a>        <span class='hs-comment'>--et &lt;- inferType' nds e</span>
<a name="line-309"></a>        <span class='hs-comment'>--strong nds et</span>
<a name="line-310"></a>    <span class='hs-varid'>fc</span> <span class='hs-layout'>(</span><span class='hs-conid'>EError</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>valid</span> <span class='hs-varid'>e</span> <span class='hs-varop'>&gt;&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>strong'</span>  <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-311"></a>    <span class='hs-varid'>fc</span> <span class='hs-layout'>(</span><span class='hs-conid'>EPrim</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ts</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapM_</span> <span class='hs-varid'>valid</span> <span class='hs-varid'>ts</span> <span class='hs-varop'>&gt;&gt;</span> <span class='hs-varid'>valid</span> <span class='hs-varid'>t</span> <span class='hs-varop'>&gt;&gt;</span> <span class='hs-layout'>(</span> <span class='hs-varid'>strong'</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span>
<a name="line-312"></a>    <span class='hs-varid'>fc</span> <span class='hs-varid'>ec</span><span class='hs-keyglyph'>@</span><span class='hs-conid'>ECase</span> <span class='hs-layout'>{</span> <span class='hs-varid'>eCaseScrutinee</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>e</span><span class='hs-keyglyph'>@</span><span class='hs-conid'>ELit</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>,</span> <span class='hs-varid'>eCaseBind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>b</span><span class='hs-layout'>,</span> <span class='hs-varid'>eCaseAlts</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>as</span><span class='hs-layout'>,</span> <span class='hs-varid'>eCaseType</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dt</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>sortTypeLike</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>   <span class='hs-comment'>-- TODO - this is a hack to get around case of constants.</span>
<a name="line-313"></a>        <span class='hs-varid'>withContext</span> <span class='hs-str'>"Checking typelike pattern binding case"</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-314"></a>        <span class='hs-varid'>et</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rfc</span> <span class='hs-varid'>e</span>
<a name="line-315"></a>        <span class='hs-varid'>withContext</span> <span class='hs-str'>"Checking typelike default binding"</span> <span class='hs-varop'>$</span> <span class='hs-varid'>eq</span> <span class='hs-varid'>et</span> <span class='hs-layout'>(</span><span class='hs-varid'>getType</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>
<a name="line-316"></a>        <span class='hs-varid'>verifyPats</span> <span class='hs-layout'>(</span><span class='hs-varid'>casePats</span> <span class='hs-varid'>ec</span><span class='hs-layout'>)</span>
<a name="line-317"></a>        <span class='hs-comment'>-- skip checking alternatives</span>
<a name="line-318"></a>        <span class='hs-varid'>ps</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>strong'</span> <span class='hs-varop'>.</span> <span class='hs-varid'>getType</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>casePats</span> <span class='hs-varid'>ec</span>
<a name="line-319"></a>        <span class='hs-varid'>withContext</span> <span class='hs-str'>"Checking typelike pattern equality"</span> <span class='hs-varop'>$</span>  <span class='hs-varid'>eqAll</span> <span class='hs-layout'>(</span><span class='hs-varid'>et</span><span class='hs-conop'>:</span><span class='hs-varid'>ps</span><span class='hs-layout'>)</span>
<a name="line-320"></a>        <span class='hs-varid'>strong'</span> <span class='hs-varid'>dt</span>
<a name="line-321"></a>    <span class='hs-varid'>fc</span> <span class='hs-varid'>ec</span><span class='hs-keyglyph'>@</span><span class='hs-conid'>ECase</span> <span class='hs-layout'>{</span><span class='hs-varid'>eCaseScrutinee</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>e</span><span class='hs-layout'>,</span> <span class='hs-varid'>eCaseBind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>b</span><span class='hs-layout'>,</span> <span class='hs-varid'>eCaseAlts</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>as</span><span class='hs-layout'>,</span> <span class='hs-varid'>eCaseType</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dt</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>sortTypeLike</span> <span class='hs-varid'>e</span>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>   <span class='hs-comment'>-- TODO - we should substitute the tested for value into the default type.</span>
<a name="line-322"></a>        <span class='hs-varid'>withContext</span> <span class='hs-str'>"Checking typelike binding case"</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-323"></a>        <span class='hs-varid'>et</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rfc</span> <span class='hs-varid'>e</span>
<a name="line-324"></a>        <span class='hs-varid'>withContext</span> <span class='hs-str'>"Checking typelike default binding"</span> <span class='hs-varop'>$</span> <span class='hs-varid'>eq</span> <span class='hs-varid'>et</span> <span class='hs-layout'>(</span><span class='hs-varid'>getType</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>
<a name="line-325"></a>        <span class='hs-comment'>--dt &lt;- rfc d</span>
<a name="line-326"></a>        <span class='hs-comment'>--bs &lt;- mapM rfc (caseBodies ec)  -- these should be specializations of dt</span>
<a name="line-327"></a>        <span class='hs-varid'>withContext</span> <span class='hs-str'>"Checking typelike alternatives"</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mapM_</span> <span class='hs-layout'>(</span><span class='hs-varid'>calt</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyword'>as</span>
<a name="line-328"></a>        <span class='hs-comment'>--eqAll bs</span>
<a name="line-329"></a>        <span class='hs-varid'>verifyPats</span> <span class='hs-layout'>(</span><span class='hs-varid'>casePats</span> <span class='hs-varid'>ec</span><span class='hs-layout'>)</span>
<a name="line-330"></a>        <span class='hs-varid'>ps</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>withContext</span> <span class='hs-str'>"Getting pattern types"</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>strong'</span> <span class='hs-varop'>.</span> <span class='hs-varid'>getType</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>casePats</span> <span class='hs-varid'>ec</span>
<a name="line-331"></a>        <span class='hs-varid'>withContext</span> <span class='hs-str'>"checking typelike pattern equality"</span> <span class='hs-varop'>$</span> <span class='hs-varid'>eqAll</span> <span class='hs-layout'>(</span><span class='hs-varid'>et</span><span class='hs-conop'>:</span><span class='hs-varid'>ps</span><span class='hs-layout'>)</span>
<a name="line-332"></a>        <span class='hs-varid'>withContext</span> <span class='hs-str'>"Evaluating Case Type"</span> <span class='hs-varop'>$</span> <span class='hs-varid'>strong'</span> <span class='hs-varid'>dt</span>
<a name="line-333"></a>    <span class='hs-varid'>fc</span> <span class='hs-varid'>ec</span><span class='hs-keyglyph'>@</span><span class='hs-conid'>ECase</span> <span class='hs-layout'>{</span> <span class='hs-varid'>eCaseScrutinee</span> <span class='hs-keyglyph'>=</span><span class='hs-varid'>e</span><span class='hs-layout'>,</span> <span class='hs-varid'>eCaseBind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>b</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-334"></a>        <span class='hs-varid'>withContext</span> <span class='hs-str'>"Checking plain case"</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-335"></a>        <span class='hs-varid'>et</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rfc</span> <span class='hs-varid'>e</span>
<a name="line-336"></a>        <span class='hs-varid'>withContext</span> <span class='hs-str'>"Checking default binding"</span> <span class='hs-varop'>$</span> <span class='hs-varid'>eq</span> <span class='hs-varid'>et</span> <span class='hs-layout'>(</span><span class='hs-varid'>getType</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>
<a name="line-337"></a>        <span class='hs-varid'>bs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>withContext</span> <span class='hs-str'>"Checking case bodies"</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>rfc</span> <span class='hs-layout'>(</span><span class='hs-varid'>caseBodies</span> <span class='hs-varid'>ec</span><span class='hs-layout'>)</span>
<a name="line-338"></a>        <span class='hs-varid'>ect</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>strong'</span> <span class='hs-layout'>(</span><span class='hs-varid'>eCaseType</span> <span class='hs-varid'>ec</span><span class='hs-layout'>)</span>
<a name="line-339"></a>        <span class='hs-varid'>withContext</span> <span class='hs-str'>"Checking case bodies have equal types"</span> <span class='hs-varop'>$</span> <span class='hs-varid'>eqAll</span> <span class='hs-layout'>(</span><span class='hs-varid'>ect</span><span class='hs-conop'>:</span><span class='hs-varid'>bs</span><span class='hs-layout'>)</span>
<a name="line-340"></a>        <span class='hs-varid'>verifyPats</span> <span class='hs-layout'>(</span><span class='hs-varid'>casePats</span> <span class='hs-varid'>ec</span><span class='hs-layout'>)</span>
<a name="line-341"></a>        <span class='hs-varid'>ps</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>strong'</span> <span class='hs-varop'>.</span> <span class='hs-varid'>getType</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>casePats</span> <span class='hs-varid'>ec</span>
<a name="line-342"></a>        <span class='hs-varid'>withContext</span> <span class='hs-str'>"checking pattern equality"</span> <span class='hs-varop'>$</span> <span class='hs-varid'>eqAll</span> <span class='hs-layout'>(</span><span class='hs-varid'>et</span><span class='hs-conop'>:</span><span class='hs-varid'>ps</span><span class='hs-layout'>)</span>
<a name="line-343"></a>        <span class='hs-varid'>return</span> <span class='hs-varid'>ect</span>
<a name="line-344"></a>    <span class='hs-varid'>fc</span> <span class='hs-conid'>Unknown</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Unknown</span>
<a name="line-345"></a>    <span class='hs-comment'>--fc e = failDoc $ text "what's this? " &lt;/&gt; (prettyE e)</span>
<a name="line-346"></a>    <span class='hs-varid'>calt</span> <span class='hs-layout'>(</span><span class='hs-conid'>EVar</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Alt</span> <span class='hs-varid'>l</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-347"></a>        <span class='hs-keyword'>let</span> <span class='hs-varid'>nv</span> <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>followAliases</span> <span class='hs-varid'>undefined</span> <span class='hs-layout'>(</span><span class='hs-varid'>patToLitEE</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span>
<a name="line-348"></a>        <span class='hs-varid'>rfc</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst'</span> <span class='hs-varid'>v</span> <span class='hs-varid'>nv</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-349"></a>    <span class='hs-varid'>calt</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>Alt</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rfc</span> <span class='hs-varid'>e</span>
<a name="line-350"></a>    <span class='hs-varid'>verifyPats</span> <span class='hs-varid'>xs</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-351"></a>        <span class='hs-varid'>mapM_</span> <span class='hs-varid'>verifyPats'</span> <span class='hs-varid'>xs</span>
<a name="line-352"></a>        <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>hasRepeatUnder</span> <span class='hs-varid'>litHead</span> <span class='hs-varid'>xs</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>fail</span> <span class='hs-str'>"Duplicate case alternatives"</span>
<a name="line-353"></a>
<a name="line-354"></a>    <span class='hs-varid'>verifyPats'</span> <span class='hs-conid'>LitCons</span> <span class='hs-layout'>{</span> <span class='hs-varid'>litArgs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>xs</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>hasRepeatUnder</span> <span class='hs-varid'>id</span> <span class='hs-layout'>(</span><span class='hs-varid'>filter</span> <span class='hs-layout'>(</span><span class='hs-varop'>/=</span> <span class='hs-varid'>emptyId</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-varid'>tvrIdent</span> <span class='hs-varid'>xs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>fail</span> <span class='hs-str'>"Case pattern is non-linear"</span>
<a name="line-355"></a>    <span class='hs-varid'>verifyPats'</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-356"></a>
<a name="line-357"></a>    <span class='hs-varid'>eqAll</span> <span class='hs-varid'>ts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withContextDoc</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"eqAll"</span> <span class='hs-varop'>&lt;/&gt;</span> <span class='hs-varid'>list</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>prettyE</span> <span class='hs-varid'>ts</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>foldl1M_</span> <span class='hs-varid'>eq</span> <span class='hs-varid'>ts</span>
<a name="line-358"></a>    <span class='hs-varid'>valid</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>valid'</span> <span class='hs-varid'>ds</span> <span class='hs-varid'>s</span>
<a name="line-359"></a>    <span class='hs-varid'>valid'</span> <span class='hs-varid'>nds</span> <span class='hs-conid'>ESort</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-360"></a>    <span class='hs-varid'>valid'</span> <span class='hs-varid'>nds</span> <span class='hs-varid'>s</span>
<a name="line-361"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Unknown</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-362"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>withContextDoc</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"valid:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>prettyE</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-keyword'>do</span> <span class='hs-varid'>t</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>inferType'</span> <span class='hs-varid'>nds</span> <span class='hs-varid'>s</span><span class='hs-layout'>;</span>  <span class='hs-varid'>valid'</span> <span class='hs-varid'>nds</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span>
<a name="line-363"></a>    <span class='hs-varid'>eq</span> <span class='hs-varid'>box</span> <span class='hs-varid'>t2</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>boxCompat</span> <span class='hs-varid'>box</span> <span class='hs-varid'>t2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>t2</span>
<a name="line-364"></a>    <span class='hs-varid'>eq</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>box</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>boxCompat</span> <span class='hs-varid'>box</span> <span class='hs-varid'>t1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>t1</span>
<a name="line-365"></a>   <span class='hs-comment'>-- box == tBox, canBeBox t2 = return t2</span>
<a name="line-366"></a>   <span class='hs-comment'>-- eq t1 box | box == tBox, canBeBox t1 = return t1</span>
<a name="line-367"></a>    <span class='hs-varid'>eq</span> <span class='hs-conid'>Unknown</span> <span class='hs-varid'>t2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>t2</span>
<a name="line-368"></a>    <span class='hs-varid'>eq</span> <span class='hs-varid'>t1</span> <span class='hs-conid'>Unknown</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>t1</span>
<a name="line-369"></a>    <span class='hs-varid'>eq</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eq'</span> <span class='hs-varid'>ds</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span>
<a name="line-370"></a>    <span class='hs-varid'>eq'</span> <span class='hs-varid'>nds</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-371"></a>        <span class='hs-varid'>e1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>strong</span> <span class='hs-varid'>nds</span> <span class='hs-layout'>(</span><span class='hs-varid'>t1</span><span class='hs-layout'>)</span>
<a name="line-372"></a>        <span class='hs-varid'>e2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>strong</span> <span class='hs-varid'>nds</span> <span class='hs-layout'>(</span><span class='hs-varid'>t2</span><span class='hs-layout'>)</span>
<a name="line-373"></a>        <span class='hs-keyword'>case</span> <span class='hs-varid'>typesCompatable</span> <span class='hs-varid'>e1</span> <span class='hs-varid'>e2</span> <span class='hs-keyword'>of</span>
<a name="line-374"></a>            <span class='hs-conid'>Just</span> <span class='hs-conid'>()</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>e1</span><span class='hs-layout'>)</span>
<a name="line-375"></a>            <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>failDoc</span> <span class='hs-varop'>$</span> <span class='hs-varid'>text</span> <span class='hs-str'>"eq:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>align</span> <span class='hs-varop'>$</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>prettyE</span> <span class='hs-layout'>(</span><span class='hs-varid'>e1</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>prettyE</span> <span class='hs-layout'>(</span><span class='hs-varid'>e2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-376"></a>    <span class='hs-varid'>fceq</span> <span class='hs-varid'>nds</span> <span class='hs-varid'>e1</span> <span class='hs-varid'>t2</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-377"></a>        <span class='hs-varid'>withContextDoc</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>text</span> <span class='hs-str'>"fceq:"</span><span class='hs-layout'>,</span> <span class='hs-varid'>align</span> <span class='hs-varop'>$</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>parens</span> <span class='hs-varop'>$</span> <span class='hs-varid'>prettyE</span> <span class='hs-varid'>e1</span><span class='hs-layout'>,</span>  <span class='hs-varid'>parens</span> <span class='hs-varop'>$</span> <span class='hs-varid'>prettyE</span> <span class='hs-varid'>t2</span><span class='hs-keyglyph'>]</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-378"></a>        <span class='hs-varid'>t1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>inferType'</span> <span class='hs-varid'>nds</span> <span class='hs-varid'>e1</span>
<a name="line-379"></a>        <span class='hs-varid'>eq'</span> <span class='hs-varid'>nds</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span>
<a name="line-380"></a>    <span class='hs-varid'>boxCompat</span> <span class='hs-layout'>(</span><span class='hs-conid'>ELit</span> <span class='hs-layout'>(</span><span class='hs-conid'>LitCons</span> <span class='hs-layout'>{</span> <span class='hs-varid'>litName</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>  <span class='hs-varid'>t</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>fromConjured</span> <span class='hs-varid'>modBox</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>e</span> <span class='hs-varop'>==</span> <span class='hs-varid'>getType</span> <span class='hs-varid'>t</span>
<a name="line-381"></a>    <span class='hs-varid'>boxCompat</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-382"></a>
<a name="line-383"></a><a name="DataTable"></a><span class='hs-comment'>-- This should perform a full typecheck and may take any extra information needed as an extra parameter</span>
<a name="line-384"></a><a name="DataTable"></a><span class='hs-keyword'>class</span> <span class='hs-conid'>CanTypeCheck</span> <span class='hs-varid'>a</span> <span class='hs-keyword'>where</span>
<a name="line-385"></a>    <span class='hs-varid'>typecheck</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Monad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>DataTable</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>E</span>
<a name="line-386"></a>
<a name="line-387"></a><a name="infertype"></a><span class='hs-definition'>infertype</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CanTypeCheck</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>DataTable</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>E</span>
<a name="line-388"></a><span class='hs-definition'>infertype</span> <span class='hs-varid'>env</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>typecheck</span> <span class='hs-varid'>env</span> <span class='hs-varid'>a</span> <span class='hs-keyword'>of</span>
<a name="line-389"></a>    <span class='hs-conid'>Left</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>error</span> <span class='hs-varop'>$</span> <span class='hs-str'>"infertype: "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>s</span>
<a name="line-390"></a>    <span class='hs-conid'>Right</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>x</span>
<a name="line-391"></a>
<a name="line-392"></a><a name="instance%20CanTypeCheck%20E"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>CanTypeCheck</span> <span class='hs-conid'>E</span> <span class='hs-keyword'>where</span>
<a name="line-393"></a>    <span class='hs-varid'>typecheck</span> <span class='hs-varid'>dataTable</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>runContextEither</span> <span class='hs-varop'>$</span> <span class='hs-varid'>typeInfer''</span> <span class='hs-varid'>dataTable</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>e</span> <span class='hs-keyword'>of</span>
<a name="line-394"></a>        <span class='hs-conid'>Left</span> <span class='hs-varid'>ss</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>fail</span> <span class='hs-varop'>$</span> <span class='hs-str'>"\n&gt;&gt;&gt; internal error:\n"</span> <span class='hs-varop'>++</span> <span class='hs-varid'>unlines</span> <span class='hs-varid'>ss</span>
<a name="line-395"></a>        <span class='hs-conid'>Right</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>v</span>
<a name="line-396"></a>
<a name="line-397"></a><a name="instance%20CanTypeCheck%20TVr"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>CanTypeCheck</span> <span class='hs-conid'>TVr</span> <span class='hs-keyword'>where</span>
<a name="line-398"></a>    <span class='hs-varid'>typecheck</span> <span class='hs-varid'>dt</span> <span class='hs-varid'>tvr</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-399"></a>        <span class='hs-varid'>typecheck</span> <span class='hs-varid'>dt</span> <span class='hs-layout'>(</span><span class='hs-varid'>getType</span> <span class='hs-varid'>tvr</span><span class='hs-layout'>)</span>
<a name="line-400"></a>        <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>getType</span> <span class='hs-varid'>tvr</span>
<a name="line-401"></a>
<a name="line-402"></a><a name="instance%20CanTypeCheck%20(Lit%20a%20E)"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>CanTypeCheck</span> <span class='hs-layout'>(</span><span class='hs-conid'>Lit</span> <span class='hs-varid'>a</span> <span class='hs-conid'>E</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-403"></a>    <span class='hs-varid'>typecheck</span>  <span class='hs-varid'>dt</span> <span class='hs-conid'>LitCons</span> <span class='hs-layout'>{</span> <span class='hs-varid'>litType</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>t</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>typecheck</span> <span class='hs-varid'>dt</span> <span class='hs-varid'>t</span> <span class='hs-varop'>&gt;&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>t</span>
<a name="line-404"></a>    <span class='hs-varid'>typecheck</span>  <span class='hs-varid'>dt</span> <span class='hs-conid'>LitInt</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>litType</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>t</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>typecheck</span> <span class='hs-varid'>dt</span> <span class='hs-varid'>t</span> <span class='hs-varop'>&gt;&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>t</span>
<a name="line-405"></a>
<a name="line-406"></a><a name="instance%20CanTypeCheck%20(Alt%20E)"></a><span class='hs-comment'>-- TODO, types might be bound in scrutinization</span>
<a name="line-407"></a><a name="instance%20CanTypeCheck%20(Alt%20E)"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>CanTypeCheck</span> <span class='hs-layout'>(</span><span class='hs-conid'>Alt</span> <span class='hs-conid'>E</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-408"></a>    <span class='hs-varid'>typecheck</span> <span class='hs-varid'>dt</span> <span class='hs-layout'>(</span><span class='hs-conid'>Alt</span> <span class='hs-varid'>l</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>typecheck</span> <span class='hs-varid'>dt</span> <span class='hs-varid'>l</span> <span class='hs-varop'>&gt;&gt;</span> <span class='hs-varid'>typecheck</span> <span class='hs-varid'>dt</span> <span class='hs-varid'>e</span>
<a name="line-409"></a>
<a name="line-410"></a><span class='hs-comment'>-- | Determine type of term using full algorithm with substitutions. This</span>
<a name="line-411"></a><span class='hs-comment'>-- should be used instead of 'typ' when let-bound type variables exist or you</span>
<a name="line-412"></a><span class='hs-comment'>-- wish a more thorough checking of types.</span>
<a name="line-413"></a>
<a name="line-414"></a><a name="typeInfer"></a><span class='hs-definition'>typeInfer</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DataTable</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>E</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>E</span>
<a name="line-415"></a><span class='hs-definition'>typeInfer</span> <span class='hs-varid'>dataTable</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>runContextEither</span> <span class='hs-varop'>$</span> <span class='hs-varid'>typeInfer''</span> <span class='hs-varid'>dataTable</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>e</span> <span class='hs-keyword'>of</span>
<a name="line-416"></a>    <span class='hs-conid'>Left</span> <span class='hs-varid'>ss</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>error</span> <span class='hs-varop'>$</span> <span class='hs-str'>"\n&gt;&gt;&gt; internal error:\n"</span> <span class='hs-varop'>++</span> <span class='hs-varid'>unlines</span> <span class='hs-layout'>(</span><span class='hs-varid'>tail</span> <span class='hs-varid'>ss</span><span class='hs-layout'>)</span>
<a name="line-417"></a>    <span class='hs-conid'>Right</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>v</span>
<a name="line-418"></a>
<a name="line-419"></a><a name="typeInfer'"></a><span class='hs-definition'>typeInfer'</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DataTable</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>TVr</span><span class='hs-layout'>,</span><span class='hs-conid'>E</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>E</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>E</span>
<a name="line-420"></a><span class='hs-definition'>typeInfer'</span> <span class='hs-varid'>dataTable</span> <span class='hs-varid'>ds</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>runContextEither</span> <span class='hs-varop'>$</span> <span class='hs-varid'>typeInfer''</span> <span class='hs-varid'>dataTable</span> <span class='hs-varid'>ds</span> <span class='hs-varid'>e</span> <span class='hs-keyword'>of</span>
<a name="line-421"></a>    <span class='hs-conid'>Left</span> <span class='hs-varid'>ss</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>error</span> <span class='hs-varop'>$</span> <span class='hs-str'>"\n&gt;&gt;&gt; internal error:\n"</span> <span class='hs-varop'>++</span> <span class='hs-varid'>unlines</span> <span class='hs-layout'>(</span><span class='hs-varid'>tail</span> <span class='hs-varid'>ss</span><span class='hs-layout'>)</span>
<a name="line-422"></a>    <span class='hs-conid'>Right</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>v</span>
<a name="line-423"></a>
<a name="line-424"></a><a name="TcEnv"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>TcEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcEnv</span> <span class='hs-layout'>{</span>
<a name="line-425"></a>    <span class='hs-comment'>--tcDefns :: [(TVr,E)],</span>
<a name="line-426"></a>    <span class='hs-varid'>tcContext</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span>
<a name="line-427"></a>    <span class='hs-comment'>--tcDataTable :: DataTable</span>
<a name="line-428"></a>    <span class='hs-layout'>}</span>
<a name="line-429"></a>
<a name="line-430"></a><a name="tcContext_u"></a><span class='hs-definition'>tcContext_u</span> <span class='hs-varid'>f</span> <span class='hs-varid'>r</span><span class='hs-keyglyph'>@</span><span class='hs-conid'>TcEnv</span><span class='hs-layout'>{</span><span class='hs-varid'>tcContext</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>x</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>r</span><span class='hs-layout'>{</span><span class='hs-varid'>tcContext</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>f</span> <span class='hs-varid'>x</span><span class='hs-layout'>}</span>
<a name="line-431"></a>
<a name="line-432"></a><a name="Tc"></a><span class='hs-keyword'>newtype</span> <span class='hs-conid'>Tc</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Tc</span> <span class='hs-layout'>(</span><span class='hs-conid'>Reader</span> <span class='hs-conid'>TcEnv</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-433"></a>    <span class='hs-keyword'>deriving</span><span class='hs-layout'>(</span><span class='hs-conid'>Monad</span><span class='hs-layout'>,</span><span class='hs-conid'>Functor</span><span class='hs-layout'>,</span><span class='hs-conid'>MonadReader</span> <span class='hs-conid'>TcEnv</span><span class='hs-layout'>)</span>
<a name="line-434"></a>
<a name="line-435"></a><a name="instance%20ContextMonad%20Tc"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>ContextMonad</span> <span class='hs-conid'>Tc</span> <span class='hs-keyword'>where</span>
<a name="line-436"></a>    <span class='hs-keyword'>type</span> <span class='hs-conid'>ContextOf</span> <span class='hs-conid'>Tc</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>String</span>
<a name="line-437"></a>    <span class='hs-varid'>withContext</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>local</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcContext_u</span> <span class='hs-layout'>(</span><span class='hs-varid'>s</span><span class='hs-conop'>:</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-438"></a>
<a name="line-439"></a><span class='hs-comment'>{-
<a name="line-440"></a>tcE :: E -&gt; Tc E
<a name="line-441"></a>tcE e = rfc e where
<a name="line-442"></a>    rfc e =  withContextDoc (text "tcE:" &lt;/&gt; ePretty e) (fc e &gt;&gt;=  strong')
<a name="line-443"></a>    strong' e = do
<a name="line-444"></a>        ds &lt;- asks tcDefns
<a name="line-445"></a>        withContextDoc (text "tcE.strong:" &lt;/&gt; ePretty e) $ strong ds e
<a name="line-446"></a>
<a name="line-447"></a>    fc s@ESort {} = return $ getType s
<a name="line-448"></a>    fc (ELit LitCons { litType = t }) = strong' t
<a name="line-449"></a>    fc e@ELit {} = strong' (getType e)
<a name="line-450"></a>    fc (EVar TVr { tvrIdent = eid }) | eid == emptyId = fail "variable with nothing!"
<a name="line-451"></a>    fc (EVar TVr { tvrType =  t}) =  strong' t
<a name="line-452"></a>    fc (EPi TVr { tvrIdent = n, tvrType = at} b) =  do
<a name="line-453"></a>        ESort a &lt;- rfc at
<a name="line-454"></a>        ESort b &lt;- local (tcDefns_u (\ds -&gt; [ d | d@(v,_) &lt;- ds, tvrIdent v /= n ])) $ rfc b
<a name="line-455"></a>        liftM ESort $ monadicLookup (a,b) ptsRulesMap
<a name="line-456"></a>    fc (ELam tvr@TVr { tvrIdent = n, tvrType =  at} b) = do
<a name="line-457"></a>        at' &lt;- strong' at
<a name="line-458"></a>        b' &lt;- local (tcDefns_u (\ds -&gt; [ d | d@(v,_) &lt;- ds, tvrIdent v /= n ])) $ rfc b
<a name="line-459"></a>        return (EPi (tVr n at') b')
<a name="line-460"></a>    fc (EAp (EPi tvr e) b) = do
<a name="line-461"></a>        b &lt;- strong' b
<a name="line-462"></a>        rfc (subst tvr b e)
<a name="line-463"></a>    fc (EAp (ELit lc@LitCons { litAliasFor = Just af }) b) = fc (EAp (foldl eAp af (litArgs lc)) b)
<a name="line-464"></a>    fc (EAp a b) = do
<a name="line-465"></a>        a' &lt;- rfc a
<a name="line-466"></a>        if a' == tBox then return tBox else strong' (eAp a' b)
<a name="line-467"></a>    fc (ELetRec vs e) = local (tcDefns_u (vs ++)) $ rfc e
<a name="line-468"></a>    fc (EError _ e) = strong' e
<a name="line-469"></a>    fc (EPrim _ ts t) = strong' t
<a name="line-470"></a>    fc ECase { eCaseType = ty } = do
<a name="line-471"></a>        strong' ty
<a name="line-472"></a>    fc Unknown = return Unknown
<a name="line-473"></a>    fc e = failDoc $ text "what's this? " &lt;/&gt; (ePretty e)
<a name="line-474"></a>-}</span>
<a name="line-475"></a>
<a name="line-476"></a><a name="typeInfer''"></a><span class='hs-definition'>typeInfer''</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>ContextMonad</span> <span class='hs-varid'>m</span><span class='hs-layout'>,</span> <span class='hs-conid'>ContextOf</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>~</span> <span class='hs-conid'>String</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>DataTable</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>TVr</span><span class='hs-layout'>,</span><span class='hs-conid'>E</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>E</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>E</span>
<a name="line-477"></a><span class='hs-definition'>typeInfer''</span> <span class='hs-varid'>dataTable</span> <span class='hs-varid'>ds</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rfc</span> <span class='hs-varid'>e</span> <span class='hs-keyword'>where</span>
<a name="line-478"></a>    <span class='hs-varid'>inferType'</span> <span class='hs-varid'>ds</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>typeInfer''</span> <span class='hs-varid'>dataTable</span> <span class='hs-varid'>ds</span> <span class='hs-varid'>e</span>
<a name="line-479"></a>    <span class='hs-varid'>rfc</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>withContextDoc</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"fullCheck':"</span> <span class='hs-varop'>&lt;/&gt;</span> <span class='hs-varid'>ePretty</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>fc</span> <span class='hs-varid'>e</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-varid'>strong'</span><span class='hs-layout'>)</span>
<a name="line-480"></a>    <span class='hs-varid'>rfc'</span> <span class='hs-varid'>nds</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>withContextDoc</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"fullCheck':"</span> <span class='hs-varop'>&lt;/&gt;</span> <span class='hs-varid'>ePretty</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>inferType'</span> <span class='hs-varid'>nds</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-481"></a>    <span class='hs-varid'>strong'</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withContextDoc</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Strong':"</span> <span class='hs-varop'>&lt;/&gt;</span> <span class='hs-varid'>ePretty</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>strong</span> <span class='hs-varid'>ds</span> <span class='hs-varid'>e</span>
<a name="line-482"></a>    <span class='hs-varid'>fc</span> <span class='hs-varid'>s</span><span class='hs-keyglyph'>@</span><span class='hs-conid'>ESort</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>getType</span> <span class='hs-varid'>s</span>
<a name="line-483"></a>    <span class='hs-varid'>fc</span> <span class='hs-layout'>(</span><span class='hs-conid'>ELit</span> <span class='hs-conid'>LitCons</span> <span class='hs-layout'>{</span> <span class='hs-varid'>litType</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>t</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>strong'</span> <span class='hs-varid'>t</span>
<a name="line-484"></a>    <span class='hs-varid'>fc</span> <span class='hs-varid'>e</span><span class='hs-keyglyph'>@</span><span class='hs-conid'>ELit</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>strong'</span> <span class='hs-layout'>(</span><span class='hs-varid'>getType</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-485"></a>    <span class='hs-varid'>fc</span> <span class='hs-layout'>(</span><span class='hs-conid'>EVar</span> <span class='hs-conid'>TVr</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tvrIdent</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eid</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>eid</span> <span class='hs-varop'>==</span> <span class='hs-varid'>emptyId</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fail</span> <span class='hs-str'>"variable with nothing!"</span>
<a name="line-486"></a>    <span class='hs-varid'>fc</span> <span class='hs-layout'>(</span><span class='hs-conid'>EVar</span> <span class='hs-conid'>TVr</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tvrType</span> <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>t</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>strong'</span> <span class='hs-varid'>t</span>
<a name="line-487"></a>    <span class='hs-varid'>fc</span> <span class='hs-layout'>(</span><span class='hs-conid'>EPi</span> <span class='hs-conid'>TVr</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tvrIdent</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-varid'>tvrType</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>at</span><span class='hs-layout'>}</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>  <span class='hs-keyword'>do</span>
<a name="line-488"></a>        <span class='hs-conid'>ESort</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rfc</span> <span class='hs-varid'>at</span>
<a name="line-489"></a>        <span class='hs-conid'>ESort</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rfc'</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>d</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>d</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-varid'>v</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ds</span><span class='hs-layout'>,</span> <span class='hs-varid'>tvrIdent</span> <span class='hs-varid'>v</span> <span class='hs-varop'>/=</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>]</span> <span class='hs-varid'>b</span>
<a name="line-490"></a>        <span class='hs-varid'>liftM</span> <span class='hs-conid'>ESort</span> <span class='hs-varop'>$</span> <span class='hs-varid'>monadicLookup</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span><span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-varid'>ptsRulesMap</span>
<a name="line-491"></a>    <span class='hs-varid'>fc</span> <span class='hs-layout'>(</span><span class='hs-conid'>ELam</span> <span class='hs-varid'>tvr</span><span class='hs-keyglyph'>@</span><span class='hs-conid'>TVr</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tvrIdent</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-varid'>tvrType</span> <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>at</span><span class='hs-layout'>}</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-492"></a>        <span class='hs-varid'>at'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>strong'</span> <span class='hs-varid'>at</span>
<a name="line-493"></a>        <span class='hs-varid'>b'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rfc'</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>d</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>d</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-varid'>v</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ds</span><span class='hs-layout'>,</span> <span class='hs-varid'>tvrIdent</span> <span class='hs-varid'>v</span> <span class='hs-varop'>/=</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>]</span> <span class='hs-varid'>b</span>
<a name="line-494"></a>        <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>EPi</span> <span class='hs-layout'>(</span><span class='hs-varid'>tVr</span> <span class='hs-varid'>n</span> <span class='hs-varid'>at'</span><span class='hs-layout'>)</span> <span class='hs-varid'>b'</span><span class='hs-layout'>)</span>
<a name="line-495"></a>    <span class='hs-varid'>fc</span> <span class='hs-layout'>(</span><span class='hs-conid'>EAp</span> <span class='hs-layout'>(</span><span class='hs-conid'>EPi</span> <span class='hs-varid'>tvr</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-496"></a>        <span class='hs-varid'>b</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>strong'</span> <span class='hs-varid'>b</span>
<a name="line-497"></a>        <span class='hs-varid'>rfc</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst</span> <span class='hs-varid'>tvr</span> <span class='hs-varid'>b</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-498"></a>    <span class='hs-varid'>fc</span> <span class='hs-layout'>(</span><span class='hs-conid'>EAp</span> <span class='hs-layout'>(</span><span class='hs-conid'>ELit</span> <span class='hs-varid'>lc</span><span class='hs-keyglyph'>@</span><span class='hs-conid'>LitCons</span> <span class='hs-layout'>{</span> <span class='hs-varid'>litAliasFor</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>af</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fc</span> <span class='hs-layout'>(</span><span class='hs-conid'>EAp</span> <span class='hs-layout'>(</span><span class='hs-varid'>foldl</span> <span class='hs-varid'>eAp</span> <span class='hs-varid'>af</span> <span class='hs-layout'>(</span><span class='hs-varid'>litArgs</span> <span class='hs-varid'>lc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>
<a name="line-499"></a>    <span class='hs-varid'>fc</span> <span class='hs-layout'>(</span><span class='hs-conid'>EAp</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-500"></a>        <span class='hs-varid'>a'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rfc</span> <span class='hs-varid'>a</span>
<a name="line-501"></a>        <span class='hs-keyword'>if</span> <span class='hs-varid'>a'</span> <span class='hs-varop'>==</span> <span class='hs-varid'>tBox</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-varid'>tBox</span> <span class='hs-keyword'>else</span> <span class='hs-varid'>strong'</span> <span class='hs-layout'>(</span><span class='hs-varid'>eAp</span> <span class='hs-varid'>a'</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>
<a name="line-502"></a>    <span class='hs-varid'>fc</span> <span class='hs-layout'>(</span><span class='hs-conid'>ELetRec</span> <span class='hs-varid'>vs</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-503"></a>        <span class='hs-keyword'>let</span> <span class='hs-varid'>nds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vs</span> <span class='hs-varop'>++</span> <span class='hs-varid'>ds</span>
<a name="line-504"></a>        <span class='hs-comment'>--et &lt;- inferType' nds e</span>
<a name="line-505"></a>        <span class='hs-comment'>--strong nds et</span>
<a name="line-506"></a>        <span class='hs-varid'>inferType'</span> <span class='hs-varid'>nds</span> <span class='hs-varid'>e</span>
<a name="line-507"></a>    <span class='hs-varid'>fc</span> <span class='hs-layout'>(</span><span class='hs-conid'>EError</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>strong'</span> <span class='hs-varid'>e</span>
<a name="line-508"></a>    <span class='hs-varid'>fc</span> <span class='hs-layout'>(</span><span class='hs-conid'>EPrim</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ts</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>strong'</span> <span class='hs-varid'>t</span>
<a name="line-509"></a>    <span class='hs-varid'>fc</span> <span class='hs-conid'>ECase</span> <span class='hs-layout'>{</span> <span class='hs-varid'>eCaseType</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-510"></a>        <span class='hs-varid'>strong'</span> <span class='hs-varid'>ty</span>
<a name="line-511"></a>    <span class='hs-varid'>fc</span> <span class='hs-conid'>Unknown</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Unknown</span>
<a name="line-512"></a>    <span class='hs-comment'>--fc e = failDoc $ text "what's this? " &lt;/&gt; (ePretty e)</span>
<a name="line-513"></a>
<a name="line-514"></a><span class='hs-comment'>-- | find substitution that will transform the left term into the right one,</span>
<a name="line-515"></a><span class='hs-comment'>-- only substituting for the vars in the list</span>
<a name="line-516"></a>
<a name="line-517"></a><a name="match"></a><span class='hs-definition'>match</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Monad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span>
<a name="line-518"></a>    <span class='hs-layout'>(</span><span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>E</span><span class='hs-layout'>)</span>      <span class='hs-comment'>-- ^ function to look up values in the environment</span>
<a name="line-519"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TVr</span><span class='hs-keyglyph'>]</span>              <span class='hs-comment'>-- ^ vars which may be substituted</span>
<a name="line-520"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>E</span>                  <span class='hs-comment'>-- ^ pattern to match</span>
<a name="line-521"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>E</span>                  <span class='hs-comment'>-- ^ input expression</span>
<a name="line-522"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>TVr</span><span class='hs-layout'>,</span><span class='hs-conid'>E</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-523"></a><span class='hs-definition'>match</span> <span class='hs-varid'>lup</span> <span class='hs-varid'>vs</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>e1</span> <span class='hs-varid'>e2</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>liftM</span> <span class='hs-conid'>Seq</span><span class='hs-varop'>.</span><span class='hs-varid'>toList</span> <span class='hs-varop'>$</span> <span class='hs-varid'>execWriterT</span> <span class='hs-layout'>(</span><span class='hs-varid'>un</span> <span class='hs-varid'>e1</span> <span class='hs-varid'>e2</span> <span class='hs-varid'>etherealIds</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-524"></a>    <span class='hs-varid'>bvs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IdSet</span>
<a name="line-525"></a>    <span class='hs-varid'>bvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fromList</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>tvrIdent</span> <span class='hs-varid'>vs</span><span class='hs-layout'>)</span>
<a name="line-526"></a>
<a name="line-527"></a>    <span class='hs-varid'>un</span> <span class='hs-layout'>(</span><span class='hs-conid'>EAp</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>EAp</span> <span class='hs-varid'>a'</span> <span class='hs-varid'>b'</span><span class='hs-layout'>)</span> <span class='hs-varid'>c</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-528"></a>        <span class='hs-varid'>un</span> <span class='hs-varid'>a</span> <span class='hs-varid'>a'</span> <span class='hs-varid'>c</span>
<a name="line-529"></a>        <span class='hs-varid'>un</span> <span class='hs-varid'>b</span> <span class='hs-varid'>b'</span> <span class='hs-varid'>c</span>
<a name="line-530"></a>    <span class='hs-varid'>un</span> <span class='hs-layout'>(</span><span class='hs-conid'>ELam</span> <span class='hs-varid'>va</span> <span class='hs-varid'>ea</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>ELam</span> <span class='hs-varid'>vb</span> <span class='hs-varid'>eb</span><span class='hs-layout'>)</span> <span class='hs-varid'>c</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lam</span> <span class='hs-varid'>va</span> <span class='hs-varid'>ea</span> <span class='hs-varid'>vb</span> <span class='hs-varid'>eb</span> <span class='hs-varid'>c</span>
<a name="line-531"></a>    <span class='hs-varid'>un</span> <span class='hs-layout'>(</span><span class='hs-conid'>EPi</span> <span class='hs-varid'>va</span> <span class='hs-varid'>ea</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>EPi</span> <span class='hs-varid'>vb</span> <span class='hs-varid'>eb</span><span class='hs-layout'>)</span> <span class='hs-varid'>c</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lam</span> <span class='hs-varid'>va</span> <span class='hs-varid'>ea</span> <span class='hs-varid'>vb</span> <span class='hs-varid'>eb</span> <span class='hs-varid'>c</span>
<a name="line-532"></a>    <span class='hs-varid'>un</span> <span class='hs-layout'>(</span><span class='hs-conid'>EPi</span> <span class='hs-varid'>va</span> <span class='hs-varid'>ea</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>ELit</span> <span class='hs-conid'>LitCons</span> <span class='hs-layout'>{</span> <span class='hs-varid'>litName</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ar</span><span class='hs-layout'>,</span> <span class='hs-varid'>litArgs</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>x</span><span class='hs-layout'>,</span><span class='hs-varid'>y</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>litType</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lt</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>c</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>ar</span> <span class='hs-varop'>==</span> <span class='hs-varid'>tc_Arrow</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-533"></a>        <span class='hs-varid'>un</span> <span class='hs-layout'>(</span><span class='hs-varid'>tvrType</span> <span class='hs-varid'>va</span><span class='hs-layout'>)</span> <span class='hs-varid'>x</span> <span class='hs-varid'>c</span>
<a name="line-534"></a>        <span class='hs-varid'>un</span> <span class='hs-varid'>ea</span> <span class='hs-varid'>y</span> <span class='hs-varid'>c</span>
<a name="line-535"></a>    <span class='hs-varid'>un</span> <span class='hs-layout'>(</span><span class='hs-conid'>EPrim</span> <span class='hs-varid'>s</span> <span class='hs-varid'>xs</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>EPrim</span> <span class='hs-varid'>s'</span> <span class='hs-varid'>ys</span> <span class='hs-varid'>t'</span><span class='hs-layout'>)</span> <span class='hs-varid'>c</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>length</span> <span class='hs-varid'>xs</span> <span class='hs-varop'>==</span> <span class='hs-varid'>length</span> <span class='hs-varid'>ys</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-536"></a>        <span class='hs-varid'>sequence_</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>un</span> <span class='hs-varid'>x</span> <span class='hs-varid'>y</span> <span class='hs-varid'>c</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xs</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>y</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ys</span><span class='hs-keyglyph'>]</span>
<a name="line-537"></a>        <span class='hs-varid'>un</span> <span class='hs-varid'>t</span> <span class='hs-varid'>t'</span> <span class='hs-varid'>c</span>
<a name="line-538"></a>    <span class='hs-varid'>un</span> <span class='hs-layout'>(</span><span class='hs-conid'>ESort</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>ESort</span> <span class='hs-varid'>y</span><span class='hs-layout'>)</span> <span class='hs-varid'>c</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>x</span> <span class='hs-varop'>==</span> <span class='hs-varid'>y</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-539"></a>    <span class='hs-varid'>un</span> <span class='hs-layout'>(</span><span class='hs-conid'>ELit</span> <span class='hs-layout'>(</span><span class='hs-conid'>LitInt</span> <span class='hs-varid'>x</span> <span class='hs-varid'>t1</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>  <span class='hs-layout'>(</span><span class='hs-conid'>ELit</span> <span class='hs-layout'>(</span><span class='hs-conid'>LitInt</span> <span class='hs-varid'>y</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>c</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>x</span> <span class='hs-varop'>==</span> <span class='hs-varid'>y</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>un</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span> <span class='hs-varid'>c</span>
<a name="line-540"></a>    <span class='hs-varid'>un</span> <span class='hs-layout'>(</span><span class='hs-conid'>ELit</span> <span class='hs-conid'>LitCons</span> <span class='hs-layout'>{</span> <span class='hs-varid'>litName</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-varid'>litArgs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>xs</span><span class='hs-layout'>,</span> <span class='hs-varid'>litType</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>t</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>  <span class='hs-layout'>(</span><span class='hs-conid'>ELit</span> <span class='hs-conid'>LitCons</span> <span class='hs-layout'>{</span> <span class='hs-varid'>litName</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n'</span><span class='hs-layout'>,</span> <span class='hs-varid'>litArgs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ys</span><span class='hs-layout'>,</span> <span class='hs-varid'>litType</span> <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>t'</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>c</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>n</span> <span class='hs-varop'>==</span> <span class='hs-varid'>n'</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>length</span> <span class='hs-varid'>xs</span> <span class='hs-varop'>==</span> <span class='hs-varid'>length</span> <span class='hs-varid'>ys</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-541"></a>        <span class='hs-varid'>sequence_</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>un</span> <span class='hs-varid'>x</span> <span class='hs-varid'>y</span> <span class='hs-varid'>c</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xs</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>y</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ys</span><span class='hs-keyglyph'>]</span>
<a name="line-542"></a>        <span class='hs-varid'>un</span> <span class='hs-varid'>t</span> <span class='hs-varid'>t'</span> <span class='hs-varid'>c</span>
<a name="line-543"></a>
<a name="line-544"></a>    <span class='hs-varid'>un</span> <span class='hs-layout'>(</span><span class='hs-conid'>EVar</span> <span class='hs-conid'>TVr</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tvrIdent</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>i</span><span class='hs-layout'>,</span> <span class='hs-varid'>tvrType</span> <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>t</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>EVar</span> <span class='hs-conid'>TVr</span> <span class='hs-layout'>{</span><span class='hs-varid'>tvrIdent</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>j</span><span class='hs-layout'>,</span> <span class='hs-varid'>tvrType</span> <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>u</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>c</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>i</span> <span class='hs-varop'>==</span> <span class='hs-varid'>j</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>un</span> <span class='hs-varid'>t</span> <span class='hs-varid'>u</span> <span class='hs-varid'>c</span>
<a name="line-545"></a>    <span class='hs-varid'>un</span> <span class='hs-layout'>(</span><span class='hs-conid'>EVar</span> <span class='hs-conid'>TVr</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tvrIdent</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>i</span><span class='hs-layout'>,</span> <span class='hs-varid'>tvrType</span> <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>t</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>EVar</span> <span class='hs-conid'>TVr</span> <span class='hs-layout'>{</span><span class='hs-varid'>tvrIdent</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>j</span><span class='hs-layout'>,</span> <span class='hs-varid'>tvrType</span> <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>u</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>c</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isEtherealId</span> <span class='hs-varid'>i</span> <span class='hs-varop'>||</span> <span class='hs-varid'>isEtherealId</span> <span class='hs-varid'>j</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fail</span> <span class='hs-str'>"Expressions don't match"</span>
<a name="line-546"></a>    <span class='hs-varid'>un</span> <span class='hs-layout'>(</span><span class='hs-conid'>EAp</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>ELit</span> <span class='hs-varid'>lc</span><span class='hs-keyglyph'>@</span><span class='hs-conid'>LitCons</span> <span class='hs-layout'>{</span> <span class='hs-varid'>litArgs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bas</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>litType</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>t</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>c</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-547"></a>        <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>al</span><span class='hs-conop'>:</span><span class='hs-keyword'>as</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reverse</span> <span class='hs-varid'>bas</span>
<a name="line-548"></a>        <span class='hs-varid'>un</span> <span class='hs-varid'>a</span> <span class='hs-layout'>(</span><span class='hs-conid'>ELit</span> <span class='hs-varid'>lc</span> <span class='hs-layout'>{</span> <span class='hs-varid'>litArgs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reverse</span> <span class='hs-keyword'>as</span><span class='hs-layout'>,</span> <span class='hs-varid'>litType</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ePi</span> <span class='hs-varid'>tvr</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tvrType</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getType</span> <span class='hs-varid'>al</span> <span class='hs-layout'>}</span> <span class='hs-varid'>t</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>c</span>
<a name="line-549"></a>        <span class='hs-varid'>un</span> <span class='hs-varid'>b</span> <span class='hs-varid'>al</span> <span class='hs-varid'>c</span>
<a name="line-550"></a>    <span class='hs-varid'>un</span> <span class='hs-layout'>(</span><span class='hs-conid'>EAp</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>EPi</span> <span class='hs-conid'>TVr</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tvrType</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>a1</span> <span class='hs-layout'>}</span> <span class='hs-varid'>a2</span><span class='hs-layout'>)</span> <span class='hs-varid'>c</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-551"></a>        <span class='hs-varid'>un</span> <span class='hs-varid'>a</span> <span class='hs-layout'>(</span><span class='hs-conid'>ELit</span> <span class='hs-varid'>litCons</span> <span class='hs-layout'>{</span> <span class='hs-varid'>litArgs</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a1</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>litName</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc_Arrow</span><span class='hs-layout'>,</span> <span class='hs-varid'>litType</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EPi</span> <span class='hs-varid'>tvr</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tvrType</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getType</span> <span class='hs-varid'>a2</span> <span class='hs-layout'>}</span> <span class='hs-layout'>(</span><span class='hs-varid'>getType</span> <span class='hs-varid'>a1</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>c</span>
<a name="line-552"></a>        <span class='hs-varid'>un</span> <span class='hs-varid'>b</span> <span class='hs-varid'>a2</span> <span class='hs-varid'>c</span>
<a name="line-553"></a>    <span class='hs-varid'>un</span> <span class='hs-layout'>(</span><span class='hs-conid'>EVar</span> <span class='hs-varid'>tvr</span><span class='hs-keyglyph'>@</span><span class='hs-conid'>TVr</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tvrIdent</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>i</span><span class='hs-layout'>,</span> <span class='hs-varid'>tvrType</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>t</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>b</span> <span class='hs-varid'>c</span>
<a name="line-554"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>i</span> <span class='hs-varop'>`member`</span> <span class='hs-varid'>bvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tell</span> <span class='hs-layout'>(</span><span class='hs-conid'>Seq</span><span class='hs-varop'>.</span><span class='hs-varid'>single</span> <span class='hs-layout'>(</span><span class='hs-varid'>tvr</span><span class='hs-layout'>,</span><span class='hs-varid'>b</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-555"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fail</span> <span class='hs-varop'>$</span> <span class='hs-str'>"Expressions do not unify: "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>tvr</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>b</span>
<a name="line-556"></a>    <span class='hs-varid'>un</span> <span class='hs-varid'>a</span> <span class='hs-layout'>(</span><span class='hs-conid'>EVar</span> <span class='hs-varid'>tvr</span><span class='hs-layout'>)</span> <span class='hs-varid'>c</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lup</span> <span class='hs-layout'>(</span><span class='hs-varid'>tvrIdent</span> <span class='hs-varid'>tvr</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>not</span> <span class='hs-varop'>$</span> <span class='hs-varid'>isEVar</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>un</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span> <span class='hs-varid'>c</span>
<a name="line-557"></a>    <span class='hs-comment'>--un a b c | Just a' &lt;- followAlias undefined a = un a' b c</span>
<a name="line-558"></a>    <span class='hs-varid'>un</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span> <span class='hs-varid'>c</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>b'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>followAlias</span> <span class='hs-varid'>undefined</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>un</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b'</span> <span class='hs-varid'>c</span>
<a name="line-559"></a>
<a name="line-560"></a>    <span class='hs-varid'>un</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fail</span> <span class='hs-varop'>$</span> <span class='hs-str'>"Expressions do not unify: "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>a</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>b</span>
<a name="line-561"></a>    <span class='hs-varid'>lam</span> <span class='hs-varid'>va</span> <span class='hs-varid'>ea</span> <span class='hs-varid'>vb</span> <span class='hs-varid'>eb</span> <span class='hs-layout'>(</span><span class='hs-varid'>c</span><span class='hs-conop'>:</span><span class='hs-varid'>cs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-562"></a>        <span class='hs-varid'>un</span> <span class='hs-layout'>(</span><span class='hs-varid'>tvrType</span> <span class='hs-varid'>va</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>tvrType</span> <span class='hs-varid'>vb</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>c</span><span class='hs-conop'>:</span><span class='hs-varid'>cs</span><span class='hs-layout'>)</span>
<a name="line-563"></a>        <span class='hs-varid'>un</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst</span> <span class='hs-varid'>va</span> <span class='hs-layout'>(</span><span class='hs-conid'>EVar</span> <span class='hs-varid'>va</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tvrIdent</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>c</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>ea</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst</span> <span class='hs-varid'>vb</span> <span class='hs-layout'>(</span><span class='hs-conid'>EVar</span> <span class='hs-varid'>vb</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tvrIdent</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>c</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>eb</span><span class='hs-layout'>)</span> <span class='hs-varid'>cs</span>
<a name="line-564"></a>    <span class='hs-varid'>lam</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>error</span> <span class='hs-str'>"TypeCheck.match: bad."</span>
<a name="line-565"></a><span class='hs-comment'>{-* Generated by DrIFT : Look, but Don't Touch. *-}</span>
<a name="line-566"></a><span class='hs-comment'>--  Imported from other files :-</span>
</pre></body>
</html>
