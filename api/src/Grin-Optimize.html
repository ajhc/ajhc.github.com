<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>src/Grin/Optimize.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>Grin</span><span class='hs-varop'>.</span><span class='hs-conid'>Optimize</span><span class='hs-layout'>(</span><span class='hs-varid'>grinPush</span><span class='hs-layout'>,</span><span class='hs-varid'>grinSpeculate</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-2"></a>
<a name="line-3"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span><span class='hs-varop'>.</span><span class='hs-conid'>State</span>
<a name="line-4"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>List</span>
<a name="line-5"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Set</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>Set</span>
<a name="line-6"></a>
<a name="line-7"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>C</span><span class='hs-varop'>.</span><span class='hs-conid'>Prims</span>
<a name="line-8"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Grin</span><span class='hs-varop'>.</span><span class='hs-conid'>Grin</span>
<a name="line-9"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Grin</span><span class='hs-varop'>.</span><span class='hs-conid'>Noodle</span>
<a name="line-10"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Options</span> <span class='hs-layout'>(</span><span class='hs-varid'>verbose</span><span class='hs-layout'>)</span>
<a name="line-11"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Stats</span> <span class='hs-varid'>hiding</span><span class='hs-layout'>(</span><span class='hs-varid'>null</span><span class='hs-layout'>,</span><span class='hs-varid'>isEmpty</span><span class='hs-layout'>)</span>
<a name="line-12"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>StringTable</span><span class='hs-varop'>.</span><span class='hs-conid'>Atom</span>
<a name="line-13"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Support</span><span class='hs-varop'>.</span><span class='hs-conid'>CanType</span>
<a name="line-14"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Support</span><span class='hs-varop'>.</span><span class='hs-conid'>FreeVars</span>
<a name="line-15"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span><span class='hs-varop'>.</span><span class='hs-conid'>GMap</span>
<a name="line-16"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span><span class='hs-varop'>.</span><span class='hs-conid'>Graph</span>
<a name="line-17"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span><span class='hs-varop'>.</span><span class='hs-conid'>HasSize</span>
<a name="line-18"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span><span class='hs-varop'>.</span><span class='hs-conid'>SetLike</span>
<a name="line-19"></a>
<a name="line-20"></a><a name="PExp"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>PExp</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>PExp</span> <span class='hs-layout'>{</span>
<a name="line-21"></a>    <span class='hs-varid'>pexpUniq</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span><span class='hs-layout'>,</span>
<a name="line-22"></a>    <span class='hs-varid'>pexpBind</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Val</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<a name="line-23"></a>    <span class='hs-varid'>pexpExp</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Exp</span><span class='hs-layout'>,</span>
<a name="line-24"></a>    <span class='hs-varid'>pexpProvides</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Var</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<a name="line-25"></a>    <span class='hs-varid'>pexpDeps</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Int</span><span class='hs-keyglyph'>]</span>
<a name="line-26"></a>    <span class='hs-layout'>}</span> <span class='hs-keyword'>deriving</span><span class='hs-layout'>(</span><span class='hs-conid'>Show</span><span class='hs-layout'>)</span>
<a name="line-27"></a>
<a name="line-28"></a><a name="instance%20Eq%20PExp"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Eq</span> <span class='hs-conid'>PExp</span> <span class='hs-keyword'>where</span>
<a name="line-29"></a>    <span class='hs-varid'>a</span> <span class='hs-varop'>==</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pexpUniq</span> <span class='hs-varid'>a</span> <span class='hs-varop'>==</span> <span class='hs-varid'>pexpUniq</span> <span class='hs-varid'>b</span>
<a name="line-30"></a>
<a name="line-31"></a><a name="makeDeps"></a><span class='hs-definition'>makeDeps</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>PExp</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PExp</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PExp</span>
<a name="line-32"></a><span class='hs-definition'>makeDeps</span> <span class='hs-varid'>cs</span> <span class='hs-varid'>pexp</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pexp</span> <span class='hs-layout'>{</span> <span class='hs-varid'>pexpProvides</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>freeVars</span> <span class='hs-layout'>(</span><span class='hs-varid'>pexpBind</span> <span class='hs-varid'>pexp</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>pexpDeps</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>deps</span> <span class='hs-layout'>}</span> <span class='hs-keyword'>where</span>
<a name="line-33"></a>    <span class='hs-varid'>deps</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>pexpUniq</span> <span class='hs-varid'>c</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>c</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cs</span><span class='hs-layout'>,</span> <span class='hs-varid'>not</span> <span class='hs-varop'>$</span> <span class='hs-varid'>null</span> <span class='hs-varop'>$</span> <span class='hs-varid'>fvs</span> <span class='hs-varop'>`intersect`</span> <span class='hs-varid'>pexpProvides</span> <span class='hs-varid'>c</span> <span class='hs-keyglyph'>]</span>
<a name="line-34"></a>    <span class='hs-varid'>fvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>freeVars</span> <span class='hs-layout'>(</span><span class='hs-varid'>pexpExp</span> <span class='hs-varid'>pexp</span><span class='hs-layout'>)</span>
<a name="line-35"></a>
<a name="line-36"></a><a name="justDeps"></a><span class='hs-definition'>justDeps</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>PExp</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Var</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Int</span><span class='hs-keyglyph'>]</span>
<a name="line-37"></a><span class='hs-definition'>justDeps</span> <span class='hs-varid'>cs</span> <span class='hs-varid'>fs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>deps</span> <span class='hs-keyword'>where</span>
<a name="line-38"></a>    <span class='hs-varid'>deps</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>pexpUniq</span> <span class='hs-varid'>c</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>c</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cs</span><span class='hs-layout'>,</span> <span class='hs-varid'>not</span> <span class='hs-varop'>$</span> <span class='hs-varid'>null</span> <span class='hs-varop'>$</span> <span class='hs-varid'>fs</span> <span class='hs-varop'>`intersect`</span> <span class='hs-varid'>pexpProvides</span> <span class='hs-varid'>c</span> <span class='hs-keyglyph'>]</span>
<a name="line-39"></a>
<a name="line-40"></a><span class='hs-comment'>-- | grinPush pushes the definitions of variables as far inward as they can go so</span>
<a name="line-41"></a><span class='hs-comment'>-- peephole optimizations have a better chance of firing. when the order of definitons</span>
<a name="line-42"></a><span class='hs-comment'>-- doesn't matter, it uses heuristics to decide which one to push to allow the most</span>
<a name="line-43"></a><span class='hs-comment'>-- peephole optimizations.</span>
<a name="line-44"></a>
<a name="line-45"></a><a name="grinPush"></a><span class='hs-definition'>grinPush</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Stats</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Lam</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>Lam</span>
<a name="line-46"></a><span class='hs-definition'>grinPush</span> <span class='hs-varid'>stats</span> <span class='hs-layout'>(</span><span class='hs-varid'>l</span> <span class='hs-conop'>:-&gt;</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ans</span> <span class='hs-keyword'>where</span>
<a name="line-47"></a>    <span class='hs-varid'>ans</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-48"></a><span class='hs-comment'>--        putStrLn "@@@ grinPush"</span>
<a name="line-49"></a>        <span class='hs-varid'>e'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>evalStateT</span> <span class='hs-layout'>(</span><span class='hs-varid'>f</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-num'>1</span><span class='hs-layout'>,</span><span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-50"></a>        <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>l</span> <span class='hs-conop'>:-&gt;</span> <span class='hs-varid'>e'</span><span class='hs-layout'>)</span>
<a name="line-51"></a>    <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-varid'>exp</span> <span class='hs-conop'>:&gt;&gt;=</span> <span class='hs-varid'>v</span> <span class='hs-conop'>:-&gt;</span> <span class='hs-varid'>e2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isOmittable</span> <span class='hs-varid'>exp</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-52"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>nn</span><span class='hs-layout'>,</span><span class='hs-varid'>cv</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>get</span>
<a name="line-53"></a>        <span class='hs-keyword'>let</span> <span class='hs-varid'>npexp</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>makeDeps</span> <span class='hs-varid'>cv</span> <span class='hs-conid'>PExp</span> <span class='hs-layout'>{</span> <span class='hs-varid'>pexpUniq</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nn</span><span class='hs-layout'>,</span> <span class='hs-varid'>pexpBind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>v</span><span class='hs-layout'>,</span> <span class='hs-varid'>pexpExp</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>exp</span><span class='hs-layout'>,</span> <span class='hs-varid'>pexpDeps</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>undefined</span><span class='hs-layout'>,</span> <span class='hs-varid'>pexpProvides</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>undefined</span> <span class='hs-layout'>}</span>
<a name="line-54"></a>        <span class='hs-varid'>put</span> <span class='hs-layout'>(</span><span class='hs-varid'>nn</span><span class='hs-varop'>+</span><span class='hs-num'>1</span><span class='hs-layout'>,</span><span class='hs-varid'>npexp</span><span class='hs-conop'>:</span><span class='hs-varid'>cv</span><span class='hs-layout'>)</span>
<a name="line-55"></a>        <span class='hs-varid'>f</span> <span class='hs-varid'>e2</span>
<a name="line-56"></a>    <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-varid'>exp</span> <span class='hs-conop'>:&gt;&gt;=</span> <span class='hs-varid'>v</span> <span class='hs-conop'>:-&gt;</span> <span class='hs-varid'>e2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-57"></a>        <span class='hs-varid'>exp</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>fixupLet</span> <span class='hs-varid'>exp</span>
<a name="line-58"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>v'</span><span class='hs-layout'>,</span><span class='hs-varid'>exp'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>dropAny</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp</span>
<a name="line-59"></a>        <span class='hs-varid'>e2'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>f</span> <span class='hs-varid'>e2</span>
<a name="line-60"></a>        <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>exp'</span> <span class='hs-conop'>:&gt;&gt;=</span> <span class='hs-varid'>v'</span> <span class='hs-conop'>:-&gt;</span> <span class='hs-varid'>e2'</span>
<a name="line-61"></a>    <span class='hs-varid'>f</span> <span class='hs-varid'>exp</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-62"></a>        <span class='hs-varid'>exp</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>fixupLet</span> <span class='hs-varid'>exp</span>
<a name="line-63"></a>        <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-varid'>exp'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>dropAny</span> <span class='hs-conid'>Nothing</span> <span class='hs-varid'>exp</span>
<a name="line-64"></a>        <span class='hs-varid'>return</span> <span class='hs-varid'>exp'</span>
<a name="line-65"></a>
<a name="line-66"></a>    <span class='hs-varid'>fixupLet</span> <span class='hs-varid'>lt</span><span class='hs-keyglyph'>@</span><span class='hs-conid'>Let</span> <span class='hs-layout'>{</span> <span class='hs-varid'>expDefs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>defs</span><span class='hs-layout'>,</span> <span class='hs-varid'>expBody</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>b</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-67"></a>        <span class='hs-keyword'>let</span> <span class='hs-varid'>def</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromList</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-varid'>funcDefName</span> <span class='hs-varid'>defs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GSet</span> <span class='hs-conid'>Atom</span><span class='hs-layout'>)</span>
<a name="line-68"></a>            <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-varid'>e</span> <span class='hs-conop'>:&gt;&gt;=</span> <span class='hs-varid'>l</span> <span class='hs-conop'>:-&gt;</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isEmpty</span> <span class='hs-layout'>(</span><span class='hs-varid'>freeVars</span> <span class='hs-varid'>e</span> <span class='hs-varop'>`intersection`</span> <span class='hs-varid'>def</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-69"></a>                <span class='hs-varid'>exp</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>f</span> <span class='hs-varid'>r</span>
<a name="line-70"></a>                <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>e</span> <span class='hs-conop'>:&gt;&gt;=</span> <span class='hs-varid'>l</span> <span class='hs-conop'>:-&gt;</span> <span class='hs-varid'>exp</span><span class='hs-layout'>)</span>
<a name="line-71"></a>            <span class='hs-varid'>f</span> <span class='hs-varid'>r</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>updateLetProps</span> <span class='hs-varid'>lt</span> <span class='hs-layout'>{</span>  <span class='hs-varid'>expBody</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>r</span> <span class='hs-layout'>}</span>
<a name="line-72"></a>        <span class='hs-varid'>f</span> <span class='hs-varid'>b</span>
<a name="line-73"></a>    <span class='hs-varid'>fixupLet</span> <span class='hs-varid'>exp</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>exp</span>
<a name="line-74"></a>    <span class='hs-varid'>dropAny</span> <span class='hs-varid'>mv</span> <span class='hs-layout'>(</span><span class='hs-varid'>exp</span><span class='hs-keyglyph'>::</span><span class='hs-conid'>Exp</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-75"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>nn</span><span class='hs-layout'>,</span><span class='hs-varid'>xs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>get</span>
<a name="line-76"></a>        <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>reachable'</span><span class='hs-layout'>,</span><span class='hs-sel'>_graph</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>newGraphReachable</span> <span class='hs-varid'>xs</span> <span class='hs-varid'>pexpUniq</span> <span class='hs-varid'>pexpDeps</span>
<a name="line-77"></a>            <span class='hs-varid'>deps</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>justDeps</span> <span class='hs-varid'>xs</span> <span class='hs-layout'>(</span><span class='hs-varid'>freeVars</span> <span class='hs-varid'>exp</span><span class='hs-layout'>)</span>
<a name="line-78"></a>            <span class='hs-varid'>reached</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reachable'</span> <span class='hs-varid'>deps</span>
<a name="line-79"></a>            <span class='hs-comment'>--dropped = case prefered reached exp of</span>
<a name="line-80"></a>            <span class='hs-comment'>--    Just (x:_) | [] &lt;- [ r | r &lt;- reached, pexpUniq x `elem` pexpDeps r ] -&gt; (reverse $ topSort $ newGraph (filter (/= x) reached) pexpUniq pexpDeps) ++ [x]</span>
<a name="line-81"></a>            <span class='hs-comment'>--    _ -&gt; reverse $ topSort $ newGraph reached pexpUniq pexpDeps</span>
<a name="line-82"></a>            <span class='hs-varid'>dropped</span> <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>reverse</span> <span class='hs-varop'>$</span> <span class='hs-varid'>topSort</span> <span class='hs-varop'>$</span> <span class='hs-varid'>newGraph</span> <span class='hs-varid'>reached</span> <span class='hs-varid'>pexpUniq</span> <span class='hs-varid'>pexpDeps</span>
<a name="line-83"></a>            <span class='hs-varid'>ff</span> <span class='hs-varid'>pexp</span> <span class='hs-varid'>exp</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pexpExp</span> <span class='hs-varid'>pexp</span> <span class='hs-conop'>:&gt;&gt;=</span> <span class='hs-varid'>pexpBind</span> <span class='hs-varid'>pexp</span> <span class='hs-conop'>:-&gt;</span> <span class='hs-varid'>exp</span>
<a name="line-84"></a>            <span class='hs-varid'>ebinds</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-conid'>Var</span> <span class='hs-varid'>v</span> <span class='hs-varid'>t</span> <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>v</span><span class='hs-layout'>,</span><span class='hs-varid'>t</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>Set</span><span class='hs-varop'>.</span><span class='hs-varid'>toList</span> <span class='hs-varop'>$</span> <span class='hs-varid'>freeVars</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>pexpBind</span> <span class='hs-varid'>dropped</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-85"></a>            <span class='hs-layout'>(</span><span class='hs-varid'>exp'</span><span class='hs-layout'>,</span><span class='hs-varid'>mv'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>vv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mv</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>mv'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vv</span> <span class='hs-varop'>++</span> <span class='hs-varid'>ebinds</span> <span class='hs-keyword'>in</span> <span class='hs-layout'>(</span><span class='hs-varid'>exp</span> <span class='hs-conop'>:&gt;&gt;=</span> <span class='hs-varid'>vv</span> <span class='hs-conop'>:-&gt;</span> <span class='hs-conid'>Return</span> <span class='hs-varid'>mv'</span><span class='hs-layout'>,</span><span class='hs-varid'>mv'</span><span class='hs-layout'>)</span>
<a name="line-86"></a>                       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>exp</span><span class='hs-layout'>,</span><span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-87"></a>        <span class='hs-varid'>put</span> <span class='hs-layout'>(</span><span class='hs-varid'>nn</span><span class='hs-layout'>,</span><span class='hs-keyglyph'>[</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xs</span><span class='hs-layout'>,</span> <span class='hs-varid'>pexpUniq</span> <span class='hs-varid'>x</span> <span class='hs-varop'>`notElem`</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>pexpUniq</span> <span class='hs-varid'>reached</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-88"></a><span class='hs-comment'>--        when (not $ null dropped) $ lift $ do</span>
<a name="line-89"></a><span class='hs-comment'>--            putStrLn "@@@ dropped"</span>
<a name="line-90"></a><span class='hs-comment'>--            mapM_ Prelude.print dropped</span>
<a name="line-91"></a>        <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mv'</span><span class='hs-layout'>,</span><span class='hs-varid'>foldr</span> <span class='hs-varid'>ff</span> <span class='hs-varid'>exp'</span> <span class='hs-varid'>dropped</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Exp</span><span class='hs-layout'>)</span>
<a name="line-92"></a>    <span class='hs-comment'>-- | preferentially pull definitons of the variable this returns right next to it as it admits a peephole optimization</span>
<a name="line-93"></a><span class='hs-comment'>--    prefer (Store v@Var {}) = return v</span>
<a name="line-94"></a><span class='hs-comment'>--    prefer (App fn [v@Var {}] _)  | fn == funcEval = return v</span>
<a name="line-95"></a><span class='hs-comment'>--    prefer (App fn [v@Var {},_] _)| fn == funcApply = return v</span>
<a name="line-96"></a><span class='hs-comment'>--    prefer (App fn [v@Var {}] _)  | fn == funcApply = return v</span>
<a name="line-97"></a><span class='hs-comment'>--    prefer (Update _ v@Var {}) = return v</span>
<a name="line-98"></a><span class='hs-comment'>--    prefer (Update v@Var {} _) = return v</span>
<a name="line-99"></a><span class='hs-comment'>--    prefer _ = fail "no preference"</span>
<a name="line-100"></a><span class='hs-comment'>--    _prefered pexps exp = do</span>
<a name="line-101"></a><span class='hs-comment'>--        v &lt;- prefer exp</span>
<a name="line-102"></a><span class='hs-comment'>--        return [ p | p &lt;- pexps, v == pexpBind p]</span>
<a name="line-103"></a>
<a name="line-104"></a><span class='hs-comment'>--grinPush :: Stats -&gt; Lam -&gt; IO Lam</span>
<a name="line-105"></a><span class='hs-comment'>--grinPush stats lam = ans where</span>
<a name="line-106"></a><span class='hs-comment'>--    ans = do</span>
<a name="line-107"></a><span class='hs-comment'>--        putStrLn "@@@ grinPush"</span>
<a name="line-108"></a><span class='hs-comment'>--        (ans,_) &lt;- evalStateT (whiz subBlock doexp finalExp whizState lam) (1,[])</span>
<a name="line-109"></a><span class='hs-comment'>--        return ans</span>
<a name="line-110"></a><span class='hs-comment'>--    subBlock _ action = do</span>
<a name="line-111"></a><span class='hs-comment'>--        (nn,x) &lt;- get</span>
<a name="line-112"></a><span class='hs-comment'>--        put (nn,mempty)</span>
<a name="line-113"></a><span class='hs-comment'>--        r &lt;- action</span>
<a name="line-114"></a><span class='hs-comment'>--        (nn,_) &lt;- get</span>
<a name="line-115"></a><span class='hs-comment'>--        put (nn,x)</span>
<a name="line-116"></a><span class='hs-comment'>--        return r</span>
<a name="line-117"></a><span class='hs-comment'>--    doexp (v, exp) | isOmittable exp = do</span>
<a name="line-118"></a><span class='hs-comment'>--        (nn,cv) &lt;- get</span>
<a name="line-119"></a><span class='hs-comment'>--        let npexp = makeDeps cv PExp { pexpUniq = nn, pexpBind = v, pexpExp = exp, pexpDeps = undefined, pexpProvides = undefined }</span>
<a name="line-120"></a><span class='hs-comment'>--        put (nn+1,npexp:cv)</span>
<a name="line-121"></a><span class='hs-comment'>--        return Nothing</span>
<a name="line-122"></a><span class='hs-comment'>--    doexp (v, exp) = do</span>
<a name="line-123"></a><span class='hs-comment'>--        exp &lt;- fixupLet exp</span>
<a name="line-124"></a><span class='hs-comment'>--        (v',exp') &lt;- dropAny (Just v) exp</span>
<a name="line-125"></a><span class='hs-comment'>--        return $ Just (v',exp')</span>
<a name="line-126"></a><span class='hs-comment'>--    finalExp (exp::Exp) = do</span>
<a name="line-127"></a><span class='hs-comment'>--        exp &lt;- fixupLet exp</span>
<a name="line-128"></a><span class='hs-comment'>--        (_,exp') &lt;- dropAny Nothing exp</span>
<a name="line-129"></a><span class='hs-comment'>--        return (exp'::Exp)</span>
<a name="line-130"></a><span class='hs-comment'>--    fixupLet lt@Let { expDefs = defs, expBody = b } = do</span>
<a name="line-131"></a><span class='hs-comment'>--        let def = (Set.fromList $ map funcDefName defs)</span>
<a name="line-132"></a><span class='hs-comment'>--            f (e :&gt;&gt;= l :-&gt; r) | Set.null (freeVars e `Set.intersection` def) = do</span>
<a name="line-133"></a><span class='hs-comment'>--                exp &lt;- f r</span>
<a name="line-134"></a><span class='hs-comment'>--                return (e :&gt;&gt;= l :-&gt; exp)</span>
<a name="line-135"></a><span class='hs-comment'>--            f r = return $ updateLetProps lt {  expBody = r }</span>
<a name="line-136"></a><span class='hs-comment'>--        f b</span>
<a name="line-137"></a><span class='hs-comment'>--    fixupLet exp = return exp</span>
<a name="line-138"></a><span class='hs-comment'>--    dropAny mv (exp::Exp) = do</span>
<a name="line-139"></a><span class='hs-comment'>--        (nn,xs) &lt;- get</span>
<a name="line-140"></a><span class='hs-comment'>--        let graph = newGraph xs pexpUniq pexpDeps</span>
<a name="line-141"></a><span class='hs-comment'>--            deps = justDeps xs (freeVars exp)</span>
<a name="line-142"></a><span class='hs-comment'>--            reached = reachable graph deps</span>
<a name="line-143"></a><span class='hs-comment'>--            --dropped = case prefered reached exp of</span>
<a name="line-144"></a><span class='hs-comment'>--            --    Just (x:_) | [] &lt;- [ r | r &lt;- reached, pexpUniq x `elem` pexpDeps r ] -&gt; (reverse $ topSort $ newGraph (filter (/= x) reached) pexpUniq pexpDeps) ++ [x]</span>
<a name="line-145"></a><span class='hs-comment'>--            --    _ -&gt; reverse $ topSort $ newGraph reached pexpUniq pexpDeps</span>
<a name="line-146"></a><span class='hs-comment'>--            dropped =  reverse $ topSort $ newGraph reached pexpUniq pexpDeps</span>
<a name="line-147"></a><span class='hs-comment'>--            ff pexp exp = pexpExp pexp :&gt;&gt;= pexpBind pexp :-&gt; exp</span>
<a name="line-148"></a><span class='hs-comment'>--            ebinds = [ Var v t | (v,t) &lt;- Set.toList $ freeVars (map pexpBind dropped) ]</span>
<a name="line-149"></a><span class='hs-comment'>--            (exp',mv') | Just vv &lt;- mv = let mv' = tuple $ fromTuple vv ++ ebinds in (exp :&gt;&gt;= vv :-&gt; Return mv',mv')</span>
<a name="line-150"></a><span class='hs-comment'>--                       | otherwise = (exp,unit)</span>
<a name="line-151"></a><span class='hs-comment'>--        put (nn,[ x | x &lt;- xs, pexpUniq x `notElem` (map pexpUniq reached) ])</span>
<a name="line-152"></a><span class='hs-comment'>--        when (not $ null dropped) $ lift $ do</span>
<a name="line-153"></a><span class='hs-comment'>--            putStrLn "@@@ dropped"</span>
<a name="line-154"></a><span class='hs-comment'>--            mapM_ Prelude.print dropped</span>
<a name="line-155"></a><span class='hs-comment'>--        return (mv',foldr ff exp' dropped :: Exp)</span>
<a name="line-156"></a><span class='hs-comment'>--    -- | preferentially pull definitons of the variable this returns right next to it as it admits a peephole optimization</span>
<a name="line-157"></a><span class='hs-comment'>--    prefer (Store v@Var {}) = return v</span>
<a name="line-158"></a><span class='hs-comment'>--    prefer (App fn [v@Var {}] _)  | fn == funcEval = return v</span>
<a name="line-159"></a><span class='hs-comment'>--    prefer (App fn [v@Var {},_] _)| fn == funcApply = return v</span>
<a name="line-160"></a><span class='hs-comment'>--    prefer (App fn [v@Var {}] _)  | fn == funcApply = return v</span>
<a name="line-161"></a><span class='hs-comment'>--    prefer (Update _ v@Var {}) = return v</span>
<a name="line-162"></a><span class='hs-comment'>--    prefer (Update v@Var {} _) = return v</span>
<a name="line-163"></a><span class='hs-comment'>--    prefer _ = fail "no preference"</span>
<a name="line-164"></a><span class='hs-comment'>--    prefered pexps exp = do</span>
<a name="line-165"></a><span class='hs-comment'>--        v &lt;- prefer exp</span>
<a name="line-166"></a><span class='hs-comment'>--        return [ p | p &lt;- pexps, v == pexpBind p]</span>
<a name="line-167"></a>
<a name="line-168"></a><a name="grinSpeculate"></a><span class='hs-definition'>grinSpeculate</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Grin</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>Grin</span>
<a name="line-169"></a><span class='hs-definition'>grinSpeculate</span> <span class='hs-varid'>grin</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-170"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>ss</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>findSpeculatable</span> <span class='hs-varid'>grin</span>
<a name="line-171"></a>    <span class='hs-varid'>when</span> <span class='hs-varid'>verbose</span> <span class='hs-varop'>$</span> <span class='hs-varid'>putStrLn</span> <span class='hs-str'>"Speculatable:"</span>
<a name="line-172"></a>    <span class='hs-varid'>when</span> <span class='hs-varid'>verbose</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mapM_</span> <span class='hs-conid'>Prelude</span><span class='hs-varop'>.</span><span class='hs-varid'>print</span> <span class='hs-varid'>ss</span>
<a name="line-173"></a>    <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>grin'</span><span class='hs-layout'>,</span><span class='hs-varid'>stats</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runStatM</span> <span class='hs-layout'>(</span><span class='hs-varid'>performSpeculate</span> <span class='hs-varid'>ss</span> <span class='hs-varid'>grin</span><span class='hs-layout'>)</span>
<a name="line-174"></a>    <span class='hs-varid'>when</span> <span class='hs-varid'>verbose</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Stats</span><span class='hs-varop'>.</span><span class='hs-varid'>printStat</span> <span class='hs-str'>"Speculate"</span> <span class='hs-varid'>stats</span>
<a name="line-175"></a>    <span class='hs-varid'>return</span> <span class='hs-varid'>grin'</span>
<a name="line-176"></a>
<a name="line-177"></a><a name="performSpeculate"></a><span class='hs-definition'>performSpeculate</span> <span class='hs-varid'>specs</span> <span class='hs-varid'>grin</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-178"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>sset</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fromList</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>tagFlipFunction</span> <span class='hs-varid'>specs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GSet</span> <span class='hs-conid'>Tag</span>
<a name="line-179"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span><span class='hs-varid'>l</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapBodyM</span> <span class='hs-varid'>h</span> <span class='hs-varid'>l</span>  <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>l'</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span><span class='hs-varid'>l'</span><span class='hs-layout'>)</span>
<a name="line-180"></a>        <span class='hs-varid'>h</span> <span class='hs-layout'>(</span><span class='hs-conid'>BaseOp</span> <span class='hs-layout'>(</span><span class='hs-conid'>StoreNode</span> <span class='hs-conid'>False</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>NodeC</span> <span class='hs-varid'>t</span> <span class='hs-varid'>xs</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>t</span> <span class='hs-varop'>`member`</span> <span class='hs-varid'>sset</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-181"></a>            <span class='hs-keyword'>let</span> <span class='hs-varid'>t'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tagFlipFunction</span> <span class='hs-varid'>t</span>
<a name="line-182"></a>            <span class='hs-varid'>mtick</span> <span class='hs-varop'>$</span> <span class='hs-str'>"Optimize.speculate.store.{"</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>t'</span>
<a name="line-183"></a>            <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>App</span> <span class='hs-varid'>t'</span> <span class='hs-varid'>xs</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyNode</span><span class='hs-keyglyph'>]</span> <span class='hs-conop'>:&gt;&gt;=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>n1</span><span class='hs-keyglyph'>]</span> <span class='hs-conop'>:-&gt;</span> <span class='hs-varid'>demote</span> <span class='hs-varid'>n1</span><span class='hs-layout'>)</span>
<a name="line-184"></a>        <span class='hs-varid'>h</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapExpExp</span> <span class='hs-varid'>h</span> <span class='hs-varid'>e</span>
<a name="line-185"></a>    <span class='hs-varid'>fs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-varid'>grinFuncs</span> <span class='hs-varid'>grin</span><span class='hs-layout'>)</span>
<a name="line-186"></a>    <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>setGrinFunctions</span> <span class='hs-varid'>fs</span> <span class='hs-varid'>grin</span>
<a name="line-187"></a>
<a name="line-188"></a><a name="findSpeculatable"></a><span class='hs-definition'>findSpeculatable</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Grin</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Atom</span><span class='hs-keyglyph'>]</span>
<a name="line-189"></a><span class='hs-definition'>findSpeculatable</span> <span class='hs-varid'>grin</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ans</span> <span class='hs-keyword'>where</span>
<a name="line-190"></a>    <span class='hs-varid'>ans</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Left</span> <span class='hs-layout'>(</span><span class='hs-varid'>x</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>scc</span> <span class='hs-varid'>graph</span> <span class='hs-keyglyph'>]</span>
<a name="line-191"></a>    <span class='hs-varid'>graph</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>newGraph</span> <span class='hs-keyglyph'>[</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span><span class='hs-varid'>concatMap</span> <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-varid'>freeVars</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span> <span class='hs-conop'>:-&gt;</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>grinFuncs</span> <span class='hs-varid'>grin</span><span class='hs-layout'>,</span> <span class='hs-varid'>isSpeculatable</span> <span class='hs-varid'>l</span><span class='hs-layout'>,</span> <span class='hs-varid'>getType</span> <span class='hs-varid'>l</span> <span class='hs-varop'>==</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyNode</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>]</span> <span class='hs-varid'>fst</span> <span class='hs-varid'>snd</span>
<a name="line-192"></a>    <span class='hs-varid'>f</span> <span class='hs-varid'>t</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tagIsSuspFunction</span> <span class='hs-varid'>t</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>tagFlipFunction</span> <span class='hs-varid'>t</span><span class='hs-keyglyph'>]</span>
<a name="line-193"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tagIsFunction</span> <span class='hs-varid'>t</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>t</span><span class='hs-keyglyph'>]</span>
<a name="line-194"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-195"></a>    <span class='hs-varid'>isSpeculatable</span> <span class='hs-conid'>Return</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-196"></a>    <span class='hs-varid'>isSpeculatable</span> <span class='hs-layout'>(</span><span class='hs-conid'>BaseOp</span> <span class='hs-layout'>(</span><span class='hs-conid'>StoreNode</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-197"></a>    <span class='hs-varid'>isSpeculatable</span> <span class='hs-layout'>(</span><span class='hs-conid'>BaseOp</span> <span class='hs-conid'>Promote</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-198"></a>    <span class='hs-varid'>isSpeculatable</span> <span class='hs-layout'>(</span><span class='hs-conid'>BaseOp</span> <span class='hs-conid'>Demote</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-199"></a>    <span class='hs-varid'>isSpeculatable</span> <span class='hs-layout'>(</span><span class='hs-varid'>x</span> <span class='hs-conop'>:&gt;&gt;=</span> <span class='hs-keyword'>_</span> <span class='hs-conop'>:-&gt;</span> <span class='hs-varid'>y</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isSpeculatable</span> <span class='hs-varid'>x</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isSpeculatable</span> <span class='hs-varid'>y</span>
<a name="line-200"></a>    <span class='hs-varid'>isSpeculatable</span> <span class='hs-layout'>(</span><span class='hs-conid'>Case</span> <span class='hs-varid'>e</span> <span class='hs-keyword'>as</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>all</span> <span class='hs-varid'>isSpeculatable</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>|</span> <span class='hs-keyword'>_</span> <span class='hs-conop'>:-&gt;</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>as</span><span class='hs-keyglyph'>]</span>
<a name="line-201"></a>    <span class='hs-varid'>isSpeculatable</span> <span class='hs-conid'>Prim</span> <span class='hs-layout'>{</span> <span class='hs-varid'>expPrimitive</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>p</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>primIsConstant</span> <span class='hs-varid'>p</span>
<a name="line-202"></a>    <span class='hs-varid'>isSpeculatable</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-203"></a>
<a name="line-204"></a><a name="demote"></a><span class='hs-definition'>demote</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>BaseOp</span> <span class='hs-conid'>Demote</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>x</span><span class='hs-keyglyph'>]</span>
</pre></body>
</html>
